<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>mbedtls加密组件分析 | 灵溪驿站</title>

  
    
<link rel="stylesheet" href="/js/aos/aos.css">

  

  <link rel="icon" type="image/png" href="/medias/logo.png">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  
    <script>
        var themeModelId = '1';
        if (themeModelId) {
            localStorage.setItem('modelId', themeModelId);
        }
    </script>
    
    <script src="/js/live2d/autoload.js"></script>
    <script>
        var live2dOpen = eval('true') || false;
        if (!live2dOpen) {
            localStorage.setItem('waifu-display', 1609323474481);
        }
    </script>
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
    
<link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="/js/shareJs/share.min.css">

  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="灵溪驿站" type="application/atom+xml">
</head>

  
  <!-- 依赖于jquery和vue -->
  <script src="/js/jquery3.5.1.js"></script>
  <script src="/js/vue2.6.11.js"></script>
  
  <body>
    <!-- 预加载动画 -->
    <!-- 页面预加载动画 -->

    
    <!-- 判断是否为暗黑风格 -->
    <!-- 判断是否为黑夜模式 -->
<script>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- 头部导航等 -->
    
<header class="header " id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <i class="fa fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo" src="/medias/logo.png" alt="logo">
      <h3 class="drawer-box-head_title">灵溪驿站</h3>
      <h5 class="drawer-box-head_desc">千磨万击还坚劲，任尔东西南北风</h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fa fa-home" aria-hidden="true"></i>
                  
                  <span class="name">首页</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fa fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">归档</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fa fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/categories" class="drawer-menu-item-link">
                  
                    <i class="fa fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">分类</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/about" class="drawer-menu-item-link">
                  
                    <i class="fa fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/friends" class="drawer-menu-item-link">
                  
                  <span class="name">友情链接</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="javascript:;" class="drawer-menu-item-link has-children" @click="openOrCloseMenu(6)">
                  <span>
                    
                      <i class="fa fa-link"></i>
                    
                    <span class="name">更多</span>
                  </span>
                  <i class="fa fa-chevron-left arrow " :class="{'icon-rotate': isOpen(6)}" aria-hidden="true"></i>
                </a>
                <ul class="drawer-sub-menu" v-if="isOpen(6)">
                  
                  <li>
                    <a href="/books">
                      
                      <i class="fa fa-book" style="margin-top: -20px;"></i>
                      
                      <span>图书馆</span>
                    </a>
                  </li>
                  
                  <li>
                    <a target="_blank" rel="noopener" href="https://github.com/flyghost/">
                      
                      <i class="fa fa-git" style="margin-top: -20px;"></i>
                      
                      <span>代码仓</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
        <li class="drawer-box-content_item">
          <a target="_blank" rel="noopener" href="https://github.com/flyghost/">
            <i class="fa fa-github" aria-hidden="true"></i>
            <span>Github</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="/medias/logo.png" alt="logo">
        </div>
      
      <a href="/" class="logo">灵溪驿站</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link">
                  
                    <i class="fa fa-home" aria-hidden="true"></i>
                  
                  <span class="name">首页</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link">
                  
                    <i class="fa fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">归档</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link">
                  
                    <i class="fa fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/categories" class="menu-item-link">
                  
                    <i class="fa fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">分类</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/about" class="menu-item-link">
                  
                    <i class="fa fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/friends" class="menu-item-link">
                  
                  <span class="name">友情链接</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="javascript:;" class="menu-item-link">
                  
                    <i class="fa fa-link"></i>
                  
                  <span class="name">更多</span>
                  <i class="fa fa-chevron-down arrow" aria-hidden="true"></i>
                </a>
                <ul class="sub-menu">
                  
                  <li>
                    <a href="/books">
                      
                      <i class="fa fa-book" style="margin-top: -20px;"></i>
                      
                      <span>图书馆</span>
                    </a>
                  </li>
                  
                  <li>
                    <a target="_blank" rel="noopener" href="https://github.com/flyghost/">
                      
                      <i class="fa fa-git" style="margin-top: -20px;"></i>
                      
                      <span>代码仓</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fa fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <!-- <div class="close" style="overflow: hidden;">
          <i class="fa fa-close" aria-hidden="true" style="float:right;" @click.self="cancelDialogVisible()"></i>
        </div> -->
        <h2>
          <span>
            <i class="fa fa-search" aria-hidden="true"></i>
            <span class="title">本地搜索</span>
          </span>
          <i class="fa fa-close close" style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="请输入关键字"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- 解决刷新页面闪烁问题，可以在元素上添加display: none, 或者用vue.extend方法，详情：https://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- 下面是搜索基本写法 -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
  <a target="_blank" rel="noopener" href="https://github.com/flyghost/" class="github-corner color-primary" aria-label="View source on GitHub"><svg width="60" height="60" viewBox="0 0 250 250" style="fill:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  
    <div id="he-plugin-simple"></div>
    <script>
      WIDGET = {
        CONFIG: {
          "modules": "012",
          "background": 5,
          "tmpColor": "4A4A4A",
          "tmpSize": 16,
          "cityColor": "4A4A4A",
          "citySize": 16,
          "aqiSize": 16,
          "weatherIconSize": 24,
          "alertIconSize": 18,
          "padding": "10px 10px 10px 10px",
          "shadow": "1",
          "language": "auto",
          "borderRadius": 5,
          "fixed": "false",
          "vertical": "middle",
          "horizontal": "center",
          "key": "2784dd3fcb1e4f0f9a9b579bf69641f2"
        }
      }
    </script>
    <script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script> 
    

    <!-- 当头部导航设置为背景透明的时候  -->
    
      <script src="/js/header/index.js"></script>
    
</header>

    <!-- 内容区域 -->
    <main class="main" style="margin-top: 0;">
      
 <!-- prismjs 代码高亮 -->
 


<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>

<!-- 文章详情页顶部图片和标题 -->




<div class="post-detail-header lazyload" id="thumbnail_canvas" data-original="/medias/11.jpg" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="title-box">
    <span class="title">
      mbedtls加密组件分析
    </span>
  </div>
  
  
    <script src="/js/bubble/bubble.js"></script>
  
</div>



<div class="row justify-position">
  <div class="main-content">
    <article class="post post-detail">
      
      <div class="post-meta">
        <i class="fa fa-clock-o" aria-hidden="true"></i>
        <span class="post-time">2021-01-05</span>
      </div>
      
      <div class="post-tags-categories">
        
        <div class="tags">
          <i class="iconfont icontag"></i>
          
            <a href="/tags/ESP/" class="">
              ESP
            </a>
          
        </div>
        
        
        <div class="categories">
          <i class="iconfont iconbookmark1"></i>
          
            <a href="/categories/ESP/" class="">
              ESP
            </a>
          
        </div>
        
      </div>
      <div class="post-content">
        <h1 id="一、伪随机数生成器（ctr-drbg）的配置与使用">1 一、伪随机数生成器（ctr_drbg）的配置与使用</h1><h2 id="真随机数和伪随机数">1.1 真随机数和伪随机数</h2><h3 id="区别">1.1.1 区别</h3><p>随机数在安全技术中通常被用于生成随机序列（eg. 秘钥），对于一个随机数的生成而言，是否真正的做到“随机”是最重要的。</p>
<p>真随机数通常来源于硬件随机数生成器，每次生成的随机数都是真正的随机数，但是因为物理因素，<strong>生成的时间较慢</strong>。比如STM32中提供的RNG硬件外设。</p>
<p>伪随机数通常来源于某个生成算法，每次生成的随机数虽然是随机的，但还是遵循生成算法的规则，优点是<strong>生成速度较快</strong>。比如C库中提供的rand函数，在相同的种子下，其生成的随机数序列相同，所以称之为伪随机数。</p>
<p>所以一般情况下，有一种比较巧妙的办法：将两者结合起来，<strong>先使用真随机数生成种子，然后使用伪随机数生成算法</strong>，这样既保证了生成速度，又保证了生成的序列是真正的随机数。</p>
<p>对应到 mbedtls 中，将产生真随机数的模块称为真随机数生成器（TRNG），将    产生伪随机数的模块称为伪随机数发生器（PRNG）（也叫做确定性随机数生成器，DRBG），其中伪随机数所使用的种子称为<strong>熵源（熵池）</strong>。</p>
<h3 id="伪随机数生成算法">1.1.2 伪随机数生成算法</h3><p>NIST SP 800-90A规范中描述了三种产生伪随机数的算法：</p>
<ul>
<li>Hash_DRBG：使用单向散列算法作为伪随机数生成的基础算法；</li>
<li>HMAC_DRBG：使用消息认证码算法作为随机数生成的基础算法；</li>
<li>CRT_DRBG：使用分组密码算法的计数器模式作为随机数生成的基础算法（重点）。</li>
</ul>
<p>CRT_DRBG 可以理解为一个AES加密过程，加密结果为期望随机数序列。</p>
<h2 id="自定义熵源接口">1.2 自定义熵源接口</h2><p>mbedtls中可以通过开启宏定义 <strong>MBEDTLS_ENTROPY_HARDWARE_ALT</strong> 来开启熵源接口，用户可以在熵源接口中实现自己的硬件获取真随机数代码。</p>
<h3 id="开启宏定义">1.2.1 开启宏定义</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义此宏，以使mbed TLS使用您自己的硬件熵收集器实现。</span></span><br><span class="line"><span class="comment">// 函数原型必须为 int mbedtls_hardware_poll( void *data, unsigned char *output, size_t len, size_t *olen );</span></span><br><span class="line"><span class="comment">// 并接受NULL作为第一个参数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br></pre></td></tr></table></figure>
<h3 id="自定义实现mbedtls-hardware-poll函数">1.2.2 自定义实现mbedtls_hardware_poll函数</h3><p>创建一个新文件用于存放我们编写的该函数实现，这里我创建文件<code>entropy_hardware_alt.c</code>。</p>
<p>实现时需要包含头文件<code>entropy_poll.h</code>，其中包含了 mbedtls_hardware_poll() 函数的原型定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_ENTROPY_HARDWARE_ALT)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_hardware_poll</span><span class="params">( <span class="keyword">void</span> *data, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> len, <span class="keyword">size_t</span> *olen )</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这里以stm32为例</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy_poll.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;main.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stm32l4xx_hal.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy_poll.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> RNG_HandleTypeDef hrng;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_hardware_poll</span><span class="params">( <span class="keyword">void</span> *Data, <span class="keyword">unsigned</span> <span class="keyword">char</span> *Output, <span class="keyword">size_t</span> Len, <span class="keyword">size_t</span> *oLen )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> index;</span><br><span class="line">    <span class="keyword">uint32_t</span> randomValue;</span><br><span class="line">		</span><br><span class="line">    <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; Len/<span class="number">4</span>; index++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (HAL_RNG_GenerateRandomNumber(&amp;hrng, &amp;randomValue) == HAL_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            *oLen += <span class="number">4</span>;</span><br><span class="line">            <span class="built_in">memset</span>(&amp;(Output[index * <span class="number">4</span>]), (<span class="keyword">int</span>)randomValue, <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Error_Handler();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/*MBEDTLS_ENTROPY_HARDWARE_ALT*/</span></span></span><br></pre></td></tr></table></figure>
<h2 id="使用mbedtls-CTR-DRBG接口生成随机数">1.3 使用mbedtls CTR_DRBG接口生成随机数</h2><h3 id="宏配置">1.3.1 宏配置</h3><p>使用mbedtls随机数生成功能需要开启以下宏：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong><br>定义此宏，以防止加在默认的熵函数<br>基于mbedtls_timing_hardclock和基于HAVEGE的轮询功能。</td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_FORCE_SHA256</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>将AES表存储在ROM中（节约内存空间）</td>
</tr>
</tbody></table>
<p>根据以上代码，编写针对本实验的配置文件<code>mbedtls_config_ctr_drbg.h</code>：</p>
<p>cmakefile.txt中添加<code>CPPFLAGS += -DMBEDTLS_CONFIG_FILE=&#39;&quot;mbedtls/mbedtls_config_ctr_drbg.h&quot;&#39;</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_CTR_DRBG_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_CTR_DRBG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT						<span class="comment">// 使用自己的硬件熵</span></span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES		// 不定义此宏，系统将调用默认的熵函数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY							<span class="comment">// 不使用系统内置熵源</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C														<span class="comment">// 使用AES算法</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES									<span class="comment">// 将aes表存储在rom中</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C											<span class="comment">// 使能随机数模块</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C												<span class="comment">// 使能熵源模块</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C												<span class="comment">// 使能sha算法</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_CTR_DRBG_H_ */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="API说明">1.3.2 API说明</h3><h4 id="熵相关">1.3.2.1 熵相关</h4><p>① 初始化熵</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_entropy_init</span><span class="params">( mbedtls_entropy_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 释放熵</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_entropy_free</span><span class="params">( mbedtls_entropy_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 错误码说明（用于根据返回值判定错误）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_SOURCE_FAILED                 -0x003C  <span class="comment">/**&lt; Critical entropy source failure. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_MAX_SOURCES                   -0x003E  <span class="comment">/**&lt; No more sources can be added. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_NO_SOURCES_DEFINED            -0x0040  <span class="comment">/**&lt; No sources have been added to poll. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_NO_STRONG_SOURCE              -0x003D  <span class="comment">/**&lt; No strong sources have been added to poll. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ENTROPY_FILE_IO_ERROR                 -0x003F  <span class="comment">/**&lt; Read/write error in file. */</span></span></span><br></pre></td></tr></table></figure>
<h4 id="crt-drbg相关">1.3.2.2 crt_drbg相关</h4><p>① 初始化ctr_drbg随机数种子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ctr_drbg_init</span><span class="params">( mbedtls_ctr_drbg_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 根据熵生成随机数种子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief               This function seeds and sets up the CTR_DRBG</span></span><br><span class="line"><span class="comment"> *                      entropy source for future reseeds.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note Personalization data can be provided in addition to the more generic</span></span><br><span class="line"><span class="comment"> *       entropy source, to make this instantiation as unique as possible.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx           The CTR_DRBG context to seed.</span></span><br><span class="line"><span class="comment"> * \param f_entropy     The entropy callback, taking as arguments the</span></span><br><span class="line"><span class="comment"> *                      \p p_entropy context, the buffer to fill, and the</span></span><br><span class="line"><span class="comment">                        length of the buffer.</span></span><br><span class="line"><span class="comment"> * \param p_entropy     The entropy context.</span></span><br><span class="line"><span class="comment"> * \param custom        Personalization data, that is device-specific</span></span><br><span class="line"><span class="comment">                        identifiers. Can be NULL.</span></span><br><span class="line"><span class="comment"> * \param len           The length of the personalization data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return              \c 0 on success, or</span></span><br><span class="line"><span class="comment"> *                      #MBEDTLS_ERR_CTR_DRBG_ENTROPY_SOURCE_FAILED on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ctr_drbg_seed</span><span class="params">( mbedtls_ctr_drbg_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">int</span> (*f_entropy)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">void</span> *p_entropy,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *custom,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">size_t</span> len )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 根据随机数种子生成随机数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ctr_drbg_random</span><span class="params">( <span class="keyword">void</span> *p_rng, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> output_len )</span></span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最大生成长度是：MBEDTLS_CTR_DRBG_MAX_REQUEST（1024），如果需要修改的话可以在配置文件中定义该宏。</p>
</blockquote>
<p>④ 释放ctr_drbg随机数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void mbedtls_ctr_drbg_free( mbedtls_ctr_drbg_context *ctx );</span><br></pre></td></tr></table></figure>
<p>⑤ 错误码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_CTR_DRBG_ENTROPY_SOURCE_FAILED        -0x0034  <span class="comment">/**&lt; The entropy source failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_CTR_DRBG_REQUEST_TOO_BIG              -0x0036  <span class="comment">/**&lt; The requested random buffer length is too big. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_CTR_DRBG_INPUT_TOO_BIG                -0x0038  <span class="comment">/**&lt; The input (entropy + additional data) is too large. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_CTR_DRBG_FILE_IO_ERROR                -0x003A  <span class="comment">/**&lt; Read or write error in file. */</span></span></span><br></pre></td></tr></table></figure>
<h4 id="编写测试代码">1.3.2.3 编写测试代码</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_CTR_DRBG_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ctr_drbg_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">uint8_t</span> data_buf[<span class="number">10</span>];</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;crbg_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;			<span class="comment">// 熵</span></span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;		<span class="comment">// 随机数种子</span></span><br><span class="line"></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);				<span class="comment">// 初始化熵</span></span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);			<span class="comment">// 初始化随机数种子</span></span><br><span class="line">    </span><br><span class="line">  	<span class="comment">// 根据熵生成随机数种子</span></span><br><span class="line">    <span class="keyword">if</span>( ( ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>( pers ) ) ) != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator... failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator... ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 根据随机数种子生成随机数</span></span><br><span class="line">    <span class="keyword">if</span> ( ( ret = mbedtls_ctr_drbg_random(&amp;ctr_drbg, data_buf, <span class="keyword">sizeof</span>(data_buf) ) ) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot;\n  . generate random data... failed\n  ! mbedtls_ctr_drbg_random returned %d\n&quot;</span>, ret );</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . generate random data... ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">  	<span class="comment">// 打印随机数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;random data:[&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(data_buf); i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, data_buf[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;]\r\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. 释放随机数种子 */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. 释放熵*/</span></span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_CTR_DRBG_C */</span></span></span><br></pre></td></tr></table></figure>


<h1 id="二、单向散列算法的配置与使用-MD5-SHA1-SHA256-SHA512">2 二、单向散列算法的配置与使用(MD5-SHA1-SHA256-SHA512)</h1><h2 id="单向散列算法">2.1 单向散列算法</h2><h3 id="单向散列函数">2.1.1 单向散列函数</h3><p>单向散列函数是一类满足密码学算法安全属性的特殊散列函数，可以根据消息的内容计算出散列值，又称为安全散列函数或者哈希函数，通常用于<strong>检验消息完整性</strong>。<br>输入数据称为<strong>消息</strong>，计算出的散列值称为<strong>消息摘要（摘要）</strong>。<br>单向散列函数具有如下特点：</p>
<ul>
<li>输入长度任意；</li>
<li><strong>输出长度固定</strong>；</li>
<li><strong>单向性</strong>：无法根据散列值还原出消息；<br>单向散列函数主要用在：</li>
<li>消息完整性检测；</li>
<li>构造伪随机数生成算法；</li>
<li>消息认证码；</li>
<li>数字签名；</li>
<li>一次性口令；</li>
</ul>
<h3 id="单向散列算法-1">2.1.2 单向散列算法</h3><p>单向散列算法是单向散列函数的实现，主要包括两大算法实现：MD4/5系列实现、SHA系列实现。</p>
<h4 id="MD系列实现">2.1.2.1 MD系列实现</h4><p>MD系列算法最早是MD4，后来诞生了MD5，两者都可以产生128 bit 的散列值。</p>
<h4 id="SHA系列算法">2.1.2.2 SHA系列算法</h4><p>SHA系列算法由美国国家标准与技术研究所NIST确定，主要包含以下几个：</p>
<ul>
<li>SHA0：1993年发布，可以产生160 bit 的消息摘要，但是存在重大缺陷被撤销；</li>
<li>SHA1：1995年发布，可以产生160 bit 的消息摘要，也存在缺陷（不推荐使用）；</li>
<li>SHA2：包括SHA256算法、SHA384算法、SHA512算法；</li>
<li>SHA3：支持与SHA2相同的消息摘要长度，但是算法内部结构不同；</li>
</ul>
<h3 id="mbedtls中提供的单向散列算法">2.1.3 mbedtls中提供的单向散列算法</h3><ul>
<li>MD2</li>
<li>MD4</li>
<li>MD5</li>
<li>SHA1</li>
<li>SHA224</li>
<li>SHA256</li>
<li>SHA384</li>
<li>SHA512</li>
</ul>
<h2 id="功能模块的使用">2.2 功能模块的使用</h2><h3 id="配置宏">2.2.1 配置宏</h3><p>mbedtls中提供的这些单向散列算法，<strong>每个都是一个独立的模块，由对应的宏控制是否开启</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD2_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD4_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD5_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA1_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA224_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA384_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA512_C</span></span><br></pre></td></tr></table></figure>
<p>在使用的时候，除了可以使用每个功能模块提供的API，还可以使用<strong>md通用接口</strong>，通过下面的宏开启：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br></pre></td></tr></table></figure>
<p>测试SHA1、SHA256、SHA512三个算法，所以编写一个新的配置头文件<code>mbedtls_config_sha_x.h</code>，内容如下：</p>
<p>cmakefile.txt中添加<code>CPPFLAGS += -DMBEDTLS_CONFIG_FILE=&#39;&quot;mbedtls_config_sha_x.h&quot;&#39;</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief   Minimal configuration for SHAX Function</span></span><br><span class="line"><span class="comment"> * @author  mculover666</span></span><br><span class="line"><span class="comment"> * @date    2020/09/22</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_SHA_X_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_SHA_X_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD2_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD4_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD5_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA1_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA224_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA384_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA512_C</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* enable generic message digest wrappers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_SHA_X_H_ */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="md通用接口api说明">2.2.2 md通用接口api说明</h3><p>头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/md.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化MD结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_md_init</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 根据算法类型得到md信息结构体指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *<span class="title">mbedtls_md_info_from_type</span><span class="params">( <span class="keyword">mbedtls_md_type_t</span> md_type )</span></span>;</span><br></pre></td></tr></table></figure>
<p>其中算法类型 mbedtls_md_type_t 是枚举类型，有以下值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    MBEDTLS_MD_NONE=<span class="number">0</span>,    <span class="comment">/**&lt; None. */</span></span><br><span class="line">    MBEDTLS_MD_MD2,       <span class="comment">/**&lt; The MD2 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_MD4,       <span class="comment">/**&lt; The MD4 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_MD5,       <span class="comment">/**&lt; The MD5 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA1,      <span class="comment">/**&lt; The SHA-1 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA224,    <span class="comment">/**&lt; The SHA-224 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA256,    <span class="comment">/**&lt; The SHA-256 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA384,    <span class="comment">/**&lt; The SHA-384 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_SHA512,    <span class="comment">/**&lt; The SHA-512 message digest. */</span></span><br><span class="line">    MBEDTLS_MD_RIPEMD160, <span class="comment">/**&lt; The RIPEMD-160 message digest. */</span></span><br><span class="line">&#125; <span class="keyword">mbedtls_md_type_t</span>;</span><br></pre></td></tr></table></figure>
<p>③ 设置md结构体，完成md结构体内部接口初始化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_setup</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *md_info, <span class="keyword">int</span> hmac )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 获取单向散列算法名称：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">mbedtls_md_get_name</span><span class="params">( <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *md_info )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 获取单向散列算法输出消息摘要的长度：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">mbedtls_md_get_size</span><span class="params">( <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *md_info )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑥ md启动接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_starts</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑦ md更新接口，处理输入数据，计算散列值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_update</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">size_t</span> ilen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑧ md完成接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_finish</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑨ 释放md结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_md_free</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑩ 错误码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_FEATURE_UNAVAILABLE                -0x5080  <span class="comment">/**&lt; The selected feature is not available. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_BAD_INPUT_DATA                     -0x5100  <span class="comment">/**&lt; Bad input parameters to function. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_ALLOC_FAILED                       -0x5180  <span class="comment">/**&lt; Failed to allocate memory. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_FILE_IO_ERROR                      -0x5200  <span class="comment">/**&lt; Opening or reading of file failed. */</span></span></span><br></pre></td></tr></table></figure>
<p><strong>调用过程为：</strong></p>
<ul>
<li>starts：初始化，只需调用一次；</li>
<li>update：计算值，可以多次调用；</li>
<li>finish：获取计算出的消息摘要；</li>
</ul>
<p>新建文件<code>mbedtls_sha_x_test.c</code>，编写如下测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_MD_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/md.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_shax_test</span><span class="params">(<span class="keyword">mbedtls_md_type_t</span> md_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len, i;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *message = <span class="string">&quot;mculover666&quot;</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">32</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">mbedtls_md_context_t</span> ctx;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *info;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;message is:%s\r\n&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init mbedtls_md_context_t structure */</span></span><br><span class="line">    mbedtls_md_init(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. get md info structure pointer */</span></span><br><span class="line">    info = mbedtls_md_info_from_type(md_type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. setup md info structure */</span></span><br><span class="line">    ret = mbedtls_md_setup(&amp;ctx, info, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. start */</span></span><br><span class="line">    ret = mbedtls_md_starts(&amp;ctx);</span><br><span class="line">     <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* 5. update */</span></span><br><span class="line">    ret = mbedtls_md_update(&amp;ctx, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)message, <span class="built_in">strlen</span>(message));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* 6. finish */</span></span><br><span class="line">    ret = mbedtls_md_finish(&amp;ctx, digest);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s digest context is:[&quot;</span>, mbedtls_md_get_name(info));</span><br><span class="line">    len= mbedtls_md_get_size(info);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, digest[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;]\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    <span class="comment">/* 7. free */</span></span><br><span class="line">    mbedtls_md_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_MD_C */</span></span></span><br></pre></td></tr></table></figure>
<h1 id="三、对称加密算法的配置与使用（AES算法）">3 三、对称加密算法的配置与使用（AES算法）</h1><h2 id="AES对称加密算法">3.1 AES对称加密算法</h2><h3 id="什么是对称加密算法">3.1.1 什么是对称加密算法</h3><p>对称算法是一种通信双方使用<strong>相同的秘钥</strong>进行加密和解密的密码算法。</p>
<p>其中这份相同的秘钥称为对称秘钥或者共享秘钥，只有通信双方持有，如果传输的密文被拦截，没有秘钥也无法解密出原文。</p>
<h3 id="对称加密算法的几种模式">3.1.2 对称加密算法的几种模式</h3><h4 id="分组密码模式">3.1.2.1 分组密码模式</h4><p>分组密码只能加密或者加密<strong>固定长度</strong>的数据，如果需要加密的明文长度超过了分组长度，则需要对明文进行分组，然后对各分组进行处理。</p>
<p>① <strong>ECB模式（电子密码本模式）</strong></p>
<p>ECB（Electronic CodeBook）模式将明文进行分组，然后针对每组单独进行加密，处理之后再将每组密文合并在一起，同理，解析也是一样的过程。</p>
<p>这种模式之下明文和密文一一对应，存在明显的缺点，所以实际中禁止使用。</p>
<p>② <strong>CBC模式（密码分组链接模式）</strong></p>
<p>CBC（Cipher Block Chaining）模式中，每组明文在加密前都要先与前面的一组密文进行异或操作，然后使用秘钥计算出密文。</p>
<p>同理，每组密文在解密时先使用秘钥计算出明文，然后与前面的一组密文进行异或运算，还原出最终明文。</p>
<p>在这种方式下，由于第一个明文分组前面没有密文分组，所以需要提前设置一个与分组长度相等的序列来代替密文分组，称之为初始化向量（Intialization Vector）。一般在发送端使用伪随机数生成器生成一个初始化的IV，然后通过某种方式发送给接收端。</p>
<p>所以，<strong>在CBC模式下，要想通信双方能正常加密解密，除了拥有相同的秘钥，还必须要拥有相同的初始化向量</strong>。</p>
<p>③ <strong>CRT模式（计数器模式）</strong></p>
<p>CRT模式中，使用与分组长度的计数值参与运算。通过对逐次累加的计数器值进行加密来生成密钥流，然后秘钥流与明文分组进行异或运算，得到密文分组。</p>
<p>同理，接收端解密的时候：通过对逐次累加的计数器值进行加密来生成密钥流，然后秘钥流与密文分组进行异或运算，得到明文分组。</p>
<p>④ 三种模式对比</p>
<p>相比之下：</p>
<ul>
<li>CTR模式中对于每个分组的加密/解密是独立的，可以进行并行计算，大幅提高计算效率；</li>
<li>CBC模式中密文分组的解密过程依赖于前一个密文分组，而CRT模式中每个密文分组的解密过程是独立的；</li>
<li>CTR模式中仅需要加密算法（对计数值加密）、不需要解密算法，而ECB和CBC模式都需要加密和解密算法；</li>
<li>CTR模式不需要对明文进行填充，而ECB和CBC模式需要；</li>
</ul>
<h4 id="PKCS7填充方案">3.1.2.2 PKCS7填充方案</h4><p>在EBC模式和CBC模式中，要求<strong>输入明文长度不是分组长度的整数倍时，要对明文进行填充</strong>。</p>
<p>常用的填充方案是 PKCS7 方案，规则如下：</p>
<h3 id="AES算法">3.1.3 AES算法</h3><p>AES算法的固定分组大小为128位（16字节），秘钥长度为128、192、256位。</p>
<p>AES算法中的S盒是唯一的非线性实现，解密过程中需要使用S盒完整字节替换，<strong>通常S盒计算通过查表法实现</strong>。</p>
<h3 id="mbedtls中提供的对称加密算法">3.1.4 mbedtls中提供的对称加密算法</h3><p>mbedtls中提供的对称加密算法如下：</p>
<ul>
<li>AES：支持ECB、CBC、CTR、CFB、GCM模式；</li>
<li>ARCFOUR(RC4)</li>
<li>Blowfish</li>
<li>Camellia</li>
<li>DES/3DES</li>
<li>XTEA</li>
</ul>
<h2 id="AES功能模块的配置与使用">3.2 AES功能模块的配置与使用</h2><h3 id="配置宏定义">3.2.1 配置宏定义</h3><h4 id="AES功能相关宏">3.2.1.1 AES功能相关宏</h4><p>mbedtls中提供的这些对称加密算法，每个都是一个独立的模块，由对应的宏控制是否开启，要使用AES相关功能，需要开启以下宏：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_AES_C</td>
<td>开启AES算法</td>
</tr>
<tr>
<td>MBEDTLS_CIPHER_MODE_CBC</td>
<td>开启CBC模式</td>
</tr>
<tr>
<td>MBEDTLS_CIPHER_MODE_CTR</td>
<td>开启CRT模式</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>开启预定义S盒</td>
</tr>
<tr>
<td>MBEDTLS_CIPHER_PADDING_PKCS7</td>
<td>开启PKCS7填充方案</td>
</tr>
</tbody></table>
<p>① <strong>MBEDTLS_AES_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br></pre></td></tr></table></figure>
<p>② <strong>MBEDTLS_CIPHER_MODE_CBC</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_MODE_CBC</span></span><br></pre></td></tr></table></figure>
<p>③ <strong>MBEDTLS_CIPHER_MODE_CTR</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_MODE_CTR</span></span><br></pre></td></tr></table></figure>
<p>④ <strong>MBEDTLS_AES_ROM_TABLES</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br></pre></td></tr></table></figure>
<p>⑤<strong>MBEDTLS_CIPHER_PADDING_PKCS7</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_PADDING_PKCS7</span></span><br></pre></td></tr></table></figure>
<h4 id="cipher通用接口">3.2.1.2 cipher通用接口</h4><p>除了使用功能模块所提供的接口，mbedtls还提供了cipher通用接口，通过宏定义 <strong>MBEDTLS_CIPHER_C</strong> 开启：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_C</span></span><br></pre></td></tr></table></figure>
<h4 id="编写本实验配置文件">3.2.1.3 编写本实验配置文件</h4><p>编写<code>mbedtls_config_aes.h</code>文件，作为针对本实验的mbedtls配置文件，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_AES_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_AES_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_MODE_CBC				<span class="comment">// 开启CBC模式</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_MODE_CTR				<span class="comment">// 开启CRT模式</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C									<span class="comment">// 开启AES算法</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES				<span class="comment">// 开启预定义S盒</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_PADDING_PKCS7	<span class="comment">// 开启PKCS7填充方案</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CIPHER_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_CTR_DRBG_H_ */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="cipher通用接口API说明">3.2.2 cipher通用接口API说明</h3><p>包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/cipher.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化cipher结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_cipher_init</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 通过加密算法名类型获取cipher信息结构体指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">mbedtls_cipher_info_t</span> *<span class="title">mbedtls_cipher_info_from_type</span><span class="params">( <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_type_t</span> cipher_type )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 设置cipher结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_setup</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_info_t</span> *cipher_info )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 获取算法名称：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">mbedtls_cipher_get_name</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_context_t</span> *ctx )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MBEDTLS_INTERNAL_VALIDATE_RET( ctx != <span class="literal">NULL</span>, <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">if</span>( ctx-&gt;cipher_info == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctx-&gt;cipher_info-&gt;name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>⑤ 获取算法分组长度：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">mbedtls_cipher_get_block_size</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_context_t</span> *ctx )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MBEDTLS_INTERNAL_VALIDATE_RET( ctx != <span class="literal">NULL</span>, <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">if</span>( ctx-&gt;cipher_info == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctx-&gt;cipher_info-&gt;block_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>⑥ 设置解密秘钥接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_setkey</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *key,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">int</span> key_bitlen,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">mbedtls_operation_t</span> operation )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑦ 设置iv接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_set_iv</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *iv,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">size_t</span> iv_len )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑧ cipher更新接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_update</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">size_t</span> ilen, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">size_t</span> *olen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑨ cipher完成接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_finish</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> *olen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑩ 释放cipher结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_cipher_free</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数">3.2.3 编写测试函数</h3><p>新建demo文件<code>mbedtls_aes_test.c</code>，编写以下测试内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_CIPHER_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/cipher.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Private Key */</span></span><br><span class="line"><span class="keyword">uint8_t</span> key[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0x06</span>, <span class="number">0xa9</span>, <span class="number">0x21</span>, <span class="number">0x40</span>, <span class="number">0x36</span>, <span class="number">0xb8</span>, <span class="number">0xa1</span>, <span class="number">0x5b</span>,</span><br><span class="line">    <span class="number">0x51</span>, <span class="number">0x2e</span>, <span class="number">0x03</span>, <span class="number">0xd5</span>, <span class="number">0x34</span>, <span class="number">0x12</span>, <span class="number">0x00</span>, <span class="number">0x06</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Intialization Vector */</span></span><br><span class="line"><span class="keyword">uint8_t</span> iv[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0x3d</span>, <span class="number">0xaf</span>, <span class="number">0xba</span>, <span class="number">0x42</span>, <span class="number">0x9d</span>, <span class="number">0x9e</span>, <span class="number">0xb4</span>, <span class="number">0x30</span>,</span><br><span class="line">    <span class="number">0xb4</span>, <span class="number">0x22</span>, <span class="number">0xda</span>, <span class="number">0x80</span>, <span class="number">0x2c</span>, <span class="number">0x9f</span>, <span class="number">0xac</span>, <span class="number">0x41</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buf:&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aes_test</span><span class="params">(<span class="keyword">mbedtls_cipher_type_t</span> cipher_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">int</span> olen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> output_buf[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *input = <span class="string">&quot;creekwater is learning aes of mbedtls.&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">mbedtls_cipher_context_t</span> ctx;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_info_t</span> *info;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 1. 初始化cipher context结构体 */</span></span><br><span class="line">    mbedtls_cipher_init(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. 从类型获取cipher info */</span></span><br><span class="line">    info = mbedtls_cipher_info_from_type(cipher_type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. 设置cipher context结构体 */</span></span><br><span class="line">    ret = mbedtls_cipher_setup(&amp;ctx, info);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. 设置key */</span></span><br><span class="line">    ret = mbedtls_cipher_setkey(&amp;ctx, key, <span class="keyword">sizeof</span>(key) * <span class="number">8</span>, MBEDTLS_ENCRYPT);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. 设置iv */</span></span><br><span class="line">    ret = mbedtls_cipher_set_iv(&amp;ctx, iv, <span class="keyword">sizeof</span>(iv));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. 更新 cipher */</span></span><br><span class="line">    ret = mbedtls_cipher_update(&amp;ctx, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)input, <span class="built_in">strlen</span>(input), output_buf, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    olen += len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. 结束 cipher */</span></span><br><span class="line">    ret = mbedtls_cipher_finish(&amp;ctx, output_buf, &amp;len);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    olen += len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 打印结果 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\nsource_context:%s\r\n&quot;</span>, input);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cipher name:%s block size is:%d\r\n&quot;</span>, mbedtls_cipher_get_name(&amp;ctx), mbedtls_cipher_get_block_size(&amp;ctx));</span><br><span class="line">    dump_buf(output_buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    <span class="comment">/* 8. 释放 cipher 结构体 */</span></span><br><span class="line">    mbedtls_cipher_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_CIPHER_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果">3.2.4 测试结果</h3><p>从结果可以看到：</p>
<ul>
<li>AES算法分组大小为16个字节（128位）；</li>
<li>CBC模式下，AES算法会将55个字节的明文加密为64个字节；</li>
<li>CRT模式下，AES算法加密之后的密文长度仍然是55个字节，和明文长度相同；</li>
</ul>
<h1 id="四、消息认证码">4 四、消息认证码</h1><h2 id="什么是消息认证码">4.1 什么是消息认证码</h2><p>消息认证码（Message Authentication Code）可<strong>用来检查消息的完整性和消息来源的可靠性</strong>。</p>
<p>消息认证码算法的输入为任意长度的消息和通信双方共享的秘钥，消息认证码的输出为固定长度的数据，该输出数据称为MAC值、Tag值、T值。</p>
<h2 id="消息认证码的实现方式">4.2 消息认证码的实现方式</h2><h3 id="基于单向散列算法实现">4.2.1 基于单向散列算法实现</h3><p>这类实现称为<strong>HMAC</strong>，比如HMAC-SHA1、HMAC-SHA256等。因为单向散列算法无法验证消息来源的可靠性，所以不能直接用于生成消息认证码。</p>
<p>另外，在HMAC算法中，<strong>通信双方共享秘钥没有长度限制，明文也没有长度限制，但是最后生成的消息认证码长度是固定的</strong>。</p>
<p>比如基于SHA256算法的HAMC算法，因为SHA256计算出的消息摘要是256字节，32个字节，所以最后生成的消息认证码长度也是32个字节固定长度。</p>
<h3 id="基于分组加密算法实现">4.2.2 基于分组加密算法实现</h3><p>比如将CBC分组加密结果的最后一个分组作为消息认证码的<strong>CBC-MAC</strong>算法。</p>
<p>还有通过共享秘钥派生出两个中间秘钥的<strong>CMAC</strong>算法，安全性更高。</p>
<h3 id="认证加密算法实现">4.2.3 认证加密算法实现</h3><p>认证加密算法在通信过程中提供数据机密性和完整性的密码算法，是对称加密算法（eg. AES）和消息认证码的结合，典型实现包括<strong>GCM</strong>、<strong>CCM</strong>等。</p>
<p>CCM认证加密过程对明文进行两次处理，第一次使用CBC-MAC计算消息认证码，第二次使用CRT模式将消息认证码（明文）加密。</p>
<p>GCM认证加密过程和CCM类似，只不过第一次计算使用的是GHASH算法，第二次计算使用的是GCTR算法。</p>
<p>另外，<strong>GCM的消息认证码长度只能为16字节，而CCM模式的消息认证码长度最小为4字节、最大为16字节</strong>。</p>
<h2 id="mbedtls中的消息认证码实现">4.3 mbedtls中的消息认证码实现</h2><p>mbedtls中提供了HMAC计算接口和GCM计算接口。</p>
<h2 id="配置宏-1">4.4 配置宏</h2><p>开启一种单向散列函数功能和MD通用接口即可：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>开启SHA256单向散列算法</td>
</tr>
</tbody></table>
<p>新建一个针对本实验的配置文件<code>mbedtls_config_hmac.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_SHA_X_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_SHA_X_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD2_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD4_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_MD5_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA1_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA224_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA384_C</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_SHA512_C</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* enable generic message digest wrappers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_SHA_X_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>cmakefile.txt中添加<code>CPPFLAGS += -DMBEDTLS_CONFIG_FILE=&#39;&quot;mbedtls_config_hmac.h&quot;&#39;</code></p>
<h2 id="HMAC功能模块API说明">4.5 HMAC功能模块API说明</h2><p>① hmac启动接口（完成秘钥、ipad、opad计算）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_hmac_starts</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *key,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">size_t</span> keylen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② hmac更新接口（处理输入数据）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_hmac_update</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">size_t</span> ilen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ hmac完成接口（输出消息认证码）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_hmac_finish</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">unsigned</span> <span class="keyword">char</span> *output)</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 错误码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_FEATURE_UNAVAILABLE                -0x5080  <span class="comment">/**&lt; The selected feature is not available. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_BAD_INPUT_DATA                     -0x5100  <span class="comment">/**&lt; Bad input parameters to function. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_ALLOC_FAILED                       -0x5180  <span class="comment">/**&lt; Failed to allocate memory. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_FILE_IO_ERROR                      -0x5200  <span class="comment">/**&lt; Opening or reading of file failed. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* MBEDTLS_ERR_MD_HW_ACCEL_FAILED is deprecated and should not be used. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_MD_HW_ACCEL_FAILED                    -0x5280  <span class="comment">/**&lt; MD hardware accelerator failed. */</span></span></span><br></pre></td></tr></table></figure>
<p>特别注意，与计算单向散列值不同，<strong>在计算消息认证码的时候要在设置时表明使用HMAC</strong>，也就是 mbedtls_md_setup 函数的第三个参数要设置为非零值，通常设为1即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_md_setup</span><span class="params">( <span class="keyword">mbedtls_md_context_t</span> *ctx, <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *md_info, <span class="keyword">int</span> hmac )</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="编写测试函数-1">4.6 编写测试函数</h2><p>新建文件<code>mbedtls_hmac_test.c</code>，编写如下测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_MD_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/md.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_hmac_test</span><span class="params">(<span class="keyword">mbedtls_md_type_t</span> md_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len, i;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *key     = <span class="string">&quot;mculover666&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *message = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> hmac[<span class="number">32</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">mbedtls_md_context_t</span> ctx;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">mbedtls_md_info_t</span> *info;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;message is:%s\r\n&quot;</span>, message);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. 初始化 mbedtls_md_context_t 结构体 */</span></span><br><span class="line">    mbedtls_md_init(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. get md info structure pointer */</span></span><br><span class="line">    info = mbedtls_md_info_from_type(md_type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. setup md info structure */</span></span><br><span class="line">    ret = mbedtls_md_setup(&amp;ctx, info, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. start */</span></span><br><span class="line">    ret = mbedtls_md_hmac_starts(&amp;ctx, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)key, <span class="built_in">strlen</span>(key));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* 5. update */</span></span><br><span class="line">    ret = mbedtls_md_hmac_update(&amp;ctx, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)message, <span class="built_in">strlen</span>(message));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/* 6. finish */</span></span><br><span class="line">    ret = mbedtls_md_hmac_finish(&amp;ctx, hmac);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s hmac context is:[&quot;</span>, mbedtls_md_get_name(info));</span><br><span class="line">    len= mbedtls_md_get_size(info);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, hmac[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;]\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    <span class="comment">/* 7. free */</span></span><br><span class="line">    mbedtls_md_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_MD_C */</span></span></span><br></pre></td></tr></table></figure>
<h2 id="测试结果-1">4.7 测试结果</h2><p>在main.c中声明该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Private user code ---------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">/* USER CODE BEGIN 0 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/md.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_hmac_test</span><span class="params">(<span class="keyword">mbedtls_md_type_t</span> md_type)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* USER CODE END 0 */</span></span><br></pre></td></tr></table></figure>
<p>然后在main函数中调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 3. hamc test */</span></span><br><span class="line">mbedtls_hmac_test(MBEDTLS_MD_SHA256);</span><br></pre></td></tr></table></figure>
<p>编译、下载、测试结果如图：</p>
<p>在MDK中配置：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200926151128537.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h2 id="GCM功能模块相关的API说明">4.8 GCM功能模块相关的API说明</h2><p>① cipher认证加密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_auth_encrypt</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *iv, <span class="keyword">size_t</span> iv_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *ad, <span class="keyword">size_t</span> ad_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">size_t</span> ilen,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> *olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">unsigned</span> <span class="keyword">char</span> *tag, <span class="keyword">size_t</span> tag_len )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② cipher认证解密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_cipher_auth_decrypt</span><span class="params">( <span class="keyword">mbedtls_cipher_context_t</span> *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *iv, <span class="keyword">size_t</span> iv_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *ad, <span class="keyword">size_t</span> ad_len,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">size_t</span> ilen,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> *olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *tag, <span class="keyword">size_t</span> tag_len )</span></span>;</span><br></pre></td></tr></table></figure>
<h2 id="编写测试代码-1">4.9 编写测试代码</h2><p>新建文件<code>mbedtls_config_gcm.c</code>，编写测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_GCM_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/cipher.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* source context */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> input[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0xc3</span>, <span class="number">0xb3</span>, <span class="number">0xc4</span>, <span class="number">0x1f</span>, <span class="number">0x11</span>, <span class="number">0x3a</span>, <span class="number">0x31</span>, <span class="number">0xb7</span>, </span><br><span class="line">    <span class="number">0x3d</span>, <span class="number">0x9a</span>, <span class="number">0x5c</span>, <span class="number">0xd4</span>, <span class="number">0x32</span>, <span class="number">0x10</span>, <span class="number">0x30</span>, <span class="number">0x69</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Private Key */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> key[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0xc9</span>, <span class="number">0x39</span>, <span class="number">0xcc</span>, <span class="number">0x13</span>, <span class="number">0x39</span>, <span class="number">0x7c</span>, <span class="number">0x1d</span>, <span class="number">0x37</span>,</span><br><span class="line">    <span class="number">0xde</span>, <span class="number">0x6a</span>, <span class="number">0xe0</span>, <span class="number">0xe1</span>, <span class="number">0xcb</span>, <span class="number">0x7c</span>, <span class="number">0x42</span>, <span class="number">0x3c</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Intialization Vector */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> iv[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0xb3</span>, <span class="number">0xd8</span>, <span class="number">0xcc</span>, <span class="number">0x01</span>, </span><br><span class="line">    <span class="number">0x7c</span>, <span class="number">0xbb</span>, <span class="number">0x89</span>, <span class="number">0xb3</span>,</span><br><span class="line">    <span class="number">0x9e</span>, <span class="number">0x0f</span>, <span class="number">0x67</span>, <span class="number">0xe2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The additional data to authenticate */</span></span><br><span class="line"><span class="keyword">uint8_t</span> add[<span class="number">16</span>] = &#123;</span><br><span class="line">    <span class="number">0x24</span>, <span class="number">0x82</span>, <span class="number">0x56</span>, <span class="number">0x02</span>, <span class="number">0xbd</span>, <span class="number">0x12</span>, <span class="number">0xa9</span>, <span class="number">0x84</span>, </span><br><span class="line">    <span class="number">0xe0</span>, <span class="number">0x09</span>, <span class="number">0x2d</span>, <span class="number">0x3e</span>, <span class="number">0x44</span>, <span class="number">0x8e</span>, <span class="number">0xda</span>, <span class="number">0x5f</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcm_test</span><span class="params">(<span class="keyword">mbedtls_cipher_type_t</span> cipher_type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> len;</span><br><span class="line">    <span class="keyword">int</span> olen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> output_buf[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> tag_buf[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> decrypt_out_buf[<span class="number">16</span>];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">mbedtls_cipher_context_t</span> ctx;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">mbedtls_cipher_info_t</span> *info;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 1. init cipher structuer */</span></span><br><span class="line">    mbedtls_cipher_init(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. get info structuer from type */</span></span><br><span class="line">    info = mbedtls_cipher_info_from_type(cipher_type);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. setup cipher structuer */</span></span><br><span class="line">    ret = mbedtls_cipher_setup(&amp;ctx, info);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. set encrypt key */</span></span><br><span class="line">    ret = mbedtls_cipher_setkey(&amp;ctx, key, <span class="keyword">sizeof</span>(key) * <span class="number">8</span>, MBEDTLS_ENCRYPT);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. auth encrypt */</span></span><br><span class="line">    ret = mbedtls_cipher_auth_encrypt(&amp;ctx, </span><br><span class="line">                                      iv, <span class="keyword">sizeof</span>(iv), add, <span class="keyword">sizeof</span>(add), </span><br><span class="line">                                      (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)input, <span class="keyword">sizeof</span>(input), </span><br><span class="line">                                      output_buf, &amp;len, tag_buf, <span class="keyword">sizeof</span>(tag_buf));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    olen += len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cipher name:%s block size is:%d\r\n&quot;</span>, mbedtls_cipher_get_name(&amp;ctx), mbedtls_cipher_get_block_size(&amp;ctx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\noutput_buf:\r\n&quot;</span>);</span><br><span class="line">    dump_buf((<span class="keyword">uint8_t</span> *)output_buf, olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\ntag_buf:\r\n&quot;</span>);</span><br><span class="line">    dump_buf(tag_buf, <span class="keyword">sizeof</span>(tag_buf));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. set decrypt key */</span></span><br><span class="line">    ret = mbedtls_cipher_setkey(&amp;ctx, key, <span class="keyword">sizeof</span>(key) * <span class="number">8</span>, MBEDTLS_DECRYPT);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. auth decrypt */</span></span><br><span class="line">    olen = <span class="number">0</span>;</span><br><span class="line">    len  = <span class="number">0</span>;</span><br><span class="line">    ret = mbedtls_cipher_auth_decrypt(&amp;ctx, </span><br><span class="line">                                      iv, <span class="keyword">sizeof</span>(iv), add, <span class="keyword">sizeof</span>(add), </span><br><span class="line">                                      (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)output_buf, <span class="keyword">sizeof</span>(output_buf), </span><br><span class="line">                                      decrypt_out_buf, &amp;len, tag_buf, <span class="keyword">sizeof</span>(tag_buf));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    olen += len;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cipher name:%s block size is:%d\r\n&quot;</span>, mbedtls_cipher_get_name(&amp;ctx), mbedtls_cipher_get_block_size(&amp;ctx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\ndecrypt_out_buf:\r\n&quot;</span>);</span><br><span class="line">    dump_buf((<span class="keyword">uint8_t</span> *)decrypt_out_buf, olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\ntag_buf:\r\n&quot;</span>);</span><br><span class="line">    dump_buf(tag_buf, <span class="keyword">sizeof</span>(tag_buf));</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    <span class="comment">/* 8. free cipher structure */</span></span><br><span class="line">    mbedtls_cipher_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_CIPHER_C */</span></span></span><br></pre></td></tr></table></figure>
<h2 id="测试结果-2">4.10 测试结果</h2><p>在main.c 中声明该外部函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Private user code ---------------------------------------------------------*/</span></span><br><span class="line"><span class="comment">/* USER CODE BEGIN 0 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/cipher.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gcm_test</span><span class="params">(<span class="keyword">mbedtls_cipher_type_t</span> cipher_type)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* USER CODE END 0 */</span></span><br></pre></td></tr></table></figure>
<p>接着在main函数中调用测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 4.gcm test */</span></span><br><span class="line">gcm_test(MBEDTLS_CIPHER_AES_128_GCM);</span><br></pre></td></tr></table></figure>
<p>编译、下载，测试结果为：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200926151709761.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h1 id="五、非对称加密算法的配置与使用（RSA算法）">5 五、非对称加密算法的配置与使用（RSA算法）</h1><h2 id="非对称加密算法——RSA">5.1 非对称加密算法——RSA</h2><h3 id="对称加密算法和非对称加密算法">5.1.1 对称加密算法和非对称加密算法</h3><p>对称加密算法，比如AES算法，在发送端（加密）和接收端（解密）使用相同的一份秘钥，称为共享秘钥。</p>
<p>非对称加密算法，比如RSA算法，在加密使用<strong>公钥</strong>，而在解密时使用<strong>私钥</strong>。</p>
<h3 id="RSA算法">5.1.2 RSA算法</h3><p>RSA算法是一种常用的非对称加密算法。</p>
<p>RSA算法主要包括三个过程：</p>
<ul>
<li>生成秘钥对</li>
<li>使用公钥加密明文</li>
<li>使用私钥解密密文</li>
</ul>
<h3 id="RSA加速技术">5.1.3 RSA加速技术</h3><p>RSA算法在计算过程中存在较多的取模运算和幂运算，计算速度比对称加密算法要慢，所以不适合对大量数据进行加密和解密，在实际中常用于加密或解密小数据片段。</p>
<p>RSA公钥加密过程可使用短公开指数进行快速计算，而RSA私钥解密过程可使用中国剩余定理（CRT）进行加速执行。</p>
<h3 id="RSA填充方法">5.1.4 RSA填充方法</h3><p>RSA加密结果是<strong>确定的</strong>。当公钥确定的时候，一段明文总是会加密的到对应的密文，这样未免存在安全隐患。</p>
<p>实际使用RSA算法中需要包含填充方案，在计算之前会对明文进行随机注入，这样在公钥和明文相同的情况下，也不会生成相同的秘文。</p>
<p>常用的RSA填充方案有两种：RSAES-OAEP（推荐使用）和RSAES-PKCS1V1_5（较早、不推荐使用）。</p>
<h2 id="RSA功能模块的配置与使用">5.2 RSA功能模块的配置与使用</h2><h3 id="配置宏-2">5.2.1 配置宏</h3><p>使用RSA功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_GENPRIME</td>
<td>开启生成素数</td>
</tr>
<tr>
<td>MBEDTLS_OID_C</td>
<td>开启OID数据结构模块</td>
</tr>
<tr>
<td>MBEDTLS_RSA_C</td>
<td>开启RSA算法</td>
</tr>
<tr>
<td>MBEDTLS_PKCS1_V21</td>
<td>开启PKCS#1 v2.1填充方案（OAEP）</td>
</tr>
</tbody></table>
<p>下面补充几个第一次出现宏的定义。</p>
<p>① <strong>MBEDTLS_BIGNUM_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the multi-precision integer library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/bignum.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/dhm.c</span></span><br><span class="line"><span class="comment"> *          library/ecp.c</span></span><br><span class="line"><span class="comment"> *          library/ecdsa.c</span></span><br><span class="line"><span class="comment"> *          library/rsa.c</span></span><br><span class="line"><span class="comment"> *          library/rsa_internal.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_tls.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is required for RSA, DHM and ECC (ECDH, ECDSA) support.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br></pre></td></tr></table></figure>
<p>② <strong>MBEDTLS_GENPRIME</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the prime-number generation code.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="number">12345678</span></span><br></pre></td></tr></table></figure>
<p>③ <strong>MBEDTLS_OID_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_OID_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the OID database.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/oid.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/asn1write.c</span></span><br><span class="line"><span class="comment"> *          library/pkcs5.c</span></span><br><span class="line"><span class="comment"> *          library/pkparse.c</span></span><br><span class="line"><span class="comment"> *          library/pkwrite.c</span></span><br><span class="line"><span class="comment"> *          library/rsa.c</span></span><br><span class="line"><span class="comment"> *          library/x509.c</span></span><br><span class="line"><span class="comment"> *          library/x509_create.c</span></span><br><span class="line"><span class="comment"> *          library/x509_crl.c</span></span><br><span class="line"><span class="comment"> *          library/x509_crt.c</span></span><br><span class="line"><span class="comment"> *          library/x509_csr.c</span></span><br><span class="line"><span class="comment"> *          library/x509write_crt.c</span></span><br><span class="line"><span class="comment"> *          library/x509write_csr.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This modules translates between OIDs and internal values.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_OID_C</span></span><br></pre></td></tr></table></figure>
<p>④ <strong>MBEDTLS_RSA_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_RSA_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the RSA public-key cryptosystem.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/rsa.c</span></span><br><span class="line"><span class="comment"> *          library/rsa_internal.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ssl_cli.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_srv.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_tls.c</span></span><br><span class="line"><span class="comment"> *          library/x509.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is used by the following key exchanges:</span></span><br><span class="line"><span class="comment"> *      RSA, DHE-RSA, ECDHE-RSA, RSA-PSK</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_BIGNUM_C, MBEDTLS_OID_C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_RSA_C</span></span><br></pre></td></tr></table></figure>
<p>⑤ <strong>MBEDTLS_PKCS1_V21</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_PKCS1_V21</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable support for PKCS#1 v2.1 encoding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_MD_C, MBEDTLS_RSA_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This enables support for RSAES-OAEP and RSASSA-PSS operations.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PKCS1_V21</span></span><br></pre></td></tr></table></figure>
<p>编辑针对本实验的配置文件<code>mbedtls_config_rsa.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_RSA_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_RSA_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_OID_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_RSA_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PKCS1_V21</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_RSA_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK配置mbedtls使用该配置文件：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200927110342915.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h3 id="RSA功能模块API说明">5.2.2 RSA功能模块API说明</h3><p>使用该功能模块需要包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/rsa.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化RSA结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function initializes an RSA context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Set padding to #MBEDTLS_RSA_PKCS_V21 for the RSAES-OAEP</span></span><br><span class="line"><span class="comment"> *                 encryption scheme and the RSASSA-PSS signature scheme.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The \p hash_id parameter is ignored when using</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PKCS_V15 padding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The choice of padding mode is strictly enforced for private key</span></span><br><span class="line"><span class="comment"> *                 operations, since there might be security concerns in</span></span><br><span class="line"><span class="comment"> *                 mixing padding modes. For public key operations it is</span></span><br><span class="line"><span class="comment"> *                 a default value, which can be overridden by calling specific</span></span><br><span class="line"><span class="comment"> *                 \c rsa_rsaes_xxx or \c rsa_rsassa_xxx functions.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The hash selected in \p hash_id is always used for OEAP</span></span><br><span class="line"><span class="comment"> *                 encryption. For PSS signatures, it is always used for</span></span><br><span class="line"><span class="comment"> *                 making signatures, but can be overridden for verifying them.</span></span><br><span class="line"><span class="comment"> *                 If set to #MBEDTLS_MD_NONE, it is always overridden.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The RSA context to initialize. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param padding  The padding mode to use. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PKCS_V15 or #MBEDTLS_RSA_PKCS_V21.</span></span><br><span class="line"><span class="comment"> * \param hash_id  The hash identifier of ::mbedtls_md_type_t type, if</span></span><br><span class="line"><span class="comment"> *                 \p padding is #MBEDTLS_RSA_PKCS_V21. It is unused</span></span><br><span class="line"><span class="comment"> *                 otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_rsa_init</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> padding,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> hash_id )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② RSA生成秘钥对：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function generates an RSA keypair.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           mbedtls_rsa_init() must be called before this function,</span></span><br><span class="line"><span class="comment"> *                 to set up the RSA context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA context used to hold the key.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function to be used for key generation.</span></span><br><span class="line"><span class="comment"> *                 This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng.</span></span><br><span class="line"><span class="comment"> *                 This may be \c NULL if \p f_rng doesn&#x27;t need a context.</span></span><br><span class="line"><span class="comment"> * \param nbits    The size of the public key in bits.</span></span><br><span class="line"><span class="comment"> * \param exponent The public exponent to use. For example, \c 65537.</span></span><br><span class="line"><span class="comment"> *                 This must be odd and greater than \c 1.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_gen_key</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">unsigned</span> <span class="keyword">int</span> nbits, <span class="keyword">int</span> exponent )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ RSA加密操作，通过参数指定公钥加密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function adds the message padding, then performs an RSA</span></span><br><span class="line"><span class="comment"> *                 operation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 It is the generic wrapper for performing a PKCS#1 encryption</span></span><br><span class="line"><span class="comment"> *                 operation using the \p mode from the context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \deprecated     It is deprecated and discouraged to call this function</span></span><br><span class="line"><span class="comment"> *                 in #MBEDTLS_RSA_PRIVATE mode. Future versions of the library</span></span><br><span class="line"><span class="comment"> *                 are likely to remove the \p mode argument and have it</span></span><br><span class="line"><span class="comment"> *                 implicitly set to #MBEDTLS_RSA_PUBLIC.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Alternative implementations of RSA need not support</span></span><br><span class="line"><span class="comment"> *                 mode being set to #MBEDTLS_RSA_PRIVATE and might instead</span></span><br><span class="line"><span class="comment"> *                 return #MBEDTLS_ERR_PLATFORM_FEATURE_UNSUPPORTED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA context to use.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG to use. It is mandatory for PKCS#1 v2.1 padding</span></span><br><span class="line"><span class="comment"> *                 encoding, and for PKCS#1 v1.5 padding encoding when used</span></span><br><span class="line"><span class="comment"> *                 with \p mode set to #MBEDTLS_RSA_PUBLIC. For PKCS#1 v1.5</span></span><br><span class="line"><span class="comment"> *                 padding encoding and \p mode set to #MBEDTLS_RSA_PRIVATE,</span></span><br><span class="line"><span class="comment"> *                 it is used for blinding and should be provided in this</span></span><br><span class="line"><span class="comment"> *                 case; see mbedtls_rsa_private() for more.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. May be</span></span><br><span class="line"><span class="comment"> *                 \c NULL if \p f_rng is \c NULL or if \p f_rng doesn&#x27;t</span></span><br><span class="line"><span class="comment"> *                 need a context argument.</span></span><br><span class="line"><span class="comment"> * \param mode     The mode of operation. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PUBLIC or #MBEDTLS_RSA_PRIVATE (deprecated).</span></span><br><span class="line"><span class="comment"> * \param ilen     The length of the plaintext in Bytes.</span></span><br><span class="line"><span class="comment"> * \param input    The input data to encrypt. This must be a readable</span></span><br><span class="line"><span class="comment"> *                 buffer of size \p ilen Bytes. It may be \c NULL if</span></span><br><span class="line"><span class="comment"> *                 `ilen == 0`.</span></span><br><span class="line"><span class="comment"> * \param output   The output buffer. This must be a writable buffer</span></span><br><span class="line"><span class="comment"> *                 of length \c ctx-&gt;len Bytes. For example, \c 256 Bytes</span></span><br><span class="line"><span class="comment"> *                 for an 2048-bit RSA modulus.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_pkcs1_encrypt</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> mode, <span class="keyword">size_t</span> ilen,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> <span class="keyword">char</span> *output )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ RSA解密操作，通过指定私钥解密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function performs an RSA operation, then removes the</span></span><br><span class="line"><span class="comment"> *                 message padding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 It is the generic wrapper for performing a PKCS#1 decryption</span></span><br><span class="line"><span class="comment"> *                 operation using the \p mode from the context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The output buffer length \c output_max_len should be</span></span><br><span class="line"><span class="comment"> *                 as large as the size \p ctx-&gt;len of \p ctx-&gt;N (for example,</span></span><br><span class="line"><span class="comment"> *                 128 Bytes if RSA-1024 is used) to be able to hold an</span></span><br><span class="line"><span class="comment"> *                 arbitrary decrypted message. If it is not large enough to</span></span><br><span class="line"><span class="comment"> *                 hold the decryption of the particular ciphertext provided,</span></span><br><span class="line"><span class="comment"> *                 the function returns \c MBEDTLS_ERR_RSA_OUTPUT_TOO_LARGE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \deprecated     It is deprecated and discouraged to call this function</span></span><br><span class="line"><span class="comment"> *                 in #MBEDTLS_RSA_PUBLIC mode. Future versions of the library</span></span><br><span class="line"><span class="comment"> *                 are likely to remove the \p mode argument and have it</span></span><br><span class="line"><span class="comment"> *                 implicitly set to #MBEDTLS_RSA_PRIVATE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Alternative implementations of RSA need not support</span></span><br><span class="line"><span class="comment"> *                 mode being set to #MBEDTLS_RSA_PUBLIC and might instead</span></span><br><span class="line"><span class="comment"> *                 return #MBEDTLS_ERR_PLATFORM_FEATURE_UNSUPPORTED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA context to use.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function. If \p mode is #MBEDTLS_RSA_PRIVATE,</span></span><br><span class="line"><span class="comment"> *                 this is used for blinding and should be provided; see</span></span><br><span class="line"><span class="comment"> *                 mbedtls_rsa_private() for more. If \p mode is</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PUBLIC, it is ignored.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                 \c NULL if \p f_rng is \c NULL or doesn&#x27;t need a context.</span></span><br><span class="line"><span class="comment"> * \param mode     The mode of operation. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PRIVATE or #MBEDTLS_RSA_PUBLIC (deprecated).</span></span><br><span class="line"><span class="comment"> * \param olen     The address at which to store the length of</span></span><br><span class="line"><span class="comment"> *                 the plaintext. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param input    The ciphertext buffer. This must be a readable buffer</span></span><br><span class="line"><span class="comment"> *                 of length \c ctx-&gt;len Bytes. For example, \c 256 Bytes</span></span><br><span class="line"><span class="comment"> *                 for an 2048-bit RSA modulus.</span></span><br><span class="line"><span class="comment"> * \param output   The buffer used to hold the plaintext. This must</span></span><br><span class="line"><span class="comment"> *                 be a writable buffer of length \p output_max_len Bytes.</span></span><br><span class="line"><span class="comment"> * \param output_max_len The length in Bytes of the output buffer \p output.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_pkcs1_decrypt</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">int</span> mode, <span class="keyword">size_t</span> *olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> <span class="keyword">char</span> *output,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">size_t</span> output_max_len )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 释放RSA结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function frees the components of an RSA key.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The RSA context to free. May be \c NULL, in which case</span></span><br><span class="line"><span class="comment"> *                 this function is a no-op. If it is not \c NULL, it must</span></span><br><span class="line"><span class="comment"> *                 point to an initialized RSA context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_rsa_free</span><span class="params">( mbedtls_rsa_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-2">5.2.3 编写测试函数</h3><p>新建文件<code>mbedtls_rsa_test.c</code>，编写以下测试内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief   RSA Function demo</span></span><br><span class="line"><span class="comment"> * @author  mculover666</span></span><br><span class="line"><span class="comment"> * @date    2020/09/27</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_RSA_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/rsa.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">516</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_rsa_key</span><span class="params">(mbedtls_rsa_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  +++++++++++++++++ rsa keypair +++++++++++++++++\n\n&quot;</span>);</span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;N , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;N: %s\n&quot;</span>, buf); </span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;E , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;E: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;D , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;D: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;P , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;P: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;Q , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Q: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;DP, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DP: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;DQ, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DQ: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;QP, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;QP: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  +++++++++++++++++ rsa keypair +++++++++++++++++\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> output_buf[<span class="number">2048</span>/<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* msg = <span class="string">&quot;HelloWorld&quot;</span>;</span><br><span class="line">    <span class="keyword">uint8_t</span> decrypt_buf[<span class="number">20</span>];</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;rsa_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_rsa_context ctx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_rsa_init(&amp;ctx, MBEDTLS_RSA_PKCS_V21, MBEDTLS_MD_SHA256);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. generate an RSA keypair */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Generate RSA keypair...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_gen_key(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, <span class="number">2048</span>, <span class="number">65537</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_gen_key returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* shwo RSA keypair */</span></span><br><span class="line">    dump_rsa_key(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. encrypt */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . RSA pkcs1 encrypt...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_pkcs1_encrypt(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, MBEDTLS_RSA_PUBLIC, </span><br><span class="line">                                    <span class="built_in">strlen</span>(msg), (<span class="keyword">uint8_t</span> *)msg, output_buf);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_pkcs1_encrypt returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show encrypt result */</span></span><br><span class="line">    dump_buf(output_buf, <span class="keyword">sizeof</span>(output_buf));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. decrypt */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . RSA pkcs1 decrypt...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_pkcs1_decrypt(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, MBEDTLS_RSA_PRIVATE, </span><br><span class="line">                                    &amp;olen, output_buf, decrypt_buf, <span class="keyword">sizeof</span>(decrypt_buf));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_pkcs1_decrypt returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show decrypt result */</span></span><br><span class="line">    decrypt_buf[olen] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;decrypt result:[%s]\r\n&quot;</span>, decrypt_buf);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_rsa_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_RSA_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-3">5.2.4 测试结果</h3><p>在 main.c 中声明该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_rsa_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后在main函数中调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 5. rsa test */</span></span><br><span class="line">mbedtls_rsa_test();</span><br></pre></td></tr></table></figure>
<h3 id="堆内存空间的设置">5.2.5 堆内存空间的设置</h3><p><strong>特别注意：</strong></p>
<p>mbedtls RSA算法中的生成秘钥对比较占用空间，再加上RSA算法计算过程涉及到大数运算，所以RSA算法对内存的消耗比较大。</p>
<p>mbedtls使用的是动态内存，从堆空间中分配，所以要在STM32启动文件中将堆空间设置的大一点：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200928201926696.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h3 id="测试结果-4">5.2.6 测试结果</h3><p>编译、下载到开发板中，可以看到：</p>
<p>① 秘钥对生成结果（花费大概5min左右，主控芯片STM32L431主频为80Mhz）：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200927143614723.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<p>② 使用公钥加密结果（因为RSA算法中的特性，所以同一份程序，同一份明文，每次重新运行生成的密文也不同）：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200927143637213.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>③ 使用私钥解密结果：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200927143743879.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h1 id="六、DH秘钥协商算法的配置与使用">6 六、DH秘钥协商算法的配置与使用</h1><h2 id="DH秘钥协商算法">6.1 DH秘钥协商算法</h2><p>DH是一种秘钥协商算法，使得通信双方在不安全通道交换共享参数，从而协商出一个会话秘钥。</p>
<p>DH秘钥协商的过程如下：</p>
<p>① 通信双方A和B确认共享参数；<br>② A生成随机秘钥x；<br>③ B生成随机秘钥y；<br>④ A计算共享秘钥；<br>⑤ B计算共享秘钥；</p>
<p>DH秘钥协商算法可以有效防止中间窃听者，但是无法方式中间拦截者。</p>
<h2 id="DH秘钥协商功能的配置和使用">6.2 DH秘钥协商功能的配置和使用</h2><h3 id="配置宏-3">6.2.1 配置宏</h3><p>使用DH秘钥协商功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_GENPRIME</td>
<td>开启生成素数</td>
</tr>
<tr>
<td>MBEDTLS_DHM_C</td>
<td>开启DH秘钥协商模块</td>
</tr>
</tbody></table>
<p>下面补充几个一个第一次出现宏的定义。</p>
<p>① <strong>MBEDTLS_DHM_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_DHM_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the Diffie-Hellman-Merkle module.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/dhm.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ssl_cli.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_srv.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is used by the following key exchanges:</span></span><br><span class="line"><span class="comment"> *      DHE-RSA, DHE-PSK</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \warning    Using DHE constitutes a security risk as it</span></span><br><span class="line"><span class="comment"> *             is not possible to validate custom DH parameters.</span></span><br><span class="line"><span class="comment"> *             If possible, it is recommended users should consider</span></span><br><span class="line"><span class="comment"> *             preferring other methods of key exchange.</span></span><br><span class="line"><span class="comment"> *             See dhm.h for more details.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_DHM_C</span></span><br></pre></td></tr></table></figure>
<p>编辑针对本实验的配置文件<code>mbedtls_config_dhm.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief   Minimal configuration for DHM Function</span></span><br><span class="line"><span class="comment"> * @author  mculover666</span></span><br><span class="line"><span class="comment"> * @date    2020/09/28</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_DHM_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_DHM_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_DHM_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_DHM_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK配置mbedtls使用该配置文件：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200928201900998.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h3 id="DH秘钥协商功能API说明">6.2.2 DH秘钥协商功能API说明</h3><p>使用该功能模块需要包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/dhm.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化DH结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function initializes the DHM context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The DHM context to initialize.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_dhm_init</span><span class="params">( mbedtls_dhm_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 生成公开参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function creates a DHM key pair and exports</span></span><br><span class="line"><span class="comment"> *                 the raw public key in big-endian format.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The destination buffer is always fully written</span></span><br><span class="line"><span class="comment"> *                 so as to contain a big-endian representation of G^X mod P.</span></span><br><span class="line"><span class="comment"> *                 If it is larger than \c ctx-&gt;len, it is padded accordingly</span></span><br><span class="line"><span class="comment"> *                 with zero-bytes at the beginning.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The DHM context to use. This must be initialized and</span></span><br><span class="line"><span class="comment"> *                 have the DHM parameters set. It may or may not already</span></span><br><span class="line"><span class="comment"> *                 have imported the peer&#x27;s public key.</span></span><br><span class="line"><span class="comment"> * \param x_size   The private key size in Bytes.</span></span><br><span class="line"><span class="comment"> * \param output   The destination buffer. This must be a writable buffer of</span></span><br><span class="line"><span class="comment"> *                 size \p olen Bytes.</span></span><br><span class="line"><span class="comment"> * \param olen     The length of the destination buffer. This must be at least</span></span><br><span class="line"><span class="comment"> *                 equal to `ctx-&gt;len` (the size of \c P).</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be \c NULL</span></span><br><span class="line"><span class="comment"> *                 if \p f_rng doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_DHM_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_dhm_make_public</span><span class="params">( mbedtls_dhm_context *ctx, <span class="keyword">int</span> x_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 读取公开参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function imports the raw public value of the peer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           In a TLS handshake, this is the how the server imports</span></span><br><span class="line"><span class="comment"> *                 the Client&#x27;s public DHM key.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The DHM context to use. This must be initialized and have</span></span><br><span class="line"><span class="comment"> *                 its DHM parameters set, e.g. via mbedtls_dhm_set_group().</span></span><br><span class="line"><span class="comment"> *                 It may or may not already have generated its own private key.</span></span><br><span class="line"><span class="comment"> * \param input    The input buffer containing the \c G^Y value of the peer.</span></span><br><span class="line"><span class="comment"> *                 This must be a readable buffer of size \p ilen Bytes.</span></span><br><span class="line"><span class="comment"> * \param ilen     The size of the input buffer \p input in Bytes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_DHM_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_dhm_read_public</span><span class="params">( mbedtls_dhm_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">size_t</span> ilen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 计算共享秘钥：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function derives and exports the shared secret</span></span><br><span class="line"><span class="comment"> *                 \c (G^Y)^X mod \c P.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           If \p f_rng is not \c NULL, it is used to blind the input as</span></span><br><span class="line"><span class="comment"> *                 a countermeasure against timing attacks. Blinding is used</span></span><br><span class="line"><span class="comment"> *                 only if our private key \c X is re-used, and not used</span></span><br><span class="line"><span class="comment"> *                 otherwise. We recommend always passing a non-NULL</span></span><br><span class="line"><span class="comment"> *                 \p f_rng argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx           The DHM context to use. This must be initialized</span></span><br><span class="line"><span class="comment"> *                      and have its own private key generated and the peer&#x27;s</span></span><br><span class="line"><span class="comment"> *                      public key imported.</span></span><br><span class="line"><span class="comment"> * \param output        The buffer to write the generated shared key to. This</span></span><br><span class="line"><span class="comment"> *                      must be a writable buffer of size \p output_size Bytes.</span></span><br><span class="line"><span class="comment"> * \param output_size   The size of the destination buffer. This must be at</span></span><br><span class="line"><span class="comment"> *                      least the size of \c ctx-&gt;len (the size of \c P).</span></span><br><span class="line"><span class="comment"> * \param olen          On exit, holds the actual number of Bytes written.</span></span><br><span class="line"><span class="comment"> * \param f_rng         The RNG function, for blinding purposes. This may</span></span><br><span class="line"><span class="comment"> *                      b \c NULL if blinding isn&#x27;t needed.</span></span><br><span class="line"><span class="comment"> * \param p_rng         The RNG context. This may be \c NULL if \p f_rng</span></span><br><span class="line"><span class="comment"> *                      doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return              \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return              An \c MBEDTLS_ERR_DHM_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_dhm_calc_secret</span><span class="params">( mbedtls_dhm_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">size_t</span> output_size, <span class="keyword">size_t</span> *olen,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 释放DH结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function frees and clears the components</span></span><br><span class="line"><span class="comment"> *                 of a DHM context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The DHM context to free and clear. This may be \c NULL,</span></span><br><span class="line"><span class="comment"> *                 in which case this function is a no-op. If it is not \c NULL,</span></span><br><span class="line"><span class="comment"> *                 it must point to an initialized DHM context.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_dhm_free</span><span class="params">( mbedtls_dhm_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑥ 错误码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_BAD_INPUT_DATA                    -0x3080  <span class="comment">/**&lt; Bad input parameters. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_READ_PARAMS_FAILED                -0x3100  <span class="comment">/**&lt; Reading of the DHM parameters failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_MAKE_PARAMS_FAILED                -0x3180  <span class="comment">/**&lt; Making of the DHM parameters failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_READ_PUBLIC_FAILED                -0x3200  <span class="comment">/**&lt; Reading of the public values failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_MAKE_PUBLIC_FAILED                -0x3280  <span class="comment">/**&lt; Making of the public value failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_CALC_SECRET_FAILED                -0x3300  <span class="comment">/**&lt; Calculation of the DHM secret failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_INVALID_FORMAT                    -0x3380  <span class="comment">/**&lt; The ASN.1 data is not formatted correctly. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_ALLOC_FAILED                      -0x3400  <span class="comment">/**&lt; Allocation of memory failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_FILE_IO_ERROR                     -0x3480  <span class="comment">/**&lt; Read or write of file failed. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* MBEDTLS_ERR_DHM_HW_ACCEL_FAILED is deprecated and should not be used. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_HW_ACCEL_FAILED                   -0x3500  <span class="comment">/**&lt; DHM hardware accelerator failed. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_DHM_SET_GROUP_FAILED                  -0x3580  <span class="comment">/**&lt; Setting the modulus and generator failed. */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-3">6.2.3 编写测试函数</h3><p>新建测试文件``，编写以下测试内容，其中服务器和客户端之间直接通信，没有采用网络通信：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_DHM_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/dhm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATOR   <span class="meta-string">&quot;2&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T_P          <span class="meta-string">&quot;FFFFFFFFFFFFFFFFADF85458A2BB4A9AAFDC5620273D3CF1D8B9C583CE2D3695&quot;</span> \</span></span><br><span class="line">                     <span class="string">&quot;A9E13641146433FBCC939DCE249B3EF97D2FE363630C75D8F681B202AEC4617A&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;D3DF1ED5D5FD65612433F51F5F066ED0856365553DED1AF3B557135E7F57C935&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;984F0C70E0E68B77E2A689DAF3EFE8721DF158A136ADE73530ACCA4F483A797A&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;BC0AB182B324FB61D108A94BB2C8E3FBB96ADAB760D7F4681D4F42A3DE394DF4&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;AE56EDE76372BB190B07A7C8EE0A6D709E02FCE1CDF7E2ECC03404CD28342F61&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;9172FE9CE98583FF8E4F1232EEF28183C3FE3B1B4C6FAD733BB5FCBC2EC22005&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;C58EF1837D1683B2C6F34A26C1B2EFFA886B423861285C97FFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> server_pub[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> client_pub[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> server_secret[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">uint8_t</span> client_secret[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_dhm_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;dhm_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_dhm_context dhm_server, dhm_client;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_dhm_init(&amp;dhm_server);</span><br><span class="line">    mbedtls_dhm_init(&amp;dhm_client);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. genetate 2048 bit prime(G, P) */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Genetate 2048 bit prime(G, P)...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    mbedtls_mpi_read_string(&amp;dhm_server.P, <span class="number">16</span>, T_P);</span><br><span class="line">    mbedtls_mpi_read_string(&amp;dhm_server.G, <span class="number">10</span>, GENERATOR);</span><br><span class="line">    dhm_server.len = mbedtls_mpi_size(&amp;dhm_server.P);</span><br><span class="line">    </span><br><span class="line">    mbedtls_mpi_read_string(&amp;dhm_client.P, <span class="number">16</span>, T_P);</span><br><span class="line">    mbedtls_mpi_read_string(&amp;dhm_client.G, <span class="number">10</span>, GENERATOR);</span><br><span class="line">    dhm_client.len = mbedtls_mpi_size(&amp;dhm_client.P);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ok\r\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. Server create a DHM key pair */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server creates a DHM key pair...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_make_public(&amp;dhm_server, <span class="number">256</span>, server_pub, <span class="keyword">sizeof</span>(server_pub), mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_make_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    dump_buf(server_pub, <span class="keyword">sizeof</span>(server_pub));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. Client creates a DHM key pair */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client create a DHM key pair...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_make_public(&amp;dhm_client, <span class="number">256</span>, client_pub, <span class="keyword">sizeof</span>(client_pub), mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_make_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    dump_buf(client_pub, <span class="keyword">sizeof</span>(client_pub));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. Server Read public key pair */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server Read public key pair...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_read_public(&amp;dhm_server, client_pub, <span class="keyword">sizeof</span>(client_pub));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_read_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. Client Read public key pair */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client Read public key pair...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_read_public(&amp;dhm_client, server_pub, <span class="keyword">sizeof</span>(server_pub));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_read_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> ); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 8. calc the shared secret */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server calc the shared secret...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_calc_secret(&amp;dhm_server, server_secret, <span class="keyword">sizeof</span>(server_secret), &amp;olen, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_calc_secret returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> ); </span><br><span class="line">    dump_buf(server_secret, <span class="keyword">sizeof</span>(server_secret));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 9. calc the shared secret */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client calc the shared secret...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_dhm_calc_secret(&amp;dhm_client, client_secret, <span class="keyword">sizeof</span>(client_secret), &amp;olen, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_dhm_calc_secret returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> ); </span><br><span class="line">    dump_buf(client_secret, <span class="keyword">sizeof</span>(client_secret));</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 10. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_dhm_free(&amp;dhm_server);</span><br><span class="line">    mbedtls_dhm_free(&amp;dhm_client);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_DHM_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-5">6.2.4 测试结果</h3><p>在 mian.c 中声明此测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_dhm_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>然后在main函数中调用测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 6. dh test */</span></span><br><span class="line">mbedtls_dhm_test();</span><br></pre></td></tr></table></figure>
<p>因为本实验内存消耗较大，需要加大堆空间：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200929152619282.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>编译、下载、测试结果如下。</p>
<p>① 服务端生成的公开参数：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200929152724594.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>② 客户端生成的公开参数（<strong>可以看到与服务端的公开参数不同</strong>）：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200929152750286.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>③ 服务端计算共享秘钥：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200929152846684.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>④ 客户端计算共享秘钥（<strong>可以看到与服务端相同</strong>）：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200929152907206.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h1 id="七、ECDH秘钥协商算法的配置与使用">7 七、ECDH秘钥协商算法的配置与使用</h1><h2 id="ECDH秘钥协商算法">7.1 ECDH秘钥协商算法</h2><p>ECDH是一种秘钥协商算法，使得通信双方在不安全通道交换共享参数，从而使用共享参数和自身私密参数计算出一个会话秘钥。</p>
<p>ECDH秘钥协商算法基于椭圆曲线密码系统（ECC），使用较短的秘钥长度可提供与RSA或DH算法同样的安全等级，<strong>秘钥长度为160-256bit的椭圆曲线算法，与1024-3072bit的非ECC算法安全强度相同</strong>。</p>
<p>ECDH秘钥协商的过程如下：</p>
<p>① 通信双方选择共同的椭圆曲线方程、相同的大素数P、相同的生成元G；</p>
<p>② 通信方A生成一个随机数作为自己的私钥，通过椭圆曲线标量乘法得到公开参数（公钥）；</p>
<p>③ 通信方B生成一个随机数作为自己的私钥，通过椭圆曲线标量乘法得到公开参数（公钥）；</p>
<p>④ 通信双方交换公钥，和自己的私钥一起计算得到共同的会话秘钥。</p>
<h2 id="ECDH秘钥协商功能的配置和使用">7.2 ECDH秘钥协商功能的配置和使用</h2><h3 id="配置宏-4">7.2.1 配置宏</h3><p>使用ECDH秘钥协商功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_ECP_C</td>
<td>开启椭圆曲线基础运算</td>
</tr>
<tr>
<td>MBEDTLS_ECDH_C</td>
<td>开启椭圆曲线秘钥协商算法模块</td>
</tr>
<tr>
<td>MBEDTLS_ECP_DP_SECP256R1_ENABLED</td>
<td>选择secp256r1曲线参数</td>
</tr>
</tbody></table>
<p>下面补充几个一个第一次出现宏的定义。</p>
<p>① <strong>MBEDTLS_ECP_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ECP_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the elliptic curve over GF(p) library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/ecp.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ecdh.c</span></span><br><span class="line"><span class="comment"> *          library/ecdsa.c</span></span><br><span class="line"><span class="comment"> *          library/ecjpake.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_BIGNUM_C and at least one MBEDTLS_ECP_DP_XXX_ENABLED</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_C</span></span><br></pre></td></tr></table></figure>
<p>② <strong>MBEDTLS_ECDH_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ECDH_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the elliptic curve Diffie-Hellman library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/ecdh.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ssl_cli.c</span></span><br><span class="line"><span class="comment"> *          library/ssl_srv.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is used by the following key exchanges:</span></span><br><span class="line"><span class="comment"> *      ECDHE-ECDSA, ECDHE-RSA, DHE-PSK</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_ECP_C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECDH_C</span></span><br></pre></td></tr></table></figure>
<p>③ <strong>MBEDTLS_ECP_DP_SECP256R1_ENABLED</strong>（至少开启一种）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ECP_DP_SECP192R1_ENABLED</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * MBEDTLS_ECP_XXXX_ENABLED: Enables specific curves within the Elliptic Curve</span></span><br><span class="line"><span class="comment"> * module.  By default all supported curves are enabled.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Comment macros to disable the curve and functions for it</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP192R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP224R1_ENABLED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP384R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP521R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP192K1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP224K1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_SECP256K1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_BP256R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_BP384R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_BP512R1_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_CURVE25519_ENABLED</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_ECP_DP_CURVE448_ENABLED</span></span><br></pre></td></tr></table></figure>
<p>编辑针对本实验的配置文件<code>mbedtls_config_ecdh.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_ECDH_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_ECDH_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECDH_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_ECDH_H_ */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="ECDH秘钥协商功能API说明">7.2.2 ECDH秘钥协商功能API说明</h3><p>① 初始化椭圆曲线群结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function initializes an ECP group context</span></span><br><span class="line"><span class="comment"> *                  without loading any domain parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            After this function is called, domain parameters</span></span><br><span class="line"><span class="comment"> *                  for various ECP groups can be loaded through the</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_group_load() or mbedtls_ecp_tls_read_group()</span></span><br><span class="line"><span class="comment"> *                  functions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecp_group_init</span><span class="params">( mbedtls_ecp_group *grp )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 初始化椭圆曲线点结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function initializes an ECP group context</span></span><br><span class="line"><span class="comment"> *                  without loading any domain parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            After this function is called, domain parameters</span></span><br><span class="line"><span class="comment"> *                  for various ECP groups can be loaded through the</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_group_load() or mbedtls_ecp_tls_read_group()</span></span><br><span class="line"><span class="comment"> *                  functions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecp_group_init</span><span class="params">( mbedtls_ecp_group *grp )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 加载椭圆曲线：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function sets up an ECP group context</span></span><br><span class="line"><span class="comment"> *                  from a standardized set of domain parameters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            The index should be a value of the NamedCurve enum,</span></span><br><span class="line"><span class="comment"> *                  as defined in &lt;em&gt;RFC-4492: Elliptic Curve Cryptography</span></span><br><span class="line"><span class="comment"> *                  (ECC) Cipher Suites for Transport Layer Security (TLS)&lt;/em&gt;,</span></span><br><span class="line"><span class="comment"> *                  usually in the form of an \c MBEDTLS_ECP_DP_XXX macro.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The group context to setup. This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param id        The identifier of the domain parameter set to load.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          #MBEDTLS_ERR_ECP_FEATURE_UNAVAILABLE if \p id doesn&#x27;t</span></span><br><span class="line"><span class="comment"> *                  correspond to a known group.</span></span><br><span class="line"><span class="comment"> * \return          Another negative error code on other kinds of failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecp_group_load</span><span class="params">( mbedtls_ecp_group *grp, mbedtls_ecp_group_id id )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 生成公开参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function generates an ECDH keypair on an elliptic</span></span><br><span class="line"><span class="comment"> *                  curve.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                  This function performs the first of two core computations</span></span><br><span class="line"><span class="comment"> *                  implemented during the ECDH key exchange. The second core</span></span><br><span class="line"><span class="comment"> *                  computation is performed by mbedtls_ecdh_compute_shared().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see             ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The ECP group to use. This must be initialized and have</span></span><br><span class="line"><span class="comment"> *                  domain parameters loaded, for example through</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_load() or mbedtls_ecp_tls_read_group().</span></span><br><span class="line"><span class="comment"> * \param d         The destination MPI (private key).</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param Q         The destination point (public key).</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param f_rng     The RNG function to use. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng     The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                  \c NULL in case \p f_rng doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          Another \c MBEDTLS_ERR_ECP_XXX or</span></span><br><span class="line"><span class="comment"> *                  \c MBEDTLS_MPI_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdh_gen_public</span><span class="params">( mbedtls_ecp_group *grp, mbedtls_mpi *d, mbedtls_ecp_point *Q,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 计算共享秘钥：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function computes the shared secret.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                  This function performs the second of two core computations</span></span><br><span class="line"><span class="comment"> *                  implemented during the ECDH key exchange. The first core</span></span><br><span class="line"><span class="comment"> *                  computation is performed by mbedtls_ecdh_gen_public().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see             ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            If \p f_rng is not NULL, it is used to implement</span></span><br><span class="line"><span class="comment"> *                  countermeasures against side-channel attacks.</span></span><br><span class="line"><span class="comment"> *                  For more information, see mbedtls_ecp_mul().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The ECP group to use. This must be initialized and have</span></span><br><span class="line"><span class="comment"> *                  domain parameters loaded, for example through</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_load() or mbedtls_ecp_tls_read_group().</span></span><br><span class="line"><span class="comment"> * \param z         The destination MPI (shared secret).</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param Q         The public key from another party.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param d         Our secret exponent (private key).</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param f_rng     The RNG function. This may be \c NULL if randomization</span></span><br><span class="line"><span class="comment"> *                  of intermediate results during the ECP computations is</span></span><br><span class="line"><span class="comment"> *                  not needed (discouraged). See the documentation of</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecp_mul() for more.</span></span><br><span class="line"><span class="comment"> * \param p_rng     The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                  \c NULL if \p f_rng is \c NULL or doesn&#x27;t need a</span></span><br><span class="line"><span class="comment"> *                  context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          Another \c MBEDTLS_ERR_ECP_XXX or</span></span><br><span class="line"><span class="comment"> *                  \c MBEDTLS_MPI_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdh_compute_shared</span><span class="params">( mbedtls_ecp_group *grp, mbedtls_mpi *z,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">const</span> mbedtls_ecp_point *Q, <span class="keyword">const</span> mbedtls_mpi *d,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑥ 释放椭圆曲线群结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function frees the components of an ECP group.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The group to free. This may be \c NULL, in which</span></span><br><span class="line"><span class="comment"> *                  case this function returns immediately. If it is not</span></span><br><span class="line"><span class="comment"> *                  \c NULL, it must point to an initialized ECP group.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecp_group_free</span><span class="params">( mbedtls_ecp_group *grp )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑦ 释放椭圆曲线点结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function frees the components of a point.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param pt        The point to free.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecp_point_free</span><span class="params">( mbedtls_ecp_point *pt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑧ 错误码（ECP计算部分）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ECP error codes</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_BAD_INPUT_DATA                    -0x4F80  <span class="comment">/**&lt; Bad input parameters to function. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_BUFFER_TOO_SMALL                  -0x4F00  <span class="comment">/**&lt; The buffer is too small to write to. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_FEATURE_UNAVAILABLE               -0x4E80  <span class="comment">/**&lt; The requested feature is not available, for example, the requested curve is not supported. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_VERIFY_FAILED                     -0x4E00  <span class="comment">/**&lt; The signature is not valid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_ALLOC_FAILED                      -0x4D80  <span class="comment">/**&lt; Memory allocation failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_RANDOM_FAILED                     -0x4D00  <span class="comment">/**&lt; Generation of random value, such as ephemeral key, failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_INVALID_KEY                       -0x4C80  <span class="comment">/**&lt; Invalid private or public key. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_SIG_LEN_MISMATCH                  -0x4C00  <span class="comment">/**&lt; The buffer contains a valid signature followed by more data. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* MBEDTLS_ERR_ECP_HW_ACCEL_FAILED is deprecated and should not be used. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_HW_ACCEL_FAILED                   -0x4B80  <span class="comment">/**&lt; The ECP hardware accelerator failed. */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_ECP_IN_PROGRESS                       -0x4B00  <span class="comment">/**&lt; Operation in progress, call again with the same parameters to continue. */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-4">7.2.3 编写测试函数</h3><p>新建测试文件<code>mbedtls_ecdh_test.c</code>，编写以下测试内容，其中服务器和客户端之间直接通信，没有采用网络通信：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_ECDH_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ecdh.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERATOR   <span class="meta-string">&quot;2&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> T_P          <span class="meta-string">&quot;FFFFFFFFFFFFFFFFADF85458A2BB4A9AAFDC5620273D3CF1D8B9C583CE2D3695&quot;</span> \</span></span><br><span class="line">                     <span class="string">&quot;A9E13641146433FBCC939DCE249B3EF97D2FE363630C75D8F681B202AEC4617A&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;D3DF1ED5D5FD65612433F51F5F066ED0856365553DED1AF3B557135E7F57C935&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;984F0C70E0E68B77E2A689DAF3EFE8721DF158A136ADE73530ACCA4F483A797A&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;BC0AB182B324FB61D108A94BB2C8E3FBB96ADAB760D7F4681D4F42A3DE394DF4&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;AE56EDE76372BB190B07A7C8EE0A6D709E02FCE1CDF7E2ECC03404CD28342F61&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;9172FE9CE98583FF8E4F1232EEF28183C3FE3B1B4C6FAD733BB5FCBC2EC22005&quot;</span>\</span><br><span class="line">                     <span class="string">&quot;C58EF1837D1683B2C6F34A26C1B2EFFA886B423861285C97FFFFFFFFFFFFFFFF&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> buf[<span class="number">65</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdh_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;ecdh_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_ecp_point client_pub, server_pub;</span><br><span class="line">    mbedtls_ecp_group grp;</span><br><span class="line">    mbedtls_mpi client_secret, server_secret;</span><br><span class="line">    mbedtls_mpi client_pri, server_pri;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_mpi_init(&amp;client_secret);</span><br><span class="line">    mbedtls_mpi_init(&amp;server_secret);</span><br><span class="line">    mbedtls_mpi_init(&amp;client_pri);</span><br><span class="line">    mbedtls_mpi_init(&amp;server_pri);</span><br><span class="line">    mbedtls_ecp_group_init(&amp;grp);</span><br><span class="line">    mbedtls_ecp_point_init(&amp;client_pub);</span><br><span class="line">    mbedtls_ecp_point_init(&amp;server_pub);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3.  select ecp group SECP256R1 */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Select ecp group SECP256R1...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecp_group_load(&amp;grp, MBEDTLS_ECP_DP_SECP256R1);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecp_group_load returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ok\r\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. Client generate public parameter */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client Generate public parameter...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdh_gen_public(&amp;grp, &amp;client_pri, &amp;client_pub, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdh_gen_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show public parameter */</span></span><br><span class="line">    mbedtls_ecp_point_write_binary(&amp;grp, &amp;client_pub, MBEDTLS_ECP_PF_UNCOMPRESSED, &amp;olen, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dump_buf(buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. Client generate public parameter */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server Generate public parameter...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdh_gen_public(&amp;grp, &amp;server_pri, &amp;server_pub, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdh_gen_public returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show public parameter */</span></span><br><span class="line">    mbedtls_ecp_point_write_binary(&amp;grp, &amp;server_pub, MBEDTLS_ECP_PF_UNCOMPRESSED, &amp;olen, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dump_buf(buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. Calc shared secret */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Client Calc shared secret...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdh_compute_shared(&amp;grp, &amp;client_secret, &amp;server_pub, &amp;client_pri, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdh_compute_shared returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show public parameter */</span></span><br><span class="line">    mbedtls_mpi_write_binary(&amp;client_secret, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dump_buf(buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. Server Calc shared secret */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  . Server Calc shared secret...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdh_compute_shared(&amp;grp, &amp;server_secret, &amp;client_pub, &amp;server_pri, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdh_compute_shared returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show public parameter */</span></span><br><span class="line">    mbedtls_mpi_write_binary(&amp;server_secret, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dump_buf(buf, olen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 8. mpi compare */</span></span><br><span class="line">    ret = mbedtls_mpi_cmp_mpi(&amp;server_secret, &amp;client_secret);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;compare result: %d\r\n&quot;</span>, ret);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 10. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_mpi_free(&amp;client_secret);</span><br><span class="line">    mbedtls_mpi_free(&amp;server_secret);</span><br><span class="line">    mbedtls_mpi_free(&amp;client_pri);</span><br><span class="line">    mbedtls_mpi_free(&amp;server_pri);</span><br><span class="line">    mbedtls_ecp_group_free(&amp;grp);</span><br><span class="line">    mbedtls_ecp_point_free(&amp;client_pub);</span><br><span class="line">    mbedtls_ecp_point_free(&amp;server_pub);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_DHM_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="调用测试函数">7.2.4 调用测试函数</h3><p>在 main.c 中声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_ecdh_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在 main 函数中调用此测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 7. ecdh test */</span></span><br><span class="line">mbedtls_ecdh_test();</span><br></pre></td></tr></table></figure>
<p>编译、下载、在串口助手查看结果：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20200930161558673.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h1 id="八、数字签名算法的配置与使用（RSA数字签名算法、ECDSA数字签名算法）">8 八、数字签名算法的配置与使用（RSA数字签名算法、ECDSA数字签名算法）</h1><h2 id="数字签名算法">8.1 数字签名算法</h2><h3 id="什么是数字签名">8.1.1 什么是数字签名</h3><p>数字签名类似于盖章和签字，数字签名可以检查消息是否被篡改、并验证消息的可靠性，因为私钥只有签名者持有，所以还可以防止否认。</p>
<h3 id="数字签名算法-1">8.1.2 数字签名算法</h3><p>① <strong>RSA数字签名</strong></p>
<p>RSA数字签名算法基于RSA非对称加密算法，在用于数字签名时公钥和私钥的用法刚好相反：</p>
<ul>
<li>发送方使用私钥对消息执行加密操作 = 对消息进行签名；</li>
<li>接收方使用公钥对签名进行解密 = 对签名进行认证；</li>
</ul>
<p>RSA签名算法还需要包括填充方法，有两种：PKCS1-V1.5和PSS（使用随机数填充，<strong>推荐使用</strong>）。</p>
<p>② <strong>DSA算法</strong></p>
<p>③ <strong>ECDSA算法</strong></p>
<p>在相同的安全等级下，ECDSA算法具有秘钥短、执行效率高的特点，更适合物联网应用。</p>
<h2 id="RSA数字签名功能模块的配置与使用">8.2 RSA数字签名功能模块的配置与使用</h2><h3 id="配置宏-5">8.2.1 配置宏</h3><p>使用RSA功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_GENPRIME</td>
<td>开启生成素数</td>
</tr>
<tr>
<td>MBEDTLS_OID_C</td>
<td>开启OID数据结构模块</td>
</tr>
<tr>
<td>MBEDTLS_RSA_C</td>
<td>开启RSA算法</td>
</tr>
<tr>
<td>MBEDTLS_PKCS1_V21</td>
<td>开启PKCS#1 v2.1填充方案（OAEP）</td>
</tr>
</tbody></table>
<p>新建配置文件<code>mbedtls_config_rsa_sign.h</code>，编写以下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_RSA_SIGN_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_RSA_SIGN_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_GENPRIME</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_OID_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_RSA_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PKCS1_V21</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_RSA_SIGN_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK中设置使用该配置文件：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003110740288.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h3 id="RSA数字签名功能模块API说明">8.2.2 RSA数字签名功能模块API说明</h3><p>使用该功能模块需要包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/rsa.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① RSA签名接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function performs a private RSA operation to sign</span></span><br><span class="line"><span class="comment"> *                 a message digest using PKCS#1.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 It is the generic wrapper for performing a PKCS#1</span></span><br><span class="line"><span class="comment"> *                 signature using the \p mode from the context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The \p sig buffer must be as large as the size</span></span><br><span class="line"><span class="comment"> *                 of \p ctx-&gt;N. For example, 128 Bytes if RSA-1024 is used.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           For PKCS#1 v2.1 encoding, see comments on</span></span><br><span class="line"><span class="comment"> *                 mbedtls_rsa_rsassa_pss_sign() for details on</span></span><br><span class="line"><span class="comment"> *                 \p md_alg and \p hash_id.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \deprecated     It is deprecated and discouraged to call this function</span></span><br><span class="line"><span class="comment"> *                 in #MBEDTLS_RSA_PUBLIC mode. Future versions of the library</span></span><br><span class="line"><span class="comment"> *                 are likely to remove the \p mode argument and have it</span></span><br><span class="line"><span class="comment"> *                 implicitly set to #MBEDTLS_RSA_PRIVATE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Alternative implementations of RSA need not support</span></span><br><span class="line"><span class="comment"> *                 mode being set to #MBEDTLS_RSA_PUBLIC and might instead</span></span><br><span class="line"><span class="comment"> *                 return #MBEDTLS_ERR_PLATFORM_FEATURE_UNSUPPORTED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA context to use.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function to use. If the padding mode is PKCS#1 v2.1,</span></span><br><span class="line"><span class="comment"> *                 this must be provided. If the padding mode is PKCS#1 v1.5 and</span></span><br><span class="line"><span class="comment"> *                 \p mode is #MBEDTLS_RSA_PRIVATE, it is used for blinding</span></span><br><span class="line"><span class="comment"> *                 and should be provided; see mbedtls_rsa_private() for more</span></span><br><span class="line"><span class="comment"> *                 more. It is ignored otherwise.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be \c NULL</span></span><br><span class="line"><span class="comment"> *                 if \p f_rng is \c NULL or doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> * \param mode     The mode of operation. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PRIVATE or #MBEDTLS_RSA_PUBLIC (deprecated).</span></span><br><span class="line"><span class="comment"> * \param md_alg   The message-digest algorithm used to hash the original data.</span></span><br><span class="line"><span class="comment"> *                 Use #MBEDTLS_MD_NONE for signing raw data.</span></span><br><span class="line"><span class="comment"> * \param hashlen  The length of the message digest.</span></span><br><span class="line"><span class="comment"> *                 Ths is only used if \p md_alg is #MBEDTLS_MD_NONE.</span></span><br><span class="line"><span class="comment"> * \param hash     The buffer holding the message digest or raw data.</span></span><br><span class="line"><span class="comment"> *                 If \p md_alg is #MBEDTLS_MD_NONE, this must be a readable</span></span><br><span class="line"><span class="comment"> *                 buffer of length \p hashlen Bytes. If \p md_alg is not</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_MD_NONE, it must be a readable buffer of length</span></span><br><span class="line"><span class="comment"> *                 the size of the hash corresponding to \p md_alg.</span></span><br><span class="line"><span class="comment"> * \param sig      The buffer to hold the signature. This must be a writable</span></span><br><span class="line"><span class="comment"> *                 buffer of length \c ctx-&gt;len Bytes. For example, \c 256 Bytes</span></span><br><span class="line"><span class="comment"> *                 for an 2048-bit RSA modulus. A buffer length of</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_MPI_MAX_SIZE is always safe.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 if the signing operation was successful.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_pkcs1_sign</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">int</span> mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">mbedtls_md_type_t</span> md_alg,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> hashlen,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *hash,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">char</span> *sig )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② RSA验证签名接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function performs a public RSA operation and checks</span></span><br><span class="line"><span class="comment"> *                 the message digest.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 This is the generic wrapper for performing a PKCS#1</span></span><br><span class="line"><span class="comment"> *                 verification using the mode from the context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           For PKCS#1 v2.1 encoding, see comments on</span></span><br><span class="line"><span class="comment"> *                 mbedtls_rsa_rsassa_pss_verify() about \p md_alg and</span></span><br><span class="line"><span class="comment"> *                 \p hash_id.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \deprecated     It is deprecated and discouraged to call this function</span></span><br><span class="line"><span class="comment"> *                 in #MBEDTLS_RSA_PRIVATE mode. Future versions of the library</span></span><br><span class="line"><span class="comment"> *                 are likely to remove the \p mode argument and have it</span></span><br><span class="line"><span class="comment"> *                 set to #MBEDTLS_RSA_PUBLIC.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Alternative implementations of RSA need not support</span></span><br><span class="line"><span class="comment"> *                 mode being set to #MBEDTLS_RSA_PRIVATE and might instead</span></span><br><span class="line"><span class="comment"> *                 return #MBEDTLS_ERR_PLATFORM_FEATURE_UNSUPPORTED.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The initialized RSA public key context to use.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function to use. If \p mode is #MBEDTLS_RSA_PRIVATE,</span></span><br><span class="line"><span class="comment"> *                 this is used for blinding and should be provided; see</span></span><br><span class="line"><span class="comment"> *                 mbedtls_rsa_private() for more. Otherwise, it is ignored.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                 \c NULL if \p f_rng is \c NULL or doesn&#x27;t need a context.</span></span><br><span class="line"><span class="comment"> * \param mode     The mode of operation. This must be either</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_RSA_PUBLIC or #MBEDTLS_RSA_PRIVATE (deprecated).</span></span><br><span class="line"><span class="comment"> * \param md_alg   The message-digest algorithm used to hash the original data.</span></span><br><span class="line"><span class="comment"> *                 Use #MBEDTLS_MD_NONE for signing raw data.</span></span><br><span class="line"><span class="comment"> * \param hashlen  The length of the message digest.</span></span><br><span class="line"><span class="comment"> *                 This is only used if \p md_alg is #MBEDTLS_MD_NONE.</span></span><br><span class="line"><span class="comment"> * \param hash     The buffer holding the message digest or raw data.</span></span><br><span class="line"><span class="comment"> *                 If \p md_alg is #MBEDTLS_MD_NONE, this must be a readable</span></span><br><span class="line"><span class="comment"> *                 buffer of length \p hashlen Bytes. If \p md_alg is not</span></span><br><span class="line"><span class="comment"> *                 #MBEDTLS_MD_NONE, it must be a readable buffer of length</span></span><br><span class="line"><span class="comment"> *                 the size of the hash corresponding to \p md_alg.</span></span><br><span class="line"><span class="comment"> * \param sig      The buffer holding the signature. This must be a readable</span></span><br><span class="line"><span class="comment"> *                 buffer of length \c ctx-&gt;len Bytes. For example, \c 256 Bytes</span></span><br><span class="line"><span class="comment"> *                 for an 2048-bit RSA modulus.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 if the verify operation was successful.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_RSA_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_pkcs1_verify</span><span class="params">( mbedtls_rsa_context *ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">void</span> *p_rng,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">mbedtls_md_type_t</span> md_alg,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">unsigned</span> <span class="keyword">int</span> hashlen,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *hash,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *sig )</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-5">8.2.3 编写测试函数</h3><p>新建文件<code>mbedtls_rsa_sign_test.c</code>，编写以下测试内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_RSA_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/rsa.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">516</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_rsa_key</span><span class="params">(mbedtls_rsa_context *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> olen;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  +++++++++++++++++ rsa keypair +++++++++++++++++\n\n&quot;</span>);</span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;N , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;N: %s\n&quot;</span>, buf); </span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;E , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;E: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;D , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;D: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;P , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;P: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;Q , <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Q: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;DP, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DP: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;DQ, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DQ: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    mbedtls_mpi_write_string(&amp;ctx-&gt;QP, <span class="number">16</span>, buf, <span class="keyword">sizeof</span>(buf), &amp;olen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;QP: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n  +++++++++++++++++ rsa keypair +++++++++++++++++\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint8_t</span> output_buf[<span class="number">2048</span>/<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_rsa_sign_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* msg = <span class="string">&quot;HelloWorld&quot;</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;rsa_sign_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_rsa_context ctx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_rsa_init(&amp;ctx, MBEDTLS_RSA_PKCS_V21, MBEDTLS_MD_SHA256);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3. generate an RSA keypair */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Generate RSA keypair...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_gen_key(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, <span class="number">2048</span>, <span class="number">65537</span>);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_gen_key returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* shwo RSA keypair */</span></span><br><span class="line">    dump_rsa_key(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. sign */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . RSA pkcs1 sign...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_pkcs1_sign(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, MBEDTLS_RSA_PRIVATE, MBEDTLS_MD_SHA256, <span class="built_in">strlen</span>(msg), (<span class="keyword">uint8_t</span> *)msg, output_buf);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_pkcs1_sign returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show sign result */</span></span><br><span class="line">    dump_buf(output_buf, <span class="keyword">sizeof</span>(output_buf));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. verify sign*/</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . RSA pkcs1 verify...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_rsa_pkcs1_verify(&amp;ctx, mbedtls_ctr_drbg_random, &amp;ctr_drbg, MBEDTLS_RSA_PUBLIC, MBEDTLS_MD_SHA256, <span class="built_in">strlen</span>(msg), (<span class="keyword">uint8_t</span> *)msg, output_buf);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_rsa_pkcs1_encrypt returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_rsa_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_RSA_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-6">8.2.4 测试结果</h3><p>在main.c中声明该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_rsa_sign_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在main函数中调用该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 8. rsa sign test */</span></span><br><span class="line">mbedtls_rsa_sign_test();</span><br></pre></td></tr></table></figure>
<p>编译、下载，在串口助手中查看测试结果：</p>
<p>① 生成秘钥对成功（需要几min的时间）：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003113344994.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>② 生成签名和验证签名成功：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003113416619.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h2 id="ECDSA数字签名功能模块的配置与使用">8.3 ECDSA数字签名功能模块的配置与使用</h2><h3 id="配置宏-6">8.3.1 配置宏</h3><p>使用ECDSA秘钥协商功能需要提前开启伪随机数生成器（依赖AES算法、SHA256算法、MD通用接口），其中伪随机数生成器的硬件适配移植实现已经讲述，请参考对应的第二篇博客，不再赘述。</p>
<p>综合上述，本实验中需要开启的宏如下表：</p>
<table>
<thead>
<tr>
<th>宏定义</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</td>
<td>不使用默认熵源<strong>（如果已有、要屏蔽该宏）</strong></td>
</tr>
<tr>
<td>MBEDTLS_NO_PLATFORM_ENTROPY</td>
<td>不使用系统内置熵源</td>
</tr>
<tr>
<td>MBEDTLS_AES_C</td>
<td>使用AES算法</td>
</tr>
<tr>
<td>MBEDTLS_ENTROPY_C</td>
<td>使能熵源模块</td>
</tr>
<tr>
<td>MBEDTLS_CTR_DRBG_C</td>
<td>使能随机数模块</td>
</tr>
<tr>
<td>MBEDTLS_SHA256_C</td>
<td>使能SHA256算法</td>
</tr>
<tr>
<td>MBEDTLS_MD_C</td>
<td>开启MD通用接口</td>
</tr>
<tr>
<td>MBEDTLS_AES_ROM_TABLES</td>
<td>使能预定义S盒（节约内存空间）</td>
</tr>
<tr>
<td>MBEDTLS_BIGNUM_C</td>
<td>开启大数运算</td>
</tr>
<tr>
<td>MBEDTLS_ECP_C</td>
<td>开启椭圆曲线基础运算</td>
</tr>
<tr>
<td>MBEDTLS_ECP_DP_SECP256R1_ENABLED</td>
<td>选择secp256r1曲线参数</td>
</tr>
<tr>
<td>MBEDTLS_ECDSA_C</td>
<td>开启ECDSA算法</td>
</tr>
<tr>
<td>MBEDTLS_ASN1_WRITE_C</td>
<td>开启ASN1格式写入</td>
</tr>
<tr>
<td>MBEDTLS_ASN1_PARSE_C</td>
<td>开启ASN1结构解析</td>
</tr>
</tbody></table>
<p>下面补充几个一个第一次出现宏的定义。</p>
<p>① <strong>MBEDTLS_ECDSA_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ECDSA_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the elliptic curve DSA library.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/ecdsa.c</span></span><br><span class="line"><span class="comment"> * Caller:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This module is used by the following key exchanges:</span></span><br><span class="line"><span class="comment"> *      ECDHE-ECDSA</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Requires: MBEDTLS_ECP_C, MBEDTLS_ASN1_WRITE_C, MBEDTLS_ASN1_PARSE_C</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECDSA_C</span></span><br></pre></td></tr></table></figure>
<p>② <strong>MBEDTLS_ASN1_WRITE_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ASN1_WRITE_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the generic ASN1 writer.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/asn1write.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/ecdsa.c</span></span><br><span class="line"><span class="comment"> *          library/pkwrite.c</span></span><br><span class="line"><span class="comment"> *          library/x509_create.c</span></span><br><span class="line"><span class="comment"> *          library/x509write_crt.c</span></span><br><span class="line"><span class="comment"> *          library/x509write_csr.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span></span><br></pre></td></tr></table></figure>
<p>③ <strong>MBEDTLS_ASN1_PARSE_C</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \def MBEDTLS_ASN1_PARSE_C</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Enable the generic ASN1 parser.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Module:  library/asn1.c</span></span><br><span class="line"><span class="comment"> * Caller:  library/x509.c</span></span><br><span class="line"><span class="comment"> *          library/dhm.c</span></span><br><span class="line"><span class="comment"> *          library/pkcs12.c</span></span><br><span class="line"><span class="comment"> *          library/pkcs5.c</span></span><br><span class="line"><span class="comment"> *          library/pkparse.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>新建配置文件<code>mbedtls_config_ecdsa.h</code>，编写以下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_ECDSA_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_ECDSA_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_AES_ROM_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_CTR_DRBG_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECP_DP_SECP256R1_ENABLED</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ECDSA_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_ECDSA_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK中配置使用该配置文件：<img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003170538611.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h3 id="ECDSA签名功能API说明">8.3.2 ECDSA签名功能API说明</h3><p>① 初始化ECDSA结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function initializes an ECDSA context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx       The ECDSA context to initialize.</span></span><br><span class="line"><span class="comment"> *                  This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecdsa_init</span><span class="params">( mbedtls_ecdsa_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② ECDSA生成秘钥接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          This function generates an ECDSA keypair on the given curve.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see            ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx      The ECDSA context to store the keypair in.</span></span><br><span class="line"><span class="comment"> *                 This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param gid      The elliptic curve to use. One of the various</span></span><br><span class="line"><span class="comment"> *                 \c MBEDTLS_ECP_DP_XXX macros depending on configuration.</span></span><br><span class="line"><span class="comment"> * \param f_rng    The RNG function to use. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng    The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                 \c NULL if \p f_rng doesn&#x27;t need a context argument.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return         An \c MBEDTLS_ERR_ECP_XXX code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdsa_genkey</span><span class="params">( mbedtls_ecdsa_context *ctx, mbedtls_ecp_group_id gid,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>), <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ ECDSA签名接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function computes the ECDSA signature of a</span></span><br><span class="line"><span class="comment"> *                  previously-hashed message.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            The deterministic version implemented in</span></span><br><span class="line"><span class="comment"> *                  mbedtls_ecdsa_sign_det() is usually preferred.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            If the bitlength of the message hash is larger than the</span></span><br><span class="line"><span class="comment"> *                  bitlength of the group order, then the hash is truncated</span></span><br><span class="line"><span class="comment"> *                  as defined in &lt;em&gt;Standards for Efficient Cryptography Group</span></span><br><span class="line"><span class="comment"> *                  (SECG): SEC1 Elliptic Curve Cryptography&lt;/em&gt;, section</span></span><br><span class="line"><span class="comment"> *                  4.1.3, step 5.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see             ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The context for the elliptic curve to use.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized and have group parameters</span></span><br><span class="line"><span class="comment"> *                  set, for example through mbedtls_ecp_group_load().</span></span><br><span class="line"><span class="comment"> * \param r         The MPI context in which to store the first part</span></span><br><span class="line"><span class="comment"> *                  the signature. This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param s         The MPI context in which to store the second part</span></span><br><span class="line"><span class="comment"> *                  the signature. This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param d         The private signing key. This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param buf       The content to be signed. This is usually the hash of</span></span><br><span class="line"><span class="comment"> *                  the original data to be signed. This must be a readable</span></span><br><span class="line"><span class="comment"> *                  buffer of length \p blen Bytes. It may be \c NULL if</span></span><br><span class="line"><span class="comment"> *                  \p blen is zero.</span></span><br><span class="line"><span class="comment"> * \param blen      The length of \p buf in Bytes.</span></span><br><span class="line"><span class="comment"> * \param f_rng     The RNG function. This must not be \c NULL.</span></span><br><span class="line"><span class="comment"> * \param p_rng     The RNG context to be passed to \p f_rng. This may be</span></span><br><span class="line"><span class="comment"> *                  \c NULL if \p f_rng doesn&#x27;t need a context parameter.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          An \c MBEDTLS_ERR_ECP_XXX</span></span><br><span class="line"><span class="comment"> *                  or \c MBEDTLS_MPI_XXX error code on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdsa_sign</span><span class="params">( mbedtls_ecp_group *grp, mbedtls_mpi *r, mbedtls_mpi *s,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">const</span> mbedtls_mpi *d, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> blen,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">int</span> (*f_rng)(<span class="keyword">void</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">size_t</span>), <span class="keyword">void</span> *p_rng )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ ECDSA验证签名接口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function verifies the ECDSA signature of a</span></span><br><span class="line"><span class="comment"> *                  previously-hashed message.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note            If the bitlength of the message hash is larger than the</span></span><br><span class="line"><span class="comment"> *                  bitlength of the group order, then the hash is truncated as</span></span><br><span class="line"><span class="comment"> *                  defined in &lt;em&gt;Standards for Efficient Cryptography Group</span></span><br><span class="line"><span class="comment"> *                  (SECG): SEC1 Elliptic Curve Cryptography&lt;/em&gt;, section</span></span><br><span class="line"><span class="comment"> *                  4.1.4, step 3.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \see             ecp.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param grp       The ECP group to use.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized and have group parameters</span></span><br><span class="line"><span class="comment"> *                  set, for example through mbedtls_ecp_group_load().</span></span><br><span class="line"><span class="comment"> * \param buf       The hashed content that was signed. This must be a readable</span></span><br><span class="line"><span class="comment"> *                  buffer of length \p blen Bytes. It may be \c NULL if</span></span><br><span class="line"><span class="comment"> *                  \p blen is zero.</span></span><br><span class="line"><span class="comment"> * \param blen      The length of \p buf in Bytes.</span></span><br><span class="line"><span class="comment"> * \param Q         The public key to use for verification. This must be</span></span><br><span class="line"><span class="comment"> *                  initialized and setup.</span></span><br><span class="line"><span class="comment"> * \param r         The first integer of the signature.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> * \param s         The second integer of the signature.</span></span><br><span class="line"><span class="comment"> *                  This must be initialized.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return          \c 0 on success.</span></span><br><span class="line"><span class="comment"> * \return          #MBEDTLS_ERR_ECP_BAD_INPUT_DATA if the signature</span></span><br><span class="line"><span class="comment"> *                  is invalid.</span></span><br><span class="line"><span class="comment"> * \return          An \c MBEDTLS_ERR_ECP_XXX or \c MBEDTLS_MPI_XXX</span></span><br><span class="line"><span class="comment"> *                  error code on failure for any other reason.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdsa_verify</span><span class="params">( mbedtls_ecp_group *grp,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> blen,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> mbedtls_ecp_point *Q, <span class="keyword">const</span> mbedtls_mpi *r,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> mbedtls_mpi *s)</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 释放ECDSA结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief           This function frees an ECDSA context.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param ctx       The ECDSA context to free. This may be \c NULL,</span></span><br><span class="line"><span class="comment"> *                  in which case this function does nothing. If it</span></span><br><span class="line"><span class="comment"> *                  is not \c NULL, it must be initialized.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_ecdsa_free</span><span class="params">( mbedtls_ecdsa_context *ctx )</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-6">8.3.3 编写测试函数</h3><p>新建文件<code>mbedtls_ecdsa_test</code>，编写以下测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_ECDSA_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/entropy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ctr_drbg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/ecdsa.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span> buf[<span class="number">97</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dump_buf</span><span class="params">(<span class="keyword">uint8_t</span> *buf, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s%02X%s&quot;</span>, i % <span class="number">16</span> == <span class="number">0</span> ? <span class="string">&quot;\r\n\t&quot;</span> : <span class="string">&quot; &quot;</span>, </span><br><span class="line">                           buf[i], </span><br><span class="line">                           i == len - <span class="number">1</span> ? <span class="string">&quot;\r\n&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_ecdsa_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">size_t</span> qlen, dlen;</span><br><span class="line">    <span class="keyword">size_t</span> rlen, slen;</span><br><span class="line">    <span class="keyword">uint8_t</span> hash[<span class="number">32</span>];</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *msg  = <span class="string">&quot;HelloWorld&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *pers = <span class="string">&quot;ecdsa_test&quot;</span>;</span><br><span class="line">    mbedtls_entropy_context entropy;</span><br><span class="line">    mbedtls_ctr_drbg_context ctr_drbg;</span><br><span class="line">    mbedtls_mpi r, s;</span><br><span class="line">    mbedtls_ecdsa_context ctx;</span><br><span class="line">    <span class="keyword">mbedtls_md_context_t</span> md_ctx;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_md_init(&amp;md_ctx);</span><br><span class="line">    mbedtls_entropy_init(&amp;entropy);</span><br><span class="line">    mbedtls_ctr_drbg_init(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_mpi_init(&amp;r);</span><br><span class="line">    mbedtls_mpi_init(&amp;s);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. update seed with we own interface ported */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Seeding the random number generator...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ctr_drbg_seed( &amp;ctr_drbg, mbedtls_entropy_func, &amp;entropy,</span><br><span class="line">                               (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *) pers,</span><br><span class="line">                               <span class="built_in">strlen</span>(pers));</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ctr_drbg_seed returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 3. hash message */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Hash message...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_md(mbedtls_md_info_from_type(MBEDTLS_MD_SHA256), (<span class="keyword">uint8_t</span> *)msg, <span class="built_in">strlen</span>(msg), hash);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_md returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show hash */</span></span><br><span class="line">    dump_buf(hash, <span class="keyword">sizeof</span>(hash));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 4. generate keypair */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Generate ecdsa keypair...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdsa_genkey(&amp;ctx, MBEDTLS_ECP_DP_SECP256R1, mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdsa_genkey returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show keypair */</span></span><br><span class="line">    mbedtls_ecp_point_write_binary(&amp;ctx.grp, &amp;ctx.Q, MBEDTLS_ECP_PF_UNCOMPRESSED, &amp;qlen, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    dlen = mbedtls_mpi_size(&amp;ctx.d);</span><br><span class="line">    mbedtls_mpi_write_binary(&amp;ctx.d, buf + qlen, dlen);</span><br><span class="line">    dump_buf(buf, qlen + dlen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 5. ecdsa sign */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . ECDSA sign...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdsa_sign(&amp;ctx.grp, &amp;r, &amp;s, &amp;ctx.d, hash, <span class="keyword">sizeof</span>(hash), mbedtls_ctr_drbg_random, &amp;ctr_drbg);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdsa_sign returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* show sign */</span></span><br><span class="line">    rlen = mbedtls_mpi_size(&amp;r);</span><br><span class="line">    slen = mbedtls_mpi_size(&amp;s);</span><br><span class="line">    mbedtls_mpi_write_binary(&amp;r, buf, rlen);</span><br><span class="line">    mbedtls_mpi_write_binary(&amp;s, buf + rlen, slen);</span><br><span class="line">    dump_buf(buf, rlen + slen);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 6. ecdsa verify */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . ECDSA verify...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_ecdsa_verify(&amp;ctx.grp, hash, <span class="keyword">sizeof</span>(hash), &amp;ctx.Q, &amp;r, &amp;s);</span><br><span class="line">    <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_ecdsa_verify returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 7. release structure */</span></span><br><span class="line">    mbedtls_ctr_drbg_free(&amp;ctr_drbg);</span><br><span class="line">    mbedtls_entropy_free(&amp;entropy);</span><br><span class="line">    mbedtls_mpi_free(&amp;r);</span><br><span class="line">    mbedtls_mpi_free(&amp;s);</span><br><span class="line">    mbedtls_md_free(&amp;md_ctx);</span><br><span class="line">    mbedtls_ecdsa_free(&amp;ctx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_DHM_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-7">8.3.4 测试结果</h3><p>在main.c中声明该函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_ecdsa_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在main函数中调用该函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 9. ecdsa sign test */</span></span><br><span class="line">mbedtls_ecdsa_test();</span><br></pre></td></tr></table></figure>
<p>编译、下载，在串口助手中查看结果：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003193818564.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h1 id="九、数字证书及-X-509-证书标准">9 九、数字证书及 X.509 证书标准</h1><h2 id="X-509证书标准">9.1 X.509证书标准</h2><p>X.509是数字证书的一种标准格式，由国际电信联盟的标准化部分定义。</p>
<h3 id="X-509证书的结构">9.1.1 X.509证书的结构</h3><p>X.509证书主要包括12个字段，如下表：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>字段</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>Version</td>
<td>版本</td>
<td>证书版本</td>
</tr>
<tr>
<td>Serial number</td>
<td>序列号</td>
<td>证书的唯一序列号</td>
</tr>
<tr>
<td>Signature</td>
<td>签名算法</td>
<td>CA对证书进行签名所使用的签名算法</td>
</tr>
<tr>
<td>Issuer</td>
<td>发行商名称</td>
<td>标识对证书进行签名并颁发的实体</td>
</tr>
<tr>
<td>Validity</td>
<td>有效期</td>
<td>标识证书的生效日期和终止日期</td>
</tr>
<tr>
<td>Subject</td>
<td>证书主体名称</td>
<td>标识获得证书的主体</td>
</tr>
<tr>
<td>Subject public key infomation</td>
<td>公钥</td>
<td>用于指示使用者公钥信息</td>
</tr>
<tr>
<td>Issure unique ID</td>
<td>颁发者唯一标识</td>
<td>用于标识证书签发机构</td>
</tr>
<tr>
<td>subject unique ID</td>
<td>使用者唯一标识</td>
<td>用于标识证书使用者实体</td>
</tr>
<tr>
<td>Extensions</td>
<td>扩展</td>
<td>一个或多个扩展域</td>
</tr>
<tr>
<td>signature Algorithm</td>
<td>签名算法</td>
<td>标识CA对证书签名所使用的签名算法和参数</td>
</tr>
<tr>
<td>signature Value</td>
<td>签名值</td>
<td>CA对证书的签名结果</td>
</tr>
</tbody></table>
<h3 id="获取证书示例（百度）">9.1.2 获取证书示例（百度）</h3><p>下面以百度的证书为例讲解X.509证书标准。</p>
<p>使用浏览器访问百度首页：<a target="_blank" rel="noopener" href="https://www.baidu.com/%EF%BC%8C%E7%82%B9%E5%87%BB%E5%9F%9F%E5%90%8D%E6%97%81%E8%BE%B9%E7%9A%84%E3%80%90%E5%B0%8F%E7%BB%BF%E9%94%81%E3%80%91%EF%BC%8C%E7%82%B9%E5%87%BB%E3%80%90%E8%AF%81%E4%B9%A6%E3%80%91%E3%80%82">https://www.baidu.com/，点击域名旁边的【小绿锁】，点击【证书】。</a><br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003204805665.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>点击之后即可查看到百度的证书：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003204907406.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>① 点击【证书路径】，将一级证书（根证书）导出：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003205037671.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>点击【详细信息】，将此证书内容【复制到文件】：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003205127263.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="、"><br>进入证书导出向导：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/2020100320522449.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>选择使用【Base64编码】导出：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/2020100320531961.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>选择导出文件路径：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003205427731.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>导出成功：<img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003205524237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>② 同样的方法，将二级证书导出为baidu_2.cer：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003205629372.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>③ 同样的方法，将三级证书导出为baidu_3.cer：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003205710197.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>三份证书如图：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/2020100320581770.png#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>使用记事本打开任意一份，可以看到该证书内容：<img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003205912844.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br><strong>新建一个空文件<code>baidu_ca.txt</code>，将三份内容按照次序复制到该文件中，后续使用</strong>。<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201003210126170.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h3 id="查看百度证书内容">9.1.3 查看百度证书内容</h3><p>使用openssl工具查看刚刚获取的百度证书内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -text -<span class="keyword">in</span> baidu_3.cer -noout</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p>① 证书颁发者和使用者信息：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201004102053366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>② 公钥算法和公钥内容：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201004101257191.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>③ 签名算法和内容：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/2020100410141193.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"><br>同样的方法可以查看百度二级证书和百度一级证书（根证书）的内容。</p>
<h2 id="X509证书解析验证功能的配置与使用">9.2 X509证书解析验证功能的配置与使用</h2><h3 id="配置宏-7">9.2.1 配置宏</h3><p>①</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PK_C</span></span><br></pre></td></tr></table></figure>
<p>②</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PK_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>③</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>④</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span></span><br></pre></td></tr></table></figure>
<p>⑤</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_X509_USE_C</span></span><br></pre></td></tr></table></figure>
<p>⑥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BASE64_C</span></span><br></pre></td></tr></table></figure>
<p>⑦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PEM_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>⑧</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_X509_CRT_PARSE_C</span></span><br></pre></td></tr></table></figure>
<p>新建配置文件<code>mbedtls_config_x509.h</code>，编辑以下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MBEDTLS_CONFIG_X509_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MBEDTLS_CONFIG_X509_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* System support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_HAVE_ASM</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_HAVE_TIME</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed feature support */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ENTROPY_HARDWARE_ALT</span></span><br><span class="line"><span class="comment">//#define MBEDTLS_NO_DEFAULT_ENTROPY_SOURCES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_NO_PLATFORM_ENTROPY</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* mbed modules */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA1_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_SHA256_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_MD_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BIGNUM_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_OID_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_RSA_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PKCS1_V21</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PK_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PK_PARSE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_PARSE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ASN1_WRITE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_X509_USE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_BASE64_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_PEM_PARSE_C</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_X509_CRT_PARSE_C</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/check_config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _MBEDTLS_CONFIG_X509_H_ */</span></span></span><br></pre></td></tr></table></figure>
<p>在MDK中配置使用该文件：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201004132201128.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>
<h3 id="API说明-1">9.2.2 API说明</h3><p>使用时需要包含头文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/x509_crt.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>① 初始化证书结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_x509_crt_init</span><span class="params">( mbedtls_x509_crt *crt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>② 证书解析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Parse one DER-encoded or one or more concatenated PEM-encoded</span></span><br><span class="line"><span class="comment"> *                 certificates and add them to the chained list.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 For CRTs in PEM encoding, the function parses permissively:</span></span><br><span class="line"><span class="comment"> *                 if at least one certificate can be parsed, the function</span></span><br><span class="line"><span class="comment"> *                 returns the number of certificates for which parsing failed</span></span><br><span class="line"><span class="comment"> *                 (hence \c 0 if all certificates were parsed successfully).</span></span><br><span class="line"><span class="comment"> *                 If no certificate could be parsed, the function returns</span></span><br><span class="line"><span class="comment"> *                 the first (negative) error encountered during parsing.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 PEM encoded certificates may be interleaved by other data</span></span><br><span class="line"><span class="comment"> *                 such as human readable descriptions of their content, as</span></span><br><span class="line"><span class="comment"> *                 long as the certificates are enclosed in the PEM specific</span></span><br><span class="line"><span class="comment"> *                 &#x27;-----&#123;BEGIN/END&#125; CERTIFICATE-----&#x27; delimiters.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param chain    The chain to which to add the parsed certificates.</span></span><br><span class="line"><span class="comment"> * \param buf      The buffer holding the certificate data in PEM or DER format.</span></span><br><span class="line"><span class="comment"> *                 For certificates in PEM encoding, this may be a concatenation</span></span><br><span class="line"><span class="comment"> *                 of multiple certificates; for DER encoding, the buffer must</span></span><br><span class="line"><span class="comment"> *                 comprise exactly one certificate.</span></span><br><span class="line"><span class="comment"> * \param buflen   The size of \p buf, including the terminating \c NULL byte</span></span><br><span class="line"><span class="comment"> *                 in case of PEM encoded data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 if all certificates were parsed successfully.</span></span><br><span class="line"><span class="comment"> * \return         The (positive) number of certificates that couldn&#x27;t</span></span><br><span class="line"><span class="comment"> *                 be parsed if parsing was partly successful (see above).</span></span><br><span class="line"><span class="comment"> * \return         A negative X509 or PEM error code otherwise.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_crt_parse</span><span class="params">( mbedtls_x509_crt *chain, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> buflen )</span></span>;</span><br></pre></td></tr></table></figure>
<p>③ 获取证书信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Returns an informational string about the</span></span><br><span class="line"><span class="comment"> *                 certificate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param buf      Buffer to write to</span></span><br><span class="line"><span class="comment"> * \param size     Maximum size of buffer</span></span><br><span class="line"><span class="comment"> * \param prefix   A line prefix</span></span><br><span class="line"><span class="comment"> * \param crt      The X509 certificate to represent</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         The length of the string written (not including the</span></span><br><span class="line"><span class="comment"> *                 terminated nul byte), or a negative error code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_crt_info</span><span class="params">( <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *prefix,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> mbedtls_x509_crt *crt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>④ 获取证书认证信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Returns an informational string about the</span></span><br><span class="line"><span class="comment"> *                 verification status of a certificate.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param buf      Buffer to write to</span></span><br><span class="line"><span class="comment"> * \param size     Maximum size of buffer</span></span><br><span class="line"><span class="comment"> * \param prefix   A line prefix</span></span><br><span class="line"><span class="comment"> * \param flags    Verification flags created by mbedtls_x509_crt_verify()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         The length of the string written (not including the</span></span><br><span class="line"><span class="comment"> *                 terminated nul byte), or a negative error code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_crt_verify_info</span><span class="params">( <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *prefix,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">uint32_t</span> flags )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑤ 证书认证</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Verify a chain of certificates.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 The verify callback is a user-supplied callback that</span></span><br><span class="line"><span class="comment"> *                 can clear / modify / add flags for a certificate. If set,</span></span><br><span class="line"><span class="comment"> *                 the verification callback is called for each</span></span><br><span class="line"><span class="comment"> *                 certificate in the chain (from the trust-ca down to the</span></span><br><span class="line"><span class="comment"> *                 presented crt). The parameters for the callback are:</span></span><br><span class="line"><span class="comment"> *                 (void *parameter, mbedtls_x509_crt *crt, int certificate_depth,</span></span><br><span class="line"><span class="comment"> *                 int *flags). With the flags representing current flags for</span></span><br><span class="line"><span class="comment"> *                 that specific certificate and the certificate depth from</span></span><br><span class="line"><span class="comment"> *                 the bottom (Peer cert depth = 0).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                 All flags left after returning from the callback</span></span><br><span class="line"><span class="comment"> *                 are also returned to the application. The function should</span></span><br><span class="line"><span class="comment"> *                 return 0 for anything (including invalid certificates)</span></span><br><span class="line"><span class="comment"> *                 other than fatal error, as a non-zero return code</span></span><br><span class="line"><span class="comment"> *                 immediately aborts the verification process. For fatal</span></span><br><span class="line"><span class="comment"> *                 errors, a specific error code should be used (different</span></span><br><span class="line"><span class="comment"> *                 from MBEDTLS_ERR_X509_CERT_VERIFY_FAILED which should not</span></span><br><span class="line"><span class="comment"> *                 be returned at this point), or MBEDTLS_ERR_X509_FATAL_ERROR</span></span><br><span class="line"><span class="comment"> *                 can be used if no better code is available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           In case verification failed, the results can be displayed</span></span><br><span class="line"><span class="comment"> *                 using \c mbedtls_x509_crt_verify_info()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           Same as \c mbedtls_x509_crt_verify_with_profile() with the</span></span><br><span class="line"><span class="comment"> *                 default security profile.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           It is your responsibility to provide up-to-date CRLs for</span></span><br><span class="line"><span class="comment"> *                 all trusted CAs. If no CRL is provided for the CA that was</span></span><br><span class="line"><span class="comment"> *                 used to sign the certificate, CRL verification is skipped</span></span><br><span class="line"><span class="comment"> *                 silently, that is *without* setting any flag.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \note           The \c trust_ca list can contain two types of certificates:</span></span><br><span class="line"><span class="comment"> *                 (1) those of trusted root CAs, so that certificates</span></span><br><span class="line"><span class="comment"> *                 chaining up to those CAs will be trusted, and (2)</span></span><br><span class="line"><span class="comment"> *                 self-signed end-entity certificates to be trusted (for</span></span><br><span class="line"><span class="comment"> *                 specific peers you know) - in that case, the self-signed</span></span><br><span class="line"><span class="comment"> *                 certificate doesn&#x27;t need to have the CA bit set.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param crt      The certificate chain to be verified.</span></span><br><span class="line"><span class="comment"> * \param trust_ca The list of trusted CAs.</span></span><br><span class="line"><span class="comment"> * \param ca_crl   The list of CRLs for trusted CAs.</span></span><br><span class="line"><span class="comment"> * \param cn       The expected Common Name. This will be checked to be</span></span><br><span class="line"><span class="comment"> *                 present in the certificate&#x27;s subjectAltNames extension or,</span></span><br><span class="line"><span class="comment"> *                 if this extension is absent, as a CN component in its</span></span><br><span class="line"><span class="comment"> *                 Subject name. Currently only DNS names are supported. This</span></span><br><span class="line"><span class="comment"> *                 may be \c NULL if the CN need not be verified.</span></span><br><span class="line"><span class="comment"> * \param flags    The address at which to store the result of the verification.</span></span><br><span class="line"><span class="comment"> *                 If the verification couldn&#x27;t be completed, the flag value is</span></span><br><span class="line"><span class="comment"> *                 set to (uint32_t) -1.</span></span><br><span class="line"><span class="comment"> * \param f_vrfy   The verification callback to use. See the documentation</span></span><br><span class="line"><span class="comment"> *                 of mbedtls_x509_crt_verify() for more information.</span></span><br><span class="line"><span class="comment"> * \param p_vrfy   The context to be passed to \p f_vrfy.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return         \c 0 if the chain is valid with respect to the</span></span><br><span class="line"><span class="comment"> *                 passed CN, CAs, CRLs and security profile.</span></span><br><span class="line"><span class="comment"> * \return         #MBEDTLS_ERR_X509_CERT_VERIFY_FAILED in case the</span></span><br><span class="line"><span class="comment"> *                 certificate chain verification failed. In this case,</span></span><br><span class="line"><span class="comment"> *                 \c *flags will have one or more</span></span><br><span class="line"><span class="comment"> *                 \c MBEDTLS_X509_BADCERT_XXX or \c MBEDTLS_X509_BADCRL_XXX</span></span><br><span class="line"><span class="comment"> *                 flags set.</span></span><br><span class="line"><span class="comment"> * \return         Another negative error code in case of a fatal error</span></span><br><span class="line"><span class="comment"> *                 encountered during the verification process.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_crt_verify</span><span class="params">( mbedtls_x509_crt *crt,</span></span></span><br><span class="line"><span class="function"><span class="params">                     mbedtls_x509_crt *trust_ca,</span></span></span><br><span class="line"><span class="function"><span class="params">                     mbedtls_x509_crl *ca_crl,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> <span class="keyword">char</span> *cn, <span class="keyword">uint32_t</span> *flags,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">int</span> (*f_vrfy)(<span class="keyword">void</span> *, mbedtls_x509_crt *, <span class="keyword">int</span>, <span class="keyword">uint32_t</span> *),</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *p_vrfy )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑥ 释放证书结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \brief          Unallocate all certificate data</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \param crt      Certificate chain to free</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mbedtls_x509_crt_free</span><span class="params">( mbedtls_x509_crt *crt )</span></span>;</span><br></pre></td></tr></table></figure>
<p>⑦ 错误码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * \name X509 Error codes</span></span><br><span class="line"><span class="comment"> * \&#123;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_FEATURE_UNAVAILABLE              -0x2080  <span class="comment">/**&lt; Unavailable feature, e.g. RSA hashing/encryption combination. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_UNKNOWN_OID                      -0x2100  <span class="comment">/**&lt; Requested OID is unknown. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_FORMAT                   -0x2180  <span class="comment">/**&lt; The CRT/CRL/CSR format is invalid, e.g. different type expected. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_VERSION                  -0x2200  <span class="comment">/**&lt; The CRT/CRL/CSR version element is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_SERIAL                   -0x2280  <span class="comment">/**&lt; The serial tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_ALG                      -0x2300  <span class="comment">/**&lt; The algorithm tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_NAME                     -0x2380  <span class="comment">/**&lt; The name tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_DATE                     -0x2400  <span class="comment">/**&lt; The date tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_SIGNATURE                -0x2480  <span class="comment">/**&lt; The signature tag or value invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_INVALID_EXTENSIONS               -0x2500  <span class="comment">/**&lt; The extension tag or value is invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_UNKNOWN_VERSION                  -0x2580  <span class="comment">/**&lt; CRT/CRL/CSR has an unsupported version number. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_UNKNOWN_SIG_ALG                  -0x2600  <span class="comment">/**&lt; Signature algorithm (oid) is unsupported. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_SIG_MISMATCH                     -0x2680  <span class="comment">/**&lt; Signature algorithms do not match. (see \c ::mbedtls_x509_crt sig_oid) */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_CERT_VERIFY_FAILED               -0x2700  <span class="comment">/**&lt; Certificate verification failed, e.g. CRL, CA or signature check failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_CERT_UNKNOWN_FORMAT              -0x2780  <span class="comment">/**&lt; Format not recognized as DER or PEM. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_BAD_INPUT_DATA                   -0x2800  <span class="comment">/**&lt; Input invalid. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_ALLOC_FAILED                     -0x2880  <span class="comment">/**&lt; Allocation of memory failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_FILE_IO_ERROR                    -0x2900  <span class="comment">/**&lt; Read/write of file failed. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_BUFFER_TOO_SMALL                 -0x2980  <span class="comment">/**&lt; Destination buffer is too small. */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MBEDTLS_ERR_X509_FATAL_ERROR                      -0x3000  <span class="comment">/**&lt; A fatal error occurred, eg the chain is too long or the vrfy callback failed. */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="编写测试函数-7">9.2.3 编写测试函数</h3><p>编写头文件<code>baidu_certs.h</code>，将百度的证书存储：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __CERTS_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CERTS_H__</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> baidu_ca_cert[] =</span><br><span class="line"><span class="string">&quot;-----BEGIN CERTIFICATE-----\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;MIIKLjCCCRagAwIBAgIMclh4Nm6fVugdQYhIMA0GCSqGSIb3DQEBCwUAMGYxCzAJ\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;BgNVBAYTAkJFMRkwFwYDVQQKExBHbG9iYWxTaWduIG52LXNhMTwwOgYDVQQDEzNH\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;bG9iYWxTaWduIE9yZ2FuaXphdGlvbiBWYWxpZGF0aW9uIENBIC0gU0hBMjU2IC0g\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;RzIwHhcNMjAwNDAyMDcwNDU4WhcNMjEwNzI2MDUzMTAyWjCBpzELMAkGA1UEBhMC\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;Q04xEDAOBgNVBAgTB2JlaWppbmcxEDAOBgNVBAcTB2JlaWppbmcxJTAjBgNVBAsT\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;HHNlcnZpY2Ugb3BlcmF0aW9uIGRlcGFydG1lbnQxOTA3BgNVBAoTMEJlaWppbmcg\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;QmFpZHUgTmV0Y29tIFNjaWVuY2UgVGVjaG5vbG9neSBDby4sIEx0ZDESMBAGA1UE\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;AxMJYmFpZHUuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwamw\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;rkca0lfrHRUfblyy5PgLINvqAN8p/6RriSZLnyMv7FewirhGQCp+vNxaRZdPrUEO\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;vCCGSwxdVSFH4jE8V6fsmUfrRw1y18gWVHXv00URD0vOYHpGXCh0ro4bvthwZnuo\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;k0ko0qN2lFXefCfyD/eYDK2G2sau/Z/w2YEympfjIe4EkpbkeBHlxBAOEDF6Speg\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;68ebxNqJN6nDN9dWsX9Sx9kmCtavOBaxbftzebFoeQOQ64h7jEiRmFGlB5SGpXhG\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;eY9Ym+k1Wafxe1cxCpDPJM4NJOeSsmrp5pY3Crh8hy900lzoSwpfZhinQYbPJqYI\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;jqVJF5JTs5Glz1OwMQIDAQABo4IGmDCCBpQwDgYDVR0PAQH/BAQDAgWgMIGgBggr\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;BgEFBQcBAQSBkzCBkDBNBggrBgEFBQcwAoZBaHR0cDovL3NlY3VyZS5nbG9iYWxz\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;aWduLmNvbS9jYWNlcnQvZ3Nvcmdhbml6YXRpb252YWxzaGEyZzJyMS5jcnQwPwYI\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;KwYBBQUHMAGGM2h0dHA6Ly9vY3NwMi5nbG9iYWxzaWduLmNvbS9nc29yZ2FuaXph\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dGlvbnZhbHNoYTJnMjBWBgNVHSAETzBNMEEGCSsGAQQBoDIBFDA0MDIGCCsGAQUF\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;BwIBFiZodHRwczovL3d3dy5nbG9iYWxzaWduLmNvbS9yZXBvc2l0b3J5LzAIBgZn\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;gQwBAgIwCQYDVR0TBAIwADBJBgNVHR8EQjBAMD6gPKA6hjhodHRwOi8vY3JsLmds\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;b2JhbHNpZ24uY29tL2dzL2dzb3JnYW5pemF0aW9udmFsc2hhMmcyLmNybDCCA04G\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;A1UdEQSCA0UwggNBggliYWlkdS5jb22CDGJhaWZ1YmFvLmNvbYIMd3d3LmJhaWR1\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;LmNughB3d3cuYmFpZHUuY29tLmNugg9tY3QueS5udW9taS5jb22CC2Fwb2xsby5h\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dXRvggZkd3ouY26CCyouYmFpZHUuY29tgg4qLmJhaWZ1YmFvLmNvbYIRKi5iYWlk\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dXN0YXRpYy5jb22CDiouYmRzdGF0aWMuY29tggsqLmJkaW1nLmNvbYIMKi5oYW8x\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;MjMuY29tggsqLm51b21pLmNvbYINKi5jaHVhbmtlLmNvbYINKi50cnVzdGdvLmNv\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;bYIPKi5iY2UuYmFpZHUuY29tghAqLmV5dW4uYmFpZHUuY29tgg8qLm1hcC5iYWlk\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dS5jb22CDyoubWJkLmJhaWR1LmNvbYIRKi5mYW55aS5iYWlkdS5jb22CDiouYmFp\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;ZHViY2UuY29tggwqLm1pcGNkbi5jb22CECoubmV3cy5iYWlkdS5jb22CDiouYmFp\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;ZHVwY3MuY29tggwqLmFpcGFnZS5jb22CCyouYWlwYWdlLmNugg0qLmJjZWhvc3Qu\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;Y29tghAqLnNhZmUuYmFpZHUuY29tgg4qLmltLmJhaWR1LmNvbYISKi5iYWlkdWNv\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;bnRlbnQuY29tggsqLmRsbmVsLmNvbYILKi5kbG5lbC5vcmeCEiouZHVlcm9zLmJh\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;aWR1LmNvbYIOKi5zdS5iYWlkdS5jb22CCCouOTEuY29tghIqLmhhbzEyMy5iYWlk\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dS5jb22CDSouYXBvbGxvLmF1dG+CEioueHVlc2h1LmJhaWR1LmNvbYIRKi5iai5i\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;YWlkdWJjZS5jb22CESouZ3ouYmFpZHViY2UuY29tgg4qLnNtYXJ0YXBwcy5jboIN\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;Ki5iZHRqcmN2LmNvbYIMKi5oYW8yMjIuY29tggwqLmhhb2thbi5jb22CDyoucGFl\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;LmJhaWR1LmNvbYIRKi52ZC5iZHN0YXRpYy5jb22CEmNsaWNrLmhtLmJhaWR1LmNv\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;bYIQbG9nLmhtLmJhaWR1LmNvbYIQY20ucG9zLmJhaWR1LmNvbYIQd24ucG9zLmJh\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;aWR1LmNvbYIUdXBkYXRlLnBhbi5iYWlkdS5jb20wHQYDVR0lBBYwFAYIKwYBBQUH\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;AwEGCCsGAQUFBwMCMB8GA1UdIwQYMBaAFJbeYfG9HBYpUxzAzH07gwBA5hp8MB0G\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;A1UdDgQWBBSeyXnX6VurihbMMo7GmeafIEI1hzCCAX4GCisGAQQB1nkCBAIEggFu\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;BIIBagFoAHYAXNxDkv7mq0VEsV6a1FbmEDf71fpH3KFzlLJe5vbHDsoAAAFxObU8\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;ugAABAMARzBFAiBphmgxIbNZXaPWiUqXRWYLaRST38KecoekKIof5fXmsgIhAMkZ\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;tF8XyKCu/nZll1e9vIlKbW8RrUr/74HpmScVRRsBAHYAb1N2rDHwMRnYmQCkURX/\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;dxUcEdkCwQApBo2yCJo32RMAAAFxObU85AAABAMARzBFAiBURWwwTgXZ+9IV3mhm\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;E0EOzbg901DLRszbLIpafDY/XgIhALsvEGqbBVrpGxhKoTVlz7+GWom8SrfUeHcn\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;4+9Dn7xGAHYA9lyUL9F3MCIUVBgIMJRWjuNNExkzv98MLyALzE7xZOMAAAFxObU8\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;qwAABAMARzBFAiBFBYPxKEdhlf6bqbwxQY7tskgdoFulPxPmdrzS5tNpPwIhAKnK\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;qwzch98lINQYzLAV52+C8GXZPXFZNfhfpM4tQ6xbMA0GCSqGSIb3DQEBCwUAA4IB\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;AQC83ALQ2d6MxeLZ/k3vutEiizRCWYSSMYLVCrxANdsGshNuyM8B8V/A57c0Nzqo\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;CPKfMtX5IICfv9P/bUecdtHL8cfx24MzN+U/GKcA4r3a/k8pRVeHeF9ThQ2zo1xj\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;k/7gJl75koztdqNfOeYiBTbFMnPQzVGqyMMfqKxbJrfZlGAIgYHT9bd6T985IVgz\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;tRVjAoy4IurZenTsWkG7PafJ4kAh6jQaSu1zYEbHljuZ5PXlkhPO9DwW1WIPug6Z\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;rlylLTTYmlW3WETOATi70HYsZN6NACuZ4t1hEO3AsF7lqjdA2HwTN10FX2HuaUvf\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;5OzP+PKupV9VKw8x8mQKU6vr\r\n&quot;</span></span><br><span class="line"><span class="string">&quot;-----END CERTIFICATE-----\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>编写测试函数文件<code>mbedtls_x509_test.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief   X509 Function demo</span></span><br><span class="line"><span class="comment"> * @author  mculover666</span></span><br><span class="line"><span class="comment"> * @date    2020/10/04</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(MBEDTLS_CONFIG_FILE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> MBEDTLS_CONFIG_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(MBEDTLS_X509_CRT_PARSE_C)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mbedtls/x509_crt.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;baidu_certs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mbedtls_x509_test</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">   </span><br><span class="line">    mbedtls_x509_crt cert, cacert;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. init structure */</span></span><br><span class="line">    mbedtls_x509_crt_init(&amp;cert);</span><br><span class="line">    mbedtls_x509_crt_init(&amp;cacert);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2. Parser cacert */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Parse cacert...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_x509_crt_parse(&amp;cacert, (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)baidu_ca_cert, <span class="keyword">sizeof</span>(baidu_ca_cert));</span><br><span class="line">     <span class="keyword">if</span>(ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>( <span class="string">&quot; failed\n  ! mbedtls_x509_crt_parse cacert returned %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot; ok\n&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2. Cacert parser result */</span></span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;\n  . Cacert parser result...&quot;</span> );</span><br><span class="line">    </span><br><span class="line">    ret = mbedtls_x509_crt_info(buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>, <span class="string">&quot;      &quot;</span>, &amp;cacert);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fail! mbedtls_x509_crt_info return %d(-0x%04x)\n&quot;</span>, ret, -ret);</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buf[ret] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ok!\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;crt info has %d chars\r\n&quot;</span>, <span class="built_in">strlen</span>(buf));    </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\r\n&quot;</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">exit</span>:  </span><br><span class="line">    <span class="comment">/* 3. release structure */</span></span><br><span class="line">    mbedtls_x509_crt_free(&amp;cert);</span><br><span class="line">    mbedtls_x509_crt_free(&amp;cacert);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* MBEDTLS_RSA_C */</span></span></span><br></pre></td></tr></table></figure>
<h3 id="测试结果-8">9.2.4 测试结果</h3><p>在main.c中声明该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">mbedtls_x509_test</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在main函数中调用该测试函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 10. x509 test */</span></span><br><span class="line">mbedtls_x509_test();</span><br></pre></td></tr></table></figure>
<p>编译、下载、测试结果为：<br><img "" class="lazyload placeholder" data-original="https://img-blog.csdnimg.cn/20201004131906865.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L01jdWxvdmVyNjY2,size_16,color_FFFFFF,t_70#pic_center" src="https://img10.360buyimg.com/ddimg/jfs/t1/157667/29/9156/134350/603c6445Ebbc9cabe/41219c5d36d45072.gif" alt="img"></p>

      </div>
      
        <div class="copyright">
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>作者:  </strong>creekwater</a>
    </li>
    <li class="post-copyright-link">
    <strong>文章链接:  </strong>
    <a href="/posts/841b00c2.html" target="_blank" title="mbedtls加密组件分析">https://www.creekwater.cn/posts/841b00c2.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明:   </strong>
      本网站所有文章除特别声明外,均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
      许可协议。转载请注明出处!
    </li>
  </ul>
<div>
      
    </article>
    <!-- 上一篇文章和下一篇文章 -->
    
      <!-- 文章详情页的上一页和下一页 -->
<div class="post-nav">



  
  <div class="post-nav-prev post-nav-item">
    <div class="post-nav-img lazyload" data-original="/medias/13.jpg" style="background-size: cover; 
      background-position: center center;">
    </div>
    <a href="/posts/9ea78192.html" class="post-nav-link">
      <div class="title">
        <i class="fa fa-angle-left"></i> 上一篇:
        <div>1、esp32 panic详解</div>
      </div>
      
      <!-- <div class="content">
        1 1. dport_panic_highint_hdl.Scall4 panicHandler：传递(XtExcFra
      </div> -->
    </a>
  </div>



  
  <div class="post-nav-next post-nav-item">
    <div class="post-nav-img lazyload" data-original="/medias/13.jpg" style="background-size: cover; 
      background-position: center center;">
    </div>
    <a href="/posts/4461482.html" class="post-nav-link">
      <div class="title">
        下一篇: <i class="fa fa-angle-right"></i>
        <div>v2ray科学上网</div>
      </div>
      <!-- <div class="content">
        1 安装和更新 V2Ray12&#x2F;&#x2F; 安装可执行文件和 .dat 数据文件# bash &lt;(cu
      </div> -->
    </a>
  </div>

</div>

    
    

    <!-- 打赏 -->
    
      <div id="appDonate" class="post-donate">
  <div id="donate_board" class="donate_bar center" ref="donate">
    <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏" @click="showDialogDrawer()"></a>
  </div>
  <transition name="fade">
    <div 
      class="donate-box-mask"
      v-cloak 
      v-if="visible"
      @click="cancelDialogDrawer()"
    >
    </div>
  </transition>
  <transition name="bounce">
    <div class="donate-box" v-cloak v-if="visible">
      <div class="donate-box_close">
        <i class="fa fa-times" aria-hidden="true" @click="cancelDialogDrawer"></i>
      </div>
      <div class="donate-box_title">
        <h4>
          你的赏识是我前进的动力
        </h4>
      </div>
      <div class="donate-box_tab">
        <div class="Alipay" :class="{'active': tabActive === 'Alipay'}" @click="changeTabActive('Alipay')">
          支付宝
        </div>
        <div class="WeChatpay" :class="{'active': tabActive === 'WeChatpay'}" @click="changeTabActive('WeChatpay')">
          微信
        </div>
      </div>
      <div class="donate-box_img">
        <div class="AlipayImg" v-if="tabActive === 'Alipay'">
          <img src="/medias/zfb.jpg" alt="支付宝打赏" />
        </div> 
        <div class="WeChatpayImg" v-if="tabActive === 'WeChatpay'">
          <img src="/medias/wx.jpg" alt="微信打赏" />
        </div>
      </div>
    </div>
  </transition>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDonate',
    data: {
      visible: false,
      tabActive: 'Alipay',
      top: 0,
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        // function getScroll() {
        //   return {
        //     left: window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft || 0,
        //     top: window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0
        //   };
        // }
        this.top = $(document).scrollTop() // or getScroll().top
        // console.log('aa', $('.main-content'));
        body.style.cssText = 'overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
      changeTabActive(name) {
        this.tabActive = name;
      }
    },
    created() {}
  })
</script>
    

    <!-- 分享 -->
    
      <!-- https://github.com/overtrue/share.js -->
<!-- 文章详情页的分享 -->
<div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>

<script src="/js/shareJs/social-share.min.js"></script>
</script>

<style>
  .social-share {
    margin: 20px 0;
  }
</style>


    
    
    <!-- 评论 -->
    <!-- 评论 -->

  <div id="myComment">
    
      <!-- 弹幕所需的css和js -->

  <!-- 弹幕插件 -->
  <link href="/js/danmu/barrager.css" rel="stylesheet">
  <script src="/js/danmu/jquery.barrager.js"></script>

<!-- 具体js，请前往valine.ejs查看 -->


<section id="comments" style="padding: 1em; margin: 15px auto;"
	class="animated bounceInUp">
	<div id="vcomment" class="comment"></div>
	<script src="/js/valine/av-min@3.0.4.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/HCLonely/Valine@latest/dist/Valine.min.js"></script>
	<script>

		var requiredFields = 'nick,mail';
  		requiredFields  = requiredFields.split(',');

		var valine = new Valine({
			el: '#vcomment',
			notify: false,
			verify: false,
			app_id: "Y204Pb7cYvSCT5zrsAa4DhGe-gzGzoHsz",
			app_key: "mthXbDKXvBv6b8M9FjG9CjFT",
			placeholder: "客官，说点什么吧",
			avatar: "",
			master: "72efbb90c3f61603fe9482f17526f7ea",   //博主邮箱md5
			tagMeta: ["博主","小伙伴","访客"],     //标识字段名
			friends: "",
			metaPlaceholder: { "nick": "昵称/QQ号", "mail": "邮箱" },
			requiredFields: requiredFields,
			enableQQ: true,
			// 设置Bilibili表情包地址
			emojiCDN: '//i0.hdslb.com/bfs/emote/',
			// 表情title和图片映射	
			emojiMaps: {
				"口罩": "https://i0.hdslb.com/bfs/emote/3ad2f66b151496d2a5fb0a8ea75f32265d778dd3.png",
				"微笑": "https://i0.hdslb.com/bfs/emote/685612eadc33f6bc233776c6241813385844f182.png",
				"笑": "https://i0.hdslb.com/bfs/emote/81edf17314cea3b48674312b4364df44d5c01f17.png",
				"呲牙": "https://i0.hdslb.com/bfs/emote/b5a5898491944a4268360f2e7a84623149672eb6.png",
				"OK": "https://i0.hdslb.com/bfs/emote/4683fd9ffc925fa6423110979d7dcac5eda297f4.png",
				"星星眼": "https://i0.hdslb.com/bfs/emote/63c9d1a31c0da745b61cdb35e0ecb28635675db2.png",
				"哦呼": "https://i0.hdslb.com/bfs/emote/362bded07ea5434886271d23fa25f5d85d8af06c.png",
				"歪嘴": "https://i0.hdslb.com/bfs/emote/4384050fbab0586259acdd170b510fe262f08a17.png",
				"嫌弃": "https://i0.hdslb.com/bfs/emote/de4c0783aaa60ec03de0a2b90858927bfad7154b.png",
				"喜欢": "https://i0.hdslb.com/bfs/emote/8a10a4d73a89f665feff3d46ca56e83dc68f9eb8.png",
				"酸了": "https://i0.hdslb.com/bfs/emote/92b1c8cbceea3ae0e8e32253ea414783e8ba7806.png",
				"大哭": "https://i0.hdslb.com/bfs/emote/2caafee2e5db4db72104650d87810cc2c123fc86.png",
				"害羞": "https://i0.hdslb.com/bfs/emote/9d2ec4e1fbd6cb1b4d12d2bbbdd124ccb83ddfda.png",
				"无语": "https://i0.hdslb.com/bfs/emote/44667b7d9349957e903b1b62cb91fb9b13720f04.png",
				"疑惑": "https://i0.hdslb.com/bfs/emote/b7840db4b1f9f4726b7cb23c0972720c1698d661.png",
				"辣眼睛": "https://i0.hdslb.com/bfs/emote/35d62c496d1e4ea9e091243fa812866f5fecc101.png",
				"调皮": "https://i0.hdslb.com/bfs/emote/8290b7308325e3179d2154327c85640af1528617.png",
				"喜极而泣": "https://i0.hdslb.com/bfs/emote/485a7e0c01c2d70707daae53bee4a9e2e31ef1ed.png",
				"奸笑": "https://i0.hdslb.com/bfs/emote/bb84906573472f0a84cebad1e9000eb6164a6f5a.png",
				"偷笑": "https://i0.hdslb.com/bfs/emote/6c49d226e76c42cd8002abc47b3112bc5a92f66a.png",
				"大笑": "https://i0.hdslb.com/bfs/emote/ca94ad1c7e6dac895eb5b33b7836b634c614d1c0.png",
				"阴险": "https://i0.hdslb.com/bfs/emote/ba8d5f8e7d136d59aab52c40fd3b8a43419eb03c.png",
				"捂脸": "https://i0.hdslb.com/bfs/emote/6921bb43f0c634870b92f4a8ad41dada94a5296d.png",
				"囧": "https://i0.hdslb.com/bfs/emote/12e41d357a9807cc80ef1e1ed258127fcc791424.png",
				"呆": "https://i0.hdslb.com/bfs/emote/33ad6000d9f9f168a0976bc60937786f239e5d8c.png",
				"抠鼻": "https://i0.hdslb.com/bfs/emote/cb89184c97e3f6d50acfd7961c313ce50360d70f.png",
				"惊喜": "https://i0.hdslb.com/bfs/emote/0afecaf3a3499479af946f29749e1a6c285b6f65.png",
				"惊讶": "https://i0.hdslb.com/bfs/emote/f8e9a59cad52ae1a19622805696a35f0a0d853f3.png",
				"笑哭": "https://i0.hdslb.com/bfs/emote/c3043ba94babf824dea03ce500d0e73763bf4f40.png",
				"妙啊": "https://i0.hdslb.com/bfs/emote/b4cb77159d58614a9b787b91b1cd22a81f383535.png",
				"doge": "https://i0.hdslb.com/bfs/emote/bba7c12aa51fed0199c241465560dfc2714c593e.png",
				"滑稽": "https://i0.hdslb.com/bfs/emote/d15121545a99ac46774f1f4465b895fe2d1411c3.png",
				"吃瓜": "https://i0.hdslb.com/bfs/emote/4191ce3c44c2b3df8fd97c33f85d3ab15f4f3c84.png",
				"打call": "https://i0.hdslb.com/bfs/emote/431432c43da3ee5aab5b0e4f8931953e649e9975.png",
				"点赞": "https://i0.hdslb.com/bfs/emote/1a67265993913f4c35d15a6028a30724e83e7d35.png",
				"鼓掌": "https://i0.hdslb.com/bfs/emote/895d1fc616b4b6c830cf96012880818c0e1de00d.png",
				"尴尬": "https://i0.hdslb.com/bfs/emote/cb321684ed5ce6eacdc2699092ab8fe7679e4fda.png",
				"冷": "https://i0.hdslb.com/bfs/emote/cb0ebbd0668640f07ebfc0e03f7a18a8cd00b4ed.png",
				"灵魂出窍": "https://i0.hdslb.com/bfs/emote/43d3db7d97343c01b47e22cfabeca84b4251f35a.png",
				"委屈": "https://i0.hdslb.com/bfs/emote/d2f26cbdd6c96960320af03f5514c5b524990840.png",
				"傲娇": "https://i0.hdslb.com/bfs/emote/010540d0f61220a0db4922e4a679a1d8eca94f4e.png",
				"疼": "https://i0.hdslb.com/bfs/emote/905fd9a99ec316e353b9bd4ecd49a5f0a301eabf.png",
				"吓": "https://i0.hdslb.com/bfs/emote/9c10c5ebc7bef27ec641b8a1877674e0c65fea5d.png",
				"生病": "https://i0.hdslb.com/bfs/emote/0f25ce04ae1d7baf98650986454c634f6612cb76.png",
				"吐": "https://i0.hdslb.com/bfs/emote/06946bfe71ac48a6078a0b662181bb5cad09decc.png",
				"嘘声": "https://i0.hdslb.com/bfs/emote/e64af664d20716e090f10411496998095f62f844.png",
				"捂眼": "https://i0.hdslb.com/bfs/emote/c5c6d6982e1e53e478daae554b239f2b227b172b.png",
				"思考": "https://i0.hdslb.com/bfs/emote/cfa9b7e89e4bfe04bbcd34ccb1b0df37f4fa905c.png",
				"再见": "https://i0.hdslb.com/bfs/emote/fc510306bae26c9aec7e287cdf201ded27b065b9.png",
				"翻白眼": "https://i0.hdslb.com/bfs/emote/eba54707c7168925b18f6f8b1f48d532fe08c2b1.png",
				"哈欠": "https://i0.hdslb.com/bfs/emote/888d877729cbec444ddbd1cf4c9af155a7a06086.png",
				"奋斗": "https://i0.hdslb.com/bfs/emote/bb2060c15dba7d3fd731c35079d1617f1afe3376.png",
				"墨镜": "https://i0.hdslb.com/bfs/emote/3a03aebfc06339d86a68c2d893303b46f4b85771.png",
				"撇嘴": "https://i0.hdslb.com/bfs/emote/531863568e5668c5ac181d395508a0eeb1f0cda4.png",
				"难过": "https://i0.hdslb.com/bfs/emote/a651db36701610aa70a781fa98c07c9789b11543.png",
				"抓狂": "https://i0.hdslb.com/bfs/emote/4c87afff88c22439c45b79e9d2035d21d5622eba.png",
				"生气": "https://i0.hdslb.com/bfs/emote/3195714219c4b582a4fb02033dd1519913d0246d.png",
				"视频卫星": "https://i0.hdslb.com/bfs/emote/dce6fc7d6dfeafff01241924db60f8251cca5307.png",
				"十周年": "https://i0.hdslb.com/bfs/emote/1eacd3f7816e70aff9c1b1a2e9605240466f599b.png",
				"11周年": "https://i0.hdslb.com/bfs/emote/d3b2d5dc028c75ae4df379f4c3afbe186d0f6f9b.png",
				"鸡腿": "https://i0.hdslb.com/bfs/emote/c7860392815d345fa69c4f00ef18d67dccfbd574.png",
				"干杯": "https://i0.hdslb.com/bfs/emote/8da12d5f55a2c7e9778dcc05b40571979fe208e6.png",
				"爱心": "https://i0.hdslb.com/bfs/emote/ed04066ea7124106d17ffcaf75600700e5442f5c.png",
				"锦鲤": "https://i0.hdslb.com/bfs/emote/643d6c19c8164ffd89e3e9cdf093cf5d773d979c.png",
				"胜利": "https://i0.hdslb.com/bfs/emote/b49fa9f4b1e7c3477918153b82c60b114d87347c.png",
				"加油": "https://i0.hdslb.com/bfs/emote/c7aaeacb21e107292d3bb053e5abde4a4459ed30.png",
				"保佑": "https://i0.hdslb.com/bfs/emote/fafe8d3de0dc139ebe995491d2dac458a865fb30.png",
				"抱拳": "https://i0.hdslb.com/bfs/emote/89516218158dbea18ab78e8873060bf95d33bbbe.png",
				"响指": "https://i0.hdslb.com/bfs/emote/1b5c53cf14336903e1d2ae3527ca380a1256a077.png",
				"支持": "https://i0.hdslb.com/bfs/emote/3c210366a5585706c09d4c686a9d942b39feeb50.png",
				"拥抱": "https://i0.hdslb.com/bfs/emote/41780a4254750cdaaccb20735730a36044e98ef3.png",
				"怪我咯": "https://i0.hdslb.com/bfs/emote/07cc6077f7f7d75b8d2c722dd9d9828a9fb9e46d.png",
				"跪了": "https://i0.hdslb.com/bfs/emote/f2b3aee7e521de7799d4e3aa379b01be032698ac.png",
				"黑洞": "https://i0.hdslb.com/bfs/emote/e90ec4c799010f25391179118ccd9f66b3b279ba.png",
				"老鼠": "https://i0.hdslb.com/bfs/emote/8e6fb491eb1bb0d5862e7ec8ccf9a3da12b6c155.png",
				"2020": "https://i0.hdslb.com/bfs/emote/dc709fac0d361370bcf0d36d32adb97df7c95824.png",
				"福到了": "https://i0.hdslb.com/bfs/emote/5de5373d354c373cf1617b6b836f3a8d53c5a655.png",
				"加油武汉": "https://i0.hdslb.com/bfs/emote/eb966aaa5b690d3f9308a9f936f5b5a72a7f956b.png",
				"粽子": "https://i0.hdslb.com/bfs/emote/177999fb7d70d891fbf63b161f26b272e08dc1de.png",
				"月饼": "https://i0.hdslb.com/bfs/emote/89b19c5730e08d6f12fadf6996de5bc2e52f81fe.png",
				"高兴": "https://i0.hdslb.com/bfs/emote/416570a8aca7be12fb2c36e4b846906653f6d294.png",
				"气愤": "https://i0.hdslb.com/bfs/emote/069b029d17a086ab475fd331697a649e234850bb.png",
				"耍帅": "https://i0.hdslb.com/bfs/emote/d7a38b08d1f1cc35b19c35041f29ffcc48808e87.png",
				"酷仔": "https://i0.hdslb.com/bfs/emote/390100ada4659b4516984d386499fb22c0025084.png",
				"画风突变": "https://i0.hdslb.com/bfs/emote/ba4de7a3f97644038b15195bdc9f82a8fd118e77.png",
				"福": "https://i0.hdslb.com/bfs/emote/802429a301ac5b35a0480d9526a070ce67cd8097.png",
				"赞了": "https://i0.hdslb.com/bfs/emote/40ded585bbd6328fc390076b5de224fd38b46793.png",
				"暗中观察": "https://i0.hdslb.com/bfs/emote/80a752e0718db211e4135b4ba821813f4c151e2c.png",
				"么么哒": "https://i0.hdslb.com/bfs/emote/2f418440776e88605ddc426eac898202c1f5fa4d.png",
				"哭哭": "https://i0.hdslb.com/bfs/emote/cbf36e518f1d50618f6d054aa69993ecc339fe8f.png",
				"饿了": "https://i0.hdslb.com/bfs/emote/ff91ea94adf7c5b04db305c18d17b444f7360059.png",
				"问号": "https://i0.hdslb.com/bfs/emote/a905b58b32016a1f0ff7d9193b62749f0d491707.png",
				"嘿嘿": "https://i0.hdslb.com/bfs/emote/8a15a45e228179f912ce11dbd5478f6ad54e9854.png",
				"卖萌": "https://i0.hdslb.com/bfs/emote/a0d37b43d1e786ba811d9b0ae590c479dcce6c44.png",
				"喵": "https://i0.hdslb.com/bfs/emote/eb46e78c9d86ccbe9842f0235c7cb4f4e0e80a57.png",
				"tv-白眼": "https://i0.hdslb.com/bfs/emote/c1d59f439e379ee50eef488bcb5e5378e5044ea4.png",
				"tv-doge": "https://i0.hdslb.com/bfs/emote/6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png",
				"tv-坏笑": "https://i0.hdslb.com/bfs/emote/1f0b87f731a671079842116e0991c91c2c88645a.png",
				"tv-难过": "https://i0.hdslb.com/bfs/emote/87f46748d3f142ebc6586ff58860d0e2fc8263ba.png",
				"tv-生气": "https://i0.hdslb.com/bfs/emote/26702dcafdab5e8225b43ffd23c94ac1ff932654.png",
				"tv-委屈": "https://i0.hdslb.com/bfs/emote/d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png",
				"tv-斜眼笑": "https://i0.hdslb.com/bfs/emote/911f987aa8bc1bee12d52aafe62bc41ef4474e6c.png",
				"tv-呆": "https://i0.hdslb.com/bfs/emote/fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png",
				"tv-发怒": "https://i0.hdslb.com/bfs/emote/34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png",
				"tv-惊吓": "https://i0.hdslb.com/bfs/emote/0d15c7e2ee58e935adc6a7193ee042388adc22af.png",
				"tv-呕吐": "https://i0.hdslb.com/bfs/emote/9f996894a39e282ccf5e66856af49483f81870f3.png",
				"tv-思考": "https://i0.hdslb.com/bfs/emote/90cf159733e558137ed20aa04d09964436f618a1.png",
				"tv-微笑": "https://i0.hdslb.com/bfs/emote/70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png",
				"tv-疑问": "https://i0.hdslb.com/bfs/emote/0793d949b18d7be716078349c202c15ff166f314.png",
				"tv-大哭": "https://i0.hdslb.com/bfs/emote/23269aeb35f99daee28dda129676f6e9ea87934f.png",
				"tv-鼓掌": "https://i0.hdslb.com/bfs/emote/1d21793f96ef4e6f48b23e53e3b9e42da833a0f6.png",
				"tv-抠鼻": "https://i0.hdslb.com/bfs/emote/c666f55e88d471e51bbd9fab9bb308110824a6eb.png",
				"tv-亲亲": "https://i0.hdslb.com/bfs/emote/a8111ad55953ef5e3be3327ef94eb4a39d535d06.png",
				"tv-调皮": "https://i0.hdslb.com/bfs/emote/b9c41de8e82dd7a8515ae5e3cb63e898bf245186.png",
				"tv-笑哭": "https://i0.hdslb.com/bfs/emote/1abc628f6d4f4caf9d0e7800878f4697abbc8273.png",
				"tv-晕": "https://i0.hdslb.com/bfs/emote/5443c22b4d07fb1907ccc610c8e6db254f2461b7.png",
				"tv-点赞": "https://i0.hdslb.com/bfs/emote/f85c354995bd99e28fc76c869bfe42ba6438eff4.png",
				"tv-害羞": "https://i0.hdslb.com/bfs/emote/a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png",
				"tv-睡着": "https://i0.hdslb.com/bfs/emote/8b196675b53af58264f383c50ad0945048290b33.png",
				"tv-色": "https://i0.hdslb.com/bfs/emote/61822c7e9aae5da76475e7892534545336b23a6f.png",
				"tv-吐血": "https://i0.hdslb.com/bfs/emote/09dd16a7aa59b77baa1155d47484409624470c77.png",
				"tv-无奈": "https://i0.hdslb.com/bfs/emote/ea8ed89ee9878f2fece2dda0ea8a5dbfe21b5751.png",
				"tv-再见": "https://i0.hdslb.com/bfs/emote/180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png",
				"tv-流汗": "https://i0.hdslb.com/bfs/emote/cead1c351ab8d79e9f369605beb90148db0fbed3.png",
				"tv-偷笑": "https://i0.hdslb.com/bfs/emote/bb690d4107620f1c15cff29509db529a73aee261.png",
				"tv-抓狂": "https://i0.hdslb.com/bfs/emote/fe31c08edad661d63762b04e17b8d5ae3c71a757.png",
				"tv-黑人问号": "https://i0.hdslb.com/bfs/emote/45821a01f51bc867da9edbaa2e070410819a95b2.png",
				"tv-困": "https://i0.hdslb.com/bfs/emote/241ee304e44c0af029adceb294399391e4737ef2.png",
				"tv-打脸": "https://i0.hdslb.com/bfs/emote/56ab10b624063e966bfcb76ea5dc4794d87dfd47.png",
				"tv-闭嘴": "https://i0.hdslb.com/bfs/emote/c9e990da7f6e93975e25fd8b70e2e290aa4086ef.png",
				"tv-鄙视": "https://i0.hdslb.com/bfs/emote/6e72339f346a692a495b123174b49e4e8e781303.png",
				"tv-腼腆": "https://i0.hdslb.com/bfs/emote/89712c0d4af73e67f89e35cbc518420380a7f6f4.png",
				"tv-馋": "https://i0.hdslb.com/bfs/emote/fc7e829b845c43c623c8b490ee3602b7f0e76a31.png",
				"tv-可爱": "https://i0.hdslb.com/bfs/emote/9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png",
				"tv-发财": "https://i0.hdslb.com/bfs/emote/34db290afd2963723c6eb3c4560667db7253a21a.png",
				"tv-生病": "https://i0.hdslb.com/bfs/emote/8b0ec90e6b86771092a498c54f09fc94621c1900.png",
				"tv-流鼻血": "https://i0.hdslb.com/bfs/emote/c32d39db2737f89b904ca32700d140a9241b0767.png",
				"tv-尴尬": "https://i0.hdslb.com/bfs/emote/7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png",
				"tv-大佬": "https://i0.hdslb.com/bfs/emote/093c1e2c490161aca397afc45573c877cdead616.png",
				"tv-流泪": "https://i0.hdslb.com/bfs/emote/7e71cde7858f0cd50d74b0264aa26db612a8a167.png",
				"tv-冷漠": "https://i0.hdslb.com/bfs/emote/b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png",
				"tv-皱眉": "https://i0.hdslb.com/bfs/emote/72ccad6679fea0d14cce648b4d818e09b8ffea2d.png",
				"tv-鬼脸": "https://i0.hdslb.com/bfs/emote/0ffbbddf8a94d124ca2f54b360bbc04feb6bbfea.png",
				"tv-调侃": "https://i0.hdslb.com/bfs/emote/4bc022533ef31544ca0d72c12c808cf4a1cce3e3.png",
				"tv-目瞪口呆": "https://i0.hdslb.com/bfs/emote/0b8cb81a68de5d5365212c99375e7ace3e7891b7.png",
				"热词系列-知识增加": "https://i0.hdslb.com/bfs/emote/142409b595982b8210b2958f3d340f3b47942645.png",
				"热词系列-好家伙": "https://i0.hdslb.com/bfs/emote/63ec80dea3066bd9f449ba999ba531fa61f7b4eb.png",
				"热词系列-芜湖起飞": "https://i0.hdslb.com/bfs/emote/78d04c6ce78a613c90d510cd45fe7e25c57ba00b.png",
				"热词系列-爷青回": "https://i0.hdslb.com/bfs/emote/a26189ff1e681bddef7f6533f9aabe7604731a3e.png",
				"热词系列-梦幻联动": "https://i0.hdslb.com/bfs/emote/4809416be5ca787c2ec3e897e4fd022a58da6e0e.png",
				"热词系列-泪目": "https://i0.hdslb.com/bfs/emote/bba3703ab90b7d16fe9dbcb85ed949db687f8331.png",
				"热词系列-保护": "https://i0.hdslb.com/bfs/emote/55f8f6445ca7c3170cdfc5b16036abf639ce9b57.png",
				"热词系列-害怕": "https://i0.hdslb.com/bfs/emote/d77e2de26da143249f0c0ad7a608c27152c985bf.png",
				"热词系列-爱了爱了": "https://i0.hdslb.com/bfs/emote/2a165b555ba20391316366c664ed7891883dc5aa.png",
				"热词系列-吹爆": "https://i0.hdslb.com/bfs/emote/b528220f9c37256ed6a37f05bf118e44b08b81e5.png",
				"热词系列-三连": "https://i0.hdslb.com/bfs/emote/21f15fe11b7a84d2f2121c16dec50a4e4556f865.png",
				"热词系列-可以": "https://i0.hdslb.com/bfs/emote/e08543c71202b36c590094417fcfbb80c3506cd8.png",
				"热词系列-希望没事": "https://i0.hdslb.com/bfs/emote/6c0d2e6c486d1ba5afd6204a96e102652464a01d.png",
				"热词系列-打卡": "https://i0.hdslb.com/bfs/emote/a9cf77c78e1b9b40aa3ed4862402fba008ee2f51.png",
				"热词系列-skr": "https://i0.hdslb.com/bfs/emote/bd285ff94db16ad52557c3effe930d64663e8375.png",
				"热词系列-battle": "https://i0.hdslb.com/bfs/emote/f2f81c8e47db6252becd633a5d1ee14e15df2ea8.png",
				"热词系列-DNA": "https://i0.hdslb.com/bfs/emote/f6eb74f8230588f61a298af89061a7d75c5762e5.png",
				"热词系列-妙啊": "https://i0.hdslb.com/bfs/emote/0e98299d7decf5eaffad854977946075c3e91cb8.png",
				"热词系列-这次一定": "https://i0.hdslb.com/bfs/emote/a01ca28923daa7cc896c42f27deb4914e20dd572.png",
				"热词系列-AWSL": "https://i0.hdslb.com/bfs/emote/c37f88cf799f9badf9d84b7671dc3dd98c0fc0c2.png",
				"热词系列-递话筒": "https://i0.hdslb.com/bfs/emote/98e6950e39fbb4dd1c576042063ca632074070ba.png",
				"热词系列-你细品": "https://i0.hdslb.com/bfs/emote/535e00658e7e47966f154d3a167fa2365ebc4321.png",
				"热词系列-咕咕": "https://i0.hdslb.com/bfs/emote/d8065c2e7ce48c929317a94553499a46fecc262a.png",
				"热词系列-标准结局": "https://i0.hdslb.com/bfs/emote/3de98174b510cf7dc5fd1bd08c5d881065e79137.png",
				"热词系列-危": "https://i0.hdslb.com/bfs/emote/5cc6c3357c4df544dd8de9d5c5c0cec97c7c9a56.png",
				"热词系列-张三": "https://i0.hdslb.com/bfs/emote/255a938f39cea625032b6650036b31aa26c50a3c.png",
				"热词系列-害": "https://i0.hdslb.com/bfs/emote/cbe798a194612958537c5282fcca7c3bcd2aa15c.png",
				"热词系列-我裂开了": "https://i0.hdslb.com/bfs/emote/29bd57ec4e8952880fea6c9e47aee924e91f10c4.png",
				"热词系列-有内味了": "https://i0.hdslb.com/bfs/emote/7ca61680a905b5b6e2e335c630e725b648b03b4d.png",
				"热词系列-猛男必看": "https://i0.hdslb.com/bfs/emote/c97064450528a0e45c7e7c365a15fbb13fd61d8c.png",
				"热词系列-奥力给": "https://i0.hdslb.com/bfs/emote/c9b8683827ec6c00fea5327c9bec14f581cef2aa.png",
				"热词系列-问号": "https://i0.hdslb.com/bfs/emote/c1d1e76c12180adc8558f47006fe0e7ded4154bb.png",
				"热词系列-我哭了": "https://i0.hdslb.com/bfs/emote/9e0b3877d649aaf6538fbdd3f937e240a9d808e4.png",
				"热词系列-高产": "https://i0.hdslb.com/bfs/emote/9db817cba4a7f4a42398f3b2ec7c0a8e0c247c42.png",
				"热词系列-我酸了": "https://i0.hdslb.com/bfs/emote/a8cbf3f6b8cd9377eeb15b9172f3cd683b2e4650.png",
				"热词系列-真香": "https://i0.hdslb.com/bfs/emote/e68497c775feaac1c3b1a6cd63a50cfb11b767c4.png",
				"热词系列-我全都要": "https://i0.hdslb.com/bfs/emote/d424d1ad8d14c1c9b8367842bc68c658b9229bc1.png",
				"热词系列-神仙UP": "https://i0.hdslb.com/bfs/emote/a49e0d0db1e7d35a0f7411be13208951ab448f03.png",
				"热词系列-你币有了": "https://i0.hdslb.com/bfs/emote/84820c2b147a8ca02f3c4006b63f76c6313cbfa0.png",
				"热词系列-不愧是你": "https://i0.hdslb.com/bfs/emote/9ff2e356797c57ee3b1675ade0883d2d2247be9b.png",
				"热词系列-锤": "https://i0.hdslb.com/bfs/emote/35668cc12ae25b9545420e4a85bf21a0bfc03e5d.png",
				"热词系列-秀": "https://i0.hdslb.com/bfs/emote/50782fbf5d9b7f48f9467b5c53932981e321eedc.png",
				"热词系列-爷关更": "https://i0.hdslb.com/bfs/emote/faad40c56447f1f8abcb4045c17ce159d113d1fd.png",
				"热词系列-有生之年": "https://i0.hdslb.com/bfs/emote/f41fdafe2d0fbb8e8bc1598d2cf37e355560103a.png",
				"热词系列-镇站之宝": "https://i0.hdslb.com/bfs/emote/24e7a6a6e6383c987215fb905e3ee070aca259b5.png",
				"热词系列-我太南了": "https://i0.hdslb.com/bfs/emote/a523f3e4c63e4db1232365765d0ec452f83be97e.png",
				"热词系列-完结撒花": "https://i0.hdslb.com/bfs/emote/ea9db62ff5bca8e069cd70c4233353a802835422.png",
				"热词系列-大师球": "https://i0.hdslb.com/bfs/emote/f30089248dd137c568edabcb07cf67e0f6e98cf3.png",
				"热词系列-知识盲区": "https://i0.hdslb.com/bfs/emote/ccc94600b321a28116081e49ecedaa4ee8728312.png",
				"热词系列-“狼火”": "https://i0.hdslb.com/bfs/emote/33ccd3617bfa89e9d1498b13b7542b63f163e5de.png",
				"热词系列-你可真星": "https://i0.hdslb.com/bfs/emote/54c8ddff400abfe388060cabfbb579280fdea1be.png",
				"2233娘-大笑": "https://i0.hdslb.com/bfs/emote/16b8794be990cefa6caeba4d901b934a227ee3b8.png",
				"2233娘-吃惊": "https://i0.hdslb.com/bfs/emote/d1628c43d35b1530c0504a643ff80b6189fa0a43.png",
				"2233娘-大哭": "https://i0.hdslb.com/bfs/emote/476a2a60f6e337b8c0697a592e0aa82781f6b33b.png",
				"2233娘-耶": "https://i0.hdslb.com/bfs/emote/d7178e258a0efc969b65ccc2b1322fb235f5dff4.png",
				"2233娘-卖萌": "https://i0.hdslb.com/bfs/emote/ea893aa25355de95ab4f03c2dad3f0c58d0c159e.png",
				"2233娘-疑问": "https://i0.hdslb.com/bfs/emote/0b41f509351958dbb63d472fec0132d1bd03bd14.png",
				"2233娘-汗": "https://i0.hdslb.com/bfs/emote/247cd9df8cdf84b18368c21e3b2dd374e84c0927.png",
				"2233娘-困惑": "https://i0.hdslb.com/bfs/emote/714eeb4eae0d0933b4ff08b7df788b1982f6b940.png",
				"2233娘-怒": "https://i0.hdslb.com/bfs/emote/f31953119c51b9748016440ac0b632f779929b37.png",
				"2233娘-委屈": "https://i0.hdslb.com/bfs/emote/d9d0bf9d358af8d5761093ec66d4e3f60d963a63.png",
				"2233娘-郁闷": "https://i0.hdslb.com/bfs/emote/485203fe7100f2c8fc40b2800a18fe20b35f2f1a.png",
				"2233娘-第一": "https://i0.hdslb.com/bfs/emote/3754ee6e5985bd0bd7dfb668981f2a8733398ebd.png",
				"2233娘-喝水": "https://i0.hdslb.com/bfs/emote/695bf5429472049b52c1e0de586f8a2511195a23.png",
				"2233娘-吐魂": "https://i0.hdslb.com/bfs/emote/e999af499edf38a91ca68b1a9d2f97042c1d6734.png",
				"2233娘-无言": "https://i0.hdslb.com/bfs/emote/fdb5870f32cfaf7949e0f88a13f6feba4a48b719.png",
				"小电视-笑": "https://i0.hdslb.com/bfs/emote/f80d384875183dfe2e24be13011c595c0210d273.png",
				"小电视-发愁": "https://i0.hdslb.com/bfs/emote/05e279abbf3f72d5cc45548504a4220c5514b8b9.png",
				"小电视-赞": "https://i0.hdslb.com/bfs/emote/86ccf6d0b5480169bf80f3582fae09d7ed455c06.png",
				"小电视-差评": "https://i0.hdslb.com/bfs/emote/38456e3bde2839b00b536a8be13934fa57c8e298.png",
				"小电视-嘟嘴": "https://i0.hdslb.com/bfs/emote/6fd437f547ef1e4f231ff475d02f58bb94cef5a5.png",
				"小电视-汗": "https://i0.hdslb.com/bfs/emote/5c150cec77eae1b05d5ca46526450ff3beeb44d2.png",
				"小电视-害羞": "https://i0.hdslb.com/bfs/emote/de3aee88f7b6cc20ba9480c96c02f83a844381a9.png",
				"小电视-吃惊": "https://i0.hdslb.com/bfs/emote/05188008ea84c70d94e0076e28de15bf56f4c441.png",
				"小电视-哭泣": "https://i0.hdslb.com/bfs/emote/938bdf98df945576ae88e2a22931db07ded9e663.png",
				"小电视-太太喜欢": "https://i0.hdslb.com/bfs/emote/eb41a8c04840e4f77e76a4bff7a29ac89c432f4e.png",
				"小电视-好怒啊": "https://i0.hdslb.com/bfs/emote/68d524b7e515396b6563d320fb710c64abfb1063.png",
				"小电视-困惑": "https://i0.hdslb.com/bfs/emote/6853161f0eab3332b874ab7c6c0311035b7538f3.png",
				"小电视-我好兴奋": "https://i0.hdslb.com/bfs/emote/a695fe1301aab2675ab6f6e34757c25a863a8617.png",
				"小电视-思索": "https://i0.hdslb.com/bfs/emote/f8219e484d5a55787c3f1722dc3112d0eba03a69.png",
				"小电视-无语": "https://i0.hdslb.com/bfs/emote/fbd12affebfdaadd3d721bffdb685a6b1ee71219.png",
				"罗小黑-鼓掌": "https://i0.hdslb.com/bfs/emote/622ce9f5ec001269203aaaf8339dffdc7d67d2a3.png",
				"罗小黑-你好呀": "https://i0.hdslb.com/bfs/emote/65728d4bedb13fd75c1555c9c4c9de67d276b153.png",
				"罗小黑-加油": "https://i0.hdslb.com/bfs/emote/50d9d9e5f57c202be83cdfdba812a15524d02406.png",
				"罗小黑-可可爱爱": "https://i0.hdslb.com/bfs/emote/bcdfa28cd019333cdb243c3a8d73374236924585.png",
				"罗小黑-吃瓜": "https://i0.hdslb.com/bfs/emote/57d8965331c9fb87afa1756416b622a22e406c43.png",
				"罗小黑-嗨": "https://i0.hdslb.com/bfs/emote/7f5e00355af3331964884f27611cc9a0c64e5ce7.png",
				"罗小黑-大麦": "https://i0.hdslb.com/bfs/emote/0f5a51e0272c5fcc2c318e078e92e0f8fea77980.png",
				"罗小黑-干杯": "https://i0.hdslb.com/bfs/emote/04cf6b7a2f0f24909e1894694daa5c6c668e1f17.png",
				"罗小黑-找彩蛋": "https://i0.hdslb.com/bfs/emote/59e34db87c0cb601a5e100c2db0ccfb2894aa02f.png",
				"罗小黑-撒花": "https://i0.hdslb.com/bfs/emote/bbaaaa40328f32f3e3e41ffc77a70c057d0a13ad.png",
				"罗小黑-来了": "https://i0.hdslb.com/bfs/emote/fd1950da6509171ba144d138c4d0a81f0840794e.png",
				"罗小黑-歪在吗": "https://i0.hdslb.com/bfs/emote/0caf23cc530b0e021c32c623dee045160a2449fa.png",
				"罗小黑-求包养": "https://i0.hdslb.com/bfs/emote/2277c2b72646cf22a7217897f3cd62c5c80a6451.png",
				"罗小黑-看电影": "https://i0.hdslb.com/bfs/emote/eedd49d8d1d6c5b0eafc3e0a10966f508a7ab6f1.png",
				"罗小黑-真棒": "https://i0.hdslb.com/bfs/emote/f03fbb80a7939eafa4819388df80e9c777e8ab7d.png",
				"罗小黑-自来水": "https://i0.hdslb.com/bfs/emote/4a0c602ed9d4f1e5550c0595ea63653a9cbf88bd.png",
				"蛆音娘-卖萌": "https://i0.hdslb.com/bfs/emote/4cd1024d0c2ecee93224477946656d32c1705ccf.png",
				"蛆音娘-吃瓜群众": "https://i0.hdslb.com/bfs/emote/5d0d6cc54b508d30b4f50b6b5f7b7e1e259d84ea.png",
				"蛆音娘-吃惊": "https://i0.hdslb.com/bfs/emote/7a4cb0b644214d476ce198ddf6a7a0aa31311199.png",
				"蛆音娘-害怕": "https://i0.hdslb.com/bfs/emote/7407634bf67bfe9d7806f15d57608a1b18c2b4c2.png",
				"蛆音娘-扶额": "https://i0.hdslb.com/bfs/emote/a4d8f95baaa24821fd591a7dbeee1b869e760f59.png",
				"蛆音娘-滑稽": "https://i0.hdslb.com/bfs/emote/d3717f10ffe9787336bc39a09214270988521a67.png",
				"蛆音娘-哼": "https://i0.hdslb.com/bfs/emote/8854f1b8a82126e3b87f3a1563da5feb55b23e71.png",
				"蛆音娘-机智": "https://i0.hdslb.com/bfs/emote/e543c0a823ca915df9362283f4ae950e9e9cc2e9.png",
				"蛆音娘-哭泣": "https://i0.hdslb.com/bfs/emote/a23055546c19eba663b16370b8e072394d87ff53.png",
				"蛆音娘-睡觉觉": "https://i0.hdslb.com/bfs/emote/40ef7e6d931acb37e5514b70d13663e86dc3698b.png",
				"蛆音娘-生气": "https://i0.hdslb.com/bfs/emote/bf398cbbcfaae107d1b59aaf03895f38422e3d87.png",
				"蛆音娘-偷看": "https://i0.hdslb.com/bfs/emote/52463ded4f23649db10ba3ced662ed946c5edf0b.png",
				"蛆音娘-吐血": "https://i0.hdslb.com/bfs/emote/5772d22015e5b2b40a9fe302b5967ec7282ac848.png",
				"蛆音娘-无语": "https://i0.hdslb.com/bfs/emote/b6c763c6484ce2e48299ceb21861e46318868871.png",
				"蛆音娘-摇头": "https://i0.hdslb.com/bfs/emote/b7278f750c6f2235f41f37056d727f25d3bf781f.png",
				"蛆音娘-疑问": "https://i0.hdslb.com/bfs/emote/7750b698d15a1b8e83c0f59106e8e9cd5cb57897.png",
				"蛆音娘-die": "https://i0.hdslb.com/bfs/emote/52543025a070fde5c01a10320c9636ec3173ac99.png",
				"蛆音娘-OK": "https://i0.hdslb.com/bfs/emote/52a0dcee66c91bf123bf53bd48a269b1317d17f9.png",
				"蛆音娘-肥皂": "https://i0.hdslb.com/bfs/emote/7f1a857e9430dcf3050ce0ef5fa19aefebea6dc4.png",
				"蛆音娘-大笑": "https://i0.hdslb.com/bfs/emote/1d3355fb89c24ab3c50e5c152d8b990a290dc63e.png",
				"洛天依-傲娇": "https://i0.hdslb.com/bfs/emote/5d7c8307af10540909fce6121066249df3935a24.png",
				"洛天依-吃包群众": "https://i0.hdslb.com/bfs/emote/f8cdabfc1b81fd25b85b8457ee49a20a4fc5d91b.png",
				"洛天依-吃药": "https://i0.hdslb.com/bfs/emote/883e6654176ebcecafd3e52efa8ee842357e18a0.png",
				"洛天依-滑稽": "https://i0.hdslb.com/bfs/emote/692cef7ca51f935aaa499de7e4d6048c53f42324.png",
				"洛天依-哈哈哈": "https://i0.hdslb.com/bfs/emote/677c2f5555c1e79fc336a6283fdbbdc7ea88fec4.png",
				"洛天依-看透一切": "https://i0.hdslb.com/bfs/emote/4fac414b5002c3739b1ae24f2fc27b5f150ade24.png",
				"洛天依-打尻": "https://i0.hdslb.com/bfs/emote/2ab983b2519dc241666254de8e5352fbeedc96bb.png",
				"洛天依-前排": "https://i0.hdslb.com/bfs/emote/fbbc45e7aee2f256f691df539db0cfcc35b3be7d.png",
				"洛天依-去吧": "https://i0.hdslb.com/bfs/emote/0edeeb0d10d44302854e636c47f5dc3aa96a9206.png",
				"洛天依-冷漠": "https://i0.hdslb.com/bfs/emote/5f4385db3c9806b08ea15bd9ff444af9d9fe0c3a.png",
				"洛天依-可以": "https://i0.hdslb.com/bfs/emote/967377b83e37a0d5dd13bc0f4e4323abf10e4cbf.png",
				"洛天依-掀桌": "https://i0.hdslb.com/bfs/emote/803129b7a1143faabc63c2648335b7d506229e7a.png",
				"洛天依-消灭你": "https://i0.hdslb.com/bfs/emote/d96dccf8fa248ee34c7e4aba94e813bec28d2dd8.png",
				"洛天依-阴阳先生": "https://i0.hdslb.com/bfs/emote/65e195a8ac54bb678dd1c1e6ce6c5d4ba02761b3.png",
				"洛天依-无言以对": "https://i0.hdslb.com/bfs/emote/9cfd368b370acd40c1b8f933cec3fb24883356a5.png",
				"洛天依-？？？": "https://i0.hdslb.com/bfs/emote/f5f1ebe50c26d5f6d4e17cb983bd5ae59f103dda.png",
				"洛天依-爱你哦": "https://i0.hdslb.com/bfs/emote/7102c9e25359af8348489ff8529b3bb2c5bd05d0.png",
				"小A和小B-喝茶": "https://i0.hdslb.com/bfs/emote/d2acc1227312dd64284d809ab66d3c7f7d8ec020.png",
				"小A和小B-报警": "https://i0.hdslb.com/bfs/emote/7f482b82a3de44ae14537cbafcbc40cf65f7113e.png",
				"小A和小B-大哭": "https://i0.hdslb.com/bfs/emote/77545a5e420e2c43e0e4a7996a71769638ae3f90.png",
				"小A和小B-低头": "https://i0.hdslb.com/bfs/emote/0d23b726b084280f941f14919ce63c43f8bc724c.png",
				"小A和小B-哈哈哈哈": "https://i0.hdslb.com/bfs/emote/6f5210b7d0a6b14f586df1f91f5c3a46c1296b43.png",
				"小A和小B-司令": "https://i0.hdslb.com/bfs/emote/a594a91717e28bdcab82821086a41160a1345c45.png",
				"小A和小B-撒花": "https://i0.hdslb.com/bfs/emote/874d2c39a0ca891abce5e65fafc287e0c2d3bbea.png",
				"小A和小B-摊手": "https://i0.hdslb.com/bfs/emote/6f058f78bce5d1c9b370c3807c891e685bb68a17.png",
				"小A和小B-问号": "https://i0.hdslb.com/bfs/emote/f077d5ecf0e86f24991a104f995b3a652091d529.png",
				"小A和小B-躺": "https://i0.hdslb.com/bfs/emote/9038d450dbadaf132847d67cb26931aa5bf76d4c.png",
				"小A和小B-无语": "https://i0.hdslb.com/bfs/emote/1a805b885a1691e9bf4425164a9400e2457f4d1b.png",
				"小A和小B-应援": "https://i0.hdslb.com/bfs/emote/af8f017e383a1999e26a7f91c3ec3c83fbb7ba77.png",
				"小A和小B-NO": "https://i0.hdslb.com/bfs/emote/ee0de8296b20d295b79ea9b70ca4f126eb4aff1d.png",
				"小A和小B-OK": "https://i0.hdslb.com/bfs/emote/5ae25cc388c59192133f08345e461098fad4e63b.png",
				"小A和小B-吃瓜": "https://i0.hdslb.com/bfs/emote/70776b579d2952580249ac6a52e724850d037591.png",
				"小A和小B-捕捉": "https://i0.hdslb.com/bfs/emote/8bf33ff2f9699286102fb1a256a2523695c17d35.png",
				"芮小凸小凹-嗯？": "https://i0.hdslb.com/bfs/emote/f3c72e045ebd2487a381f50291be15b053767a80.png",
				"芮小凸小凹-超棒": "https://i0.hdslb.com/bfs/emote/987947c1bdac0bc10b684f28baaec78176023b83.png",
				"芮小凸小凹-哎": "https://i0.hdslb.com/bfs/emote/38bcf3a53b34551e5efa0cd0ee84fc7faa477a49.png",
				"芮小凸小凹-666": "https://i0.hdslb.com/bfs/emote/3e505cef421024a650b971c1f2db7f8ef1ad1840.png",
				"芮小凸小凹-哼": "https://i0.hdslb.com/bfs/emote/92e4a9d422f1604f2b1b3ea3f6057636273db56e.png",
				"芮小凸小凹-怀疑": "https://i0.hdslb.com/bfs/emote/587f22aa1cfaa4b2d91928998e023be29d8c3975.png",
				"芮小凸小凹-发现": "https://i0.hdslb.com/bfs/emote/147b6ba27d5cbb90d155f34c41cb45f1f00b6007.png",
				"芮小凸小凹-绝望": "https://i0.hdslb.com/bfs/emote/22ad072a785604f3bd8c1aae4ea1ceb1e4694cec.png",
				"芮小凸小凹-可爱": "https://i0.hdslb.com/bfs/emote/8bddb47b5877fd79e937aafeb7f4d69f58a8b6e4.png",
				"芮小凸小凹-警告": "https://i0.hdslb.com/bfs/emote/54607206c814409a99fac65fb3b780c6bbd1e60d.png",
				"芮小凸小凹-呵呵": "https://i0.hdslb.com/bfs/emote/811aa3ba5809a8d5936f988f953e5af7fd7c5351.png",
				"芮小凸小凹-膜拜": "https://i0.hdslb.com/bfs/emote/038c86c0e616f7ead667c6f7af32e54feac32965.png",
				"芮小凸小凹-哭": "https://i0.hdslb.com/bfs/emote/000c0dddd08950133740487a57873b389a3af457.png",
				"芮小凸小凹-无聊": "https://i0.hdslb.com/bfs/emote/62527ee5c4e80aad9b42069778c91f905c90d986.png",
				"芮小凸小凹-围观": "https://i0.hdslb.com/bfs/emote/c9b4fe6161f4a3cc884a5b03e9674c8a58ee228f.png",
				"芮小凸小凹-失落": "https://i0.hdslb.com/bfs/emote/813f98c0632587286c6e809a49eda15a2edfa447.png",
				"芮小凸小凹-是吗": "https://i0.hdslb.com/bfs/emote/05b7153fb606e526ce8d102febd25889828ce425.png",
				"芮小凸小凹-心动": "https://i0.hdslb.com/bfs/emote/24afe39fbf8755a28673bdf51bdf8ce72bc62d51.png",
				"芮小凸小凹-喜欢": "https://i0.hdslb.com/bfs/emote/b389e30a3c7924ca2b59a5333412b8d92cad07df.png",
				"芮小凸小凹-嘻嘻": "https://i0.hdslb.com/bfs/emote/b7a4a07a7c24f5fa23a99ca6749708fadfedf765.png",
				"芮小凸小凹-震撼": "https://i0.hdslb.com/bfs/emote/79c8b68509a9d316618d61aedaae93097669dae6.png",
				"芮小凸小凹-有见解": "https://i0.hdslb.com/bfs/emote/7f842228b9a2c36851cecab0527fca55a1f01b58.png",
				"芮小凸小凹-震惊": "https://i0.hdslb.com/bfs/emote/be4b48350b817af496bdccba2ab85c77b711cec3.png",
				"芮小凸小凹-心痛": "https://i0.hdslb.com/bfs/emote/b2217e8b81f122949f3960d99c08ac72eac5923b.png",
				"灵笼-鄙视": "https://i0.hdslb.com/bfs/emote/20eda4b6b0074c6fb568e11698eb8dfc57011ac1.png",
				"灵笼-不用了": "https://i0.hdslb.com/bfs/emote/a7a027228e024d13f743ee42d9be107d53464134.png",
				"灵笼-吃瓜": "https://i0.hdslb.com/bfs/emote/2e0cab7ca9bedcb00830b483725fcc9c314faaf8.png",
				"灵笼-吃糖": "https://i0.hdslb.com/bfs/emote/c65e3e8dd67a7a7ce438649d5d1544e4eba0c3a6.png",
				"灵笼-机智": "https://i0.hdslb.com/bfs/emote/4e0e67f242b29c39bd9f8bbc03ab31e1ce232d37.png",
				"灵笼-惊吓": "https://i0.hdslb.com/bfs/emote/7b7fd1cdaccb0a69c2cdfe2a5fe8b97524ebf1d8.png",
				"灵笼-生闷气": "https://i0.hdslb.com/bfs/emote/9fe2340ff00fa447cac6ffd64650fc0842a2a4de.png",
				"灵笼-玩手机": "https://i0.hdslb.com/bfs/emote/c40b4dc357514724eeabbc94b26e89a9850466b6.png",
				"灵笼-问号": "https://i0.hdslb.com/bfs/emote/5b1a7af13e40057a9f48c802241e230bd0f3bcf4.png",
				"灵笼-嫌弃": "https://i0.hdslb.com/bfs/emote/8386721ed1e19c7b1e268a6457bbd3463ab220c0.png",
				"灵笼-笑哭": "https://i0.hdslb.com/bfs/emote/bfa87db44e8758701b7452f5b0aa2f107f69ec0f.png",
				"灵笼-兴奋": "https://i0.hdslb.com/bfs/emote/b211b575c45d1f0ebb347e06999b3dbe7c256c64.png",
				"灵笼-阴暗": "https://i0.hdslb.com/bfs/emote/92cd50cd6a4fd863751be57ef2b82e4d965955aa.png",
				"灵笼-约吗": "https://i0.hdslb.com/bfs/emote/275c161b17c3a4bdda2833720989a67b2e5b264d.png",
				"灵笼-boom": "https://i0.hdslb.com/bfs/emote/e27fbd34d8232f9c69b53a2b7013a3b597086444.png",
				"灵笼-偷窥": "https://i0.hdslb.com/bfs/emote/4c1f0ba96b2baa6d44f33553d0298d63ec47bfbd.png",
				"正经人-欢呼": "https://i0.hdslb.com/bfs/emote/3cd297676b2a08a896deab91ed7f139a8bc7c46c.png",
				"正经人-火": "https://i0.hdslb.com/bfs/emote/78579a24b156501c0b5583121beb42a72e9229b5.png",
				"正经人-挤": "https://i0.hdslb.com/bfs/emote/7a3e753fcb876753800424edd2fa3563005abf4a.png",
				"正经人-惊": "https://i0.hdslb.com/bfs/emote/233b14fd3803a5078f79d31fecd5d7a60524e330.png",
				"正经人-放屁": "https://i0.hdslb.com/bfs/emote/b590df4714084b012e9a5dfab03a3a13936dff48.png",
				"正经人-ok": "https://i0.hdslb.com/bfs/emote/21e069065373be45b227a4ffdbe9570d309e3d05.png",
				"正经人-趴": "https://i0.hdslb.com/bfs/emote/39156acb0afcbde9cf73ac1657adff62d3a84af7.png",
				"正经人-开始": "https://i0.hdslb.com/bfs/emote/4f745fad9a77f2f41ea63c2214af0739ab7ea8f1.png",
				"正经人-揉脸": "https://i0.hdslb.com/bfs/emote/a9d5376d6d79482c4447eb5a169385fa91f39ddd.png",
				"正经人-躺": "https://i0.hdslb.com/bfs/emote/c135f76ad7ec50a7414095cf7c633eb5551c9fe3.png",
				"正经人-拉": "https://i0.hdslb.com/bfs/emote/03e7319b34763e9c82c2ae93b1fd8f613335d90a.png",
				"正经人-心": "https://i0.hdslb.com/bfs/emote/536561d0806f8b181473fd89bba15e71cb8d585e.png",
				"正经人-悠闲": "https://i0.hdslb.com/bfs/emote/17542aaef102f28508e30fed8895cc1afeaf70f0.png",
				"正经人-赞": "https://i0.hdslb.com/bfs/emote/589816d36c5b7c2f2bc78cb162d6ac90fda948f2.png",
				"正经人-哭": "https://i0.hdslb.com/bfs/emote/b9882f0679b4ae24624660412464f1f88bda48fe.png",
				"请吃红小豆吧！-wow": "https://i0.hdslb.com/bfs/emote/3392ba98d2bbdc4c1932952bf63796f7ac1b1f41.png",
				"请吃红小豆吧！-吃包": "https://i0.hdslb.com/bfs/emote/f6cbadf8ff006c246c7bd583288587a6e20e6069.png",
				"请吃红小豆吧！-倒地": "https://i0.hdslb.com/bfs/emote/5b7ede3d668a82ae9ef50d380bb41274757c7780.png",
				"请吃红小豆吧！-盯": "https://i0.hdslb.com/bfs/emote/5c1cad1724fff3597913fe9a09bcb4b41b712ecf.png",
				"请吃红小豆吧！-翻白眼": "https://i0.hdslb.com/bfs/emote/633249bc889384ab3f1e2bd45d578fb7dbe2e109.png",
				"请吃红小豆吧！-好难": "https://i0.hdslb.com/bfs/emote/116cf8aff996554df096b9a1bdc59dd182fa8b22.png",
				"请吃红小豆吧！-喝水": "https://i0.hdslb.com/bfs/emote/c227ab352460cab6af9e543811a3451d6aa63908.png",
				"请吃红小豆吧！-嘿嘿嘿": "https://i0.hdslb.com/bfs/emote/b24f7db309a7ab96a00f81a1f26d1d4e06761c2d.png",
				"请吃红小豆吧！-开心": "https://i0.hdslb.com/bfs/emote/0903bb143efa6ec71ce5eb91e1bcd9815028eace.png",
				"请吃红小豆吧！-哭唧唧": "https://i0.hdslb.com/bfs/emote/516bc179c7312b7087573b5e2d7fc7b1ababa8e2.png",
				"请吃红小豆吧！-略略略": "https://i0.hdslb.com/bfs/emote/8bd5c57cb9ef5f511b3cb8119072182e3029fddc.png",
				"请吃红小豆吧！-么么": "https://i0.hdslb.com/bfs/emote/7a59397394b007fef659fc240bb2c3348930efb6.png",
				"请吃红小豆吧！-哦": "https://i0.hdslb.com/bfs/emote/20bcbc681d217027f605c1d667332ecc45744569.png",
				"请吃红小豆吧！-撒娇": "https://i0.hdslb.com/bfs/emote/74e611ffcd6702fce6e75bea435eb01744c503f8.png",
				"请吃红小豆吧！-受到惊吓": "https://i0.hdslb.com/bfs/emote/ffe8b5af6c2e3baa13e8ba9bb5685896311cab84.png",
				"请吃红小豆吧！-睡觉": "https://i0.hdslb.com/bfs/emote/f6098a8f9a77eb0753064aea2d17e9093d4ef8e0.png",
				"请吃红小豆吧！-问号脸": "https://i0.hdslb.com/bfs/emote/c6fe095df24f3fbf27f2e0fbb4b6eb983cbd430f.png",
				"请吃红小豆吧！-耶耶耶": "https://i0.hdslb.com/bfs/emote/973dd2de70275ec9f325ac8f64957f2e763c6ea3.png",
				"请吃红小豆吧！-一脸懵逼": "https://i0.hdslb.com/bfs/emote/8f6e7d3128bbc070116617cf840ceccbf2412187.png",
				"请吃红小豆吧！-眨眼": "https://i0.hdslb.com/bfs/emote/b2106dbba47b42276ea39a8d7d39b8cd21297485.png",
				"异常生物见闻录-good": "https://i0.hdslb.com/bfs/emote/5ca4eda998ed16a5826e7f92ca2e3f3969889e63.png",
				"异常生物见闻录-不信任": "https://i0.hdslb.com/bfs/emote/edb38ebc3b3be3583df4fd4c57e1b29347516d74.png",
				"异常生物见闻录-财迷": "https://i0.hdslb.com/bfs/emote/c67bbb41136823e7a2847ce72480df0e870b4d88.png",
				"异常生物见闻录-嘲讽": "https://i0.hdslb.com/bfs/emote/a061406fa8f03f619aa28d456f5a8fcf683b3fb7.png",
				"异常生物见闻录-痴呆": "https://i0.hdslb.com/bfs/emote/1b3dba852ac79d76d8e8ff26d0b2839daf26adb9.png",
				"异常生物见闻录-憧憬": "https://i0.hdslb.com/bfs/emote/1e932e3f290f5374a251b7d87af215e63e007c80.png",
				"异常生物见闻录-道德标兵": "https://i0.hdslb.com/bfs/emote/eca679781792c534bfb7f918c35eb3c43153f5d1.png",
				"异常生物见闻录-抵死不从": "https://i0.hdslb.com/bfs/emote/2f237e931a437308568ba7ca181320fc8ea800ce.png",
				"异常生物见闻录-发现食物": "https://i0.hdslb.com/bfs/emote/5bc67e4826ba7e10cba116bd2c2ececd21cb1c42.png",
				"异常生物见闻录-奸笑": "https://i0.hdslb.com/bfs/emote/038f3bda1084fa6908698697bb0fc2f059ff4b32.png",
				"异常生物见闻录-绝望": "https://i0.hdslb.com/bfs/emote/2b4ba4af99f37b973d84f92fa7a27197812fa605.png",
				"异常生物见闻录-开心": "https://i0.hdslb.com/bfs/emote/1942ee8a4df95e2f1f58202c92cda1dd06cc4816.png",
				"异常生物见闻录-困倦": "https://i0.hdslb.com/bfs/emote/009cdfcf48cf227a2cc8da24958a8a5238053dc7.png",
				"异常生物见闻录-冷汗": "https://i0.hdslb.com/bfs/emote/2dc15a9724034c1061fb0c884db17c2d45028ad8.png",
				"异常生物见闻录-凉凉": "https://i0.hdslb.com/bfs/emote/8b2ec7e8bbcbfc5f752dbb4e4f3c1b5ce6681d86.png",
				"异常生物见闻录-萌": "https://i0.hdslb.com/bfs/emote/cd7465b0bb19bdf89f057ba8c3f5c279375936aa.png",
				"异常生物见闻录-请闭嘴": "https://i0.hdslb.com/bfs/emote/a8ab9e926321c865b9cb66e64668dbddb87a6b7b.png",
				"异常生物见闻录-帅醒": "https://i0.hdslb.com/bfs/emote/93b1ff2409f733079ca1145e7add98fe6540a07c.png",
				"异常生物见闻录-无语": "https://i0.hdslb.com/bfs/emote/d3d02774b35dcc6ef3483b1655d08e472e4ca3c7.png",
				"异常生物见闻录-装傻": "https://i0.hdslb.com/bfs/emote/d81eba4cf9800a72a9b72a11ca00c4ad458a8bc8.png",
				"异常生物见闻录-装文静": "https://i0.hdslb.com/bfs/emote/748ce4b0c5da67489f2ed070ccf9233293fedcd4.png",
				"星梦手记-吃瓜": "https://i0.hdslb.com/bfs/emote/9227318a903c96e0e4a61f06ef208150ce470f66.png",
				"星梦手记-薇薇惊吓": "https://i0.hdslb.com/bfs/emote/093634e9099f40f40886a83133de5a67ca148bce.png",
				"星梦手记-惺梛认真": "https://i0.hdslb.com/bfs/emote/16fcbf1de40cb19d26a13552a3740150e45aa89f.png",
				"星梦手记-石化": "https://i0.hdslb.com/bfs/emote/f6a6d33835a48e4141fb433bbd0215b1130cf681.png",
				"星梦手记-问号": "https://i0.hdslb.com/bfs/emote/4ced3d8866f502487ec2e93b326f592f4c358fbf.png",
				"星梦手记-卖萌": "https://i0.hdslb.com/bfs/emote/375e4296c26f65be888e86bea4af4f858642a7bb.png",
				"星梦手记-尴尬": "https://i0.hdslb.com/bfs/emote/423347d687184c14d9ce8b47a8342fd8d23e99b9.png",
				"星梦手记-要抱": "https://i0.hdslb.com/bfs/emote/c125f4fc66ac8587fe4dd264254aad5dc4b31bef.png",
				"星梦手记-未来认真": "https://i0.hdslb.com/bfs/emote/330306ba001db1bd9f78bc99b8b6ec9341acbbcb.png",
				"星梦手记-摊手": "https://i0.hdslb.com/bfs/emote/acd565a268f66fa27e0ccea409b3ff57c814b360.png",
				"星梦手记-委屈": "https://i0.hdslb.com/bfs/emote/55f3974a6dded58365ef21e0a61d91725c3db431.png",
				"星梦手记-轮胎": "https://i0.hdslb.com/bfs/emote/bc13e24a1a0b58d9ef826b38e45960bfb4a3e11c.png",
				"星梦手记-没钱": "https://i0.hdslb.com/bfs/emote/e7d3feef58bf65441cbca1b8cd3c4b79cb923d15.png",
				"星梦手记-无辜": "https://i0.hdslb.com/bfs/emote/0be73bd600367f162a2a14d48c11ad72b3527858.png",
				"星梦手记-弃疗": "https://i0.hdslb.com/bfs/emote/fee923c0e57d1f1e3426b397edcfeac93d770b76.png",
				"星梦手记-雨照惊吓": "https://i0.hdslb.com/bfs/emote/4b1316f5bfd5c1745f8c721d845a6917d663c715.png",
				"冷兔-吃瓜": "https://i0.hdslb.com/bfs/emote/eed6831c5e3ceb1b23cb2ef0446b9c3c4d30f067.png",
				"冷兔-233": "https://i0.hdslb.com/bfs/emote/a7375691637b59ccbf75059fca01d9f95727a98a.png",
				"冷兔-这不科学": "https://i0.hdslb.com/bfs/emote/c9b24ea4f2e17d2faf88c0a2f1df367b135f45e7.png",
				"冷兔-？？？": "https://i0.hdslb.com/bfs/emote/8871cfa274a50f913cae368aa2ae428fbefe42da.png",
				"冷兔-等更": "https://i0.hdslb.com/bfs/emote/eb2763a2d48734d77327de5f57af43e155414b13.png",
				"冷兔-丢你雷姆": "https://i0.hdslb.com/bfs/emote/7ff16758d617cd1455c5f717f9c5b6863105abc1.png",
				"冷兔-耶": "https://i0.hdslb.com/bfs/emote/58b11a31381162761b3ebfb2e3e78bedf740cf17.png",
				"冷兔-无语": "https://i0.hdslb.com/bfs/emote/a22b1afafdfbee8b60b918cefce27ebd0c5dc915.png",
				"冷兔-额": "https://i0.hdslb.com/bfs/emote/805a33cfd96009f474ec2a7b6d0923e1a743aa29.png",
				"冷兔-呵呵": "https://i0.hdslb.com/bfs/emote/f6a80eda4c0401c523fe9931297a132d2c5c41a6.png",
				"冷兔-一无所知": "https://i0.hdslb.com/bfs/emote/d300fae68fa32dd918196e05f1d274e500a10087.png",
				"冷兔-体前屈": "https://i0.hdslb.com/bfs/emote/0f04dc139d9dd38e7b2f8db72c71f5ce89f60ac7.png",
				"冷兔-喜欢": "https://i0.hdslb.com/bfs/emote/4eda384b1e97430e48cd2faa28454f08f6daa70a.png",
				"冷兔-哭": "https://i0.hdslb.com/bfs/emote/bec3a906385324a4b472f0ed3b5323f905ae0f6b.png",
				"冷兔-赞": "https://i0.hdslb.com/bfs/emote/b001a8210f1c2166f436c8de080a76c33637036e.png",
				"冷兔-低头": "https://i0.hdslb.com/bfs/emote/ebe445da276339c0506267b0bb59a0b5ea3300d3.png",
				"冷兔-卖萌": "https://i0.hdslb.com/bfs/emote/4d9f8b35f0789afa40a48b0ce06769e5b4e60cb0.png",
				"冷兔-扶额": "https://i0.hdslb.com/bfs/emote/ff5c34e9072a83b56c2f2648cfe6ecf11b92f7be.png",
				"冷兔-掀桌": "https://i0.hdslb.com/bfs/emote/50d837346517f128442702eb7df04a82d20dbe89.png",
				"冷兔-吸欧气": "https://i0.hdslb.com/bfs/emote/16e696a795186a7ca2a4aeaa1dafcf225246add4.png",
				"那兔-合个影": "https://i0.hdslb.com/bfs/emote/0c12e40154dd0c73e2dd5e02ab8315bbaf905aec.png",
				"那兔-囧": "https://i0.hdslb.com/bfs/emote/0a6519dc3f8b4b58fea10e3b8a26d700728f95bf.png",
				"那兔-。。。": "https://i0.hdslb.com/bfs/emote/f5968dc3f8342019f4777d85c56fdda9df460ad4.png",
				"那兔-好滴": "https://i0.hdslb.com/bfs/emote/6d292369dc9d578da241b3e5680d4e2fa95b9aeb.png",
				"那兔-讲道理": "https://i0.hdslb.com/bfs/emote/29643a9f37d2b8981c50741fe6943947f9f31661.png",
				"那兔-懒得理你": "https://i0.hdslb.com/bfs/emote/3e1c2e302a52f7b03e9fda5ed37cc00844ba62bb.png",
				"那兔-奈我何": "https://i0.hdslb.com/bfs/emote/a6e38393214099abe9d402070d67d7747150cbbd.png",
				"那兔-你丫试试": "https://i0.hdslb.com/bfs/emote/0802020cec4543e96256d7dfadfd3cef9662aae0.png",
				"那兔-深思": "https://i0.hdslb.com/bfs/emote/44bde865b0954e1230caaa545ea91a5b6d90e424.png",
				"那兔-恶代官": "https://i0.hdslb.com/bfs/emote/91bcc90beb6f9cd1c7b3da4011f68d1ee7ab7132.png",
				"那兔-说什么喵": "https://i0.hdslb.com/bfs/emote/adca5e0ea594bcfd1d6480a6755f1bec3984811e.png",
				"那兔-心碎": "https://i0.hdslb.com/bfs/emote/f016a83fcdb0dbb5738e2f9fb62efd1f0971d17f.png",
				"那兔-一见钟情": "https://i0.hdslb.com/bfs/emote/cd6ae74fe5dd1b1252a1603af0a34c94b9ba931e.png",
				"那兔-痴呆": "https://i0.hdslb.com/bfs/emote/6a7020931d20380be2fb50a8d8c2e582f6d8ff89.png",
				"那兔-找事儿": "https://i0.hdslb.com/bfs/emote/55022a863de195f355394296647a8cea2ad69d57.png",
				"那兔-呃": "https://i0.hdslb.com/bfs/emote/06105d9eafe0316d69453da63b05ae76fdfa9a8a.png",
				"那兔-擦": "https://i0.hdslb.com/bfs/emote/db5d5e113501e2ec8ea51dee1c716a932d929949.png",
				"我家大师兄脑子有坑-比心": "https://i0.hdslb.com/bfs/emote/d675489bfcfdbac9734cc0760fd25b1cb1b57ba2.png",
				"我家大师兄脑子有坑-吃瓜": "https://i0.hdslb.com/bfs/emote/816198d849984d510a1713c3d6426754475f8ddd.png",
				"我家大师兄脑子有坑-大笑": "https://i0.hdslb.com/bfs/emote/1af457c164e174376c558e62f26b86ca18d67844.png",
				"我家大师兄脑子有坑-汗": "https://i0.hdslb.com/bfs/emote/834905aff2a69e52eed7d8f48cb0344b600829b0.png",
				"我家大师兄脑子有坑-机智": "https://i0.hdslb.com/bfs/emote/a56e6a8d21498abac50f886559767172934262da.png",
				"我家大师兄脑子有坑-哭": "https://i0.hdslb.com/bfs/emote/d7d9809e3118b2a57bcf28a4605abfef12359a73.png",
				"我家大师兄脑子有坑-期待": "https://i0.hdslb.com/bfs/emote/ef74493b15b9029ac73dddcb6fe1fcc265058fb5.png",
				"我家大师兄脑子有坑-撒花": "https://i0.hdslb.com/bfs/emote/e0755e2432241f9ea5e9b5594a0a59f0ba68455d.png",
				"我家大师兄脑子有坑-吐魂": "https://i0.hdslb.com/bfs/emote/5e6482f392ee60e1b0bfbf3bb0abf8afe32fb7f6.png",
				"我家大师兄脑子有坑-晕": "https://i0.hdslb.com/bfs/emote/2f10c278536711e836ec9a3ba77c19c6433b3608.png",
				"喂，看见耳朵啦！-懵": "https://i0.hdslb.com/bfs/emote/51725a9abd80ce5dca5a31b7d752c61bdc063a44.png",
				"喂，看见耳朵啦！-嗷": "https://i0.hdslb.com/bfs/emote/203d29bcc8e2ab7ce4a12bc07140403390f4b2e6.png",
				"喂，看见耳朵啦！-抱大腿": "https://i0.hdslb.com/bfs/emote/d5eebcecad919c86d68ae495f39743fc80b20ad9.png",
				"喂，看见耳朵啦！-抱走": "https://i0.hdslb.com/bfs/emote/0576f4f1463f6757101a236c10049ed40ba748cb.png",
				"喂，看见耳朵啦！-壁咚": "https://i0.hdslb.com/bfs/emote/759a8a54f10767bdc40fd014b70a783ae0e568ef.png",
				"喂，看见耳朵啦！-冷漠": "https://i0.hdslb.com/bfs/emote/edb3d7e86fd768b55c50588110a765e3d9cafd4b.png",
				"喂，看见耳朵啦！-嘤嘤嘤": "https://i0.hdslb.com/bfs/emote/d061ef8b91ca866fc6ce3ac0eaaf831457e08c52.png",
				"喂，看见耳朵啦！-吓": "https://i0.hdslb.com/bfs/emote/9ed824796f9494f8ef4adadb68f271cbf1790dcf.png",
				"喂，看见耳朵啦！-chu": "https://i0.hdslb.com/bfs/emote/912c436fee4d16f94cc5f794abc6a6edf3beda4d.png",
				"喂，看见耳朵啦！-爱你": "https://i0.hdslb.com/bfs/emote/68fb8141a242cdcde94ba12e91dee1ad6b37978e.png",
				"喂，看见耳朵啦！-舔": "https://i0.hdslb.com/bfs/emote/c57b984be871913cd502e9bb6b971ce311229d99.png",
				"喂，看见耳朵啦！-睡觉觉": "https://i0.hdslb.com/bfs/emote/9adec4fb28034e50dde7a2ca5de234c80f95dc04.png",
				"喂，看见耳朵啦！-举高高": "https://i0.hdslb.com/bfs/emote/a413e5eeeec632074b6c01274bf8fcb510991e0e.png",
				"喂，看见耳朵啦！-不可描述": "https://i0.hdslb.com/bfs/emote/fda54b79413faa735b1c96eb9acd497e3207ba4d.png",
				"喂，看见耳朵啦！-摔倒啦": "https://i0.hdslb.com/bfs/emote/cb626004cd67af4a48fd48f15a9f36f564052082.png",
				"喂，看见耳朵啦！-说什么都对": "https://i0.hdslb.com/bfs/emote/4bddfe880ce46bd46b39b3f7a3f45300cbd330f9.png",
				"小绿和小蓝-不想说话": "https://i0.hdslb.com/bfs/emote/eb0e4730ecb42c342e1507330ce495deef0128bd.png",
				"小绿和小蓝-吵架": "https://i0.hdslb.com/bfs/emote/420d20935484170ac24c67872f29458bc0c79f5a.png",
				"小绿和小蓝-得意脸": "https://i0.hdslb.com/bfs/emote/ef7c7605c4975f89896f3ed37c4e097c4e1713d7.png",
				"小绿和小蓝-高兴": "https://i0.hdslb.com/bfs/emote/614798a8c875540d417b7200b9ea1ac3e1a934a3.png",
				"小绿和小蓝-哦": "https://i0.hdslb.com/bfs/emote/dab5061b6f299a5f38b85a115da8eab8024426e8.png",
				"小绿和小蓝-捂脸": "https://i0.hdslb.com/bfs/emote/7108030a92e01945817e2e73cc9206cfed4069a3.png",
				"小绿和小蓝-邪恶脸": "https://i0.hdslb.com/bfs/emote/da35ac592ab48d23d299034315eb3b4efe15015b.png",
				"小绿和小蓝-要哭了": "https://i0.hdslb.com/bfs/emote/f1c4d2b6cfcf43b985af38da8dc5a4fcdfbcc600.png",
				"小绿和小蓝-疑问": "https://i0.hdslb.com/bfs/emote/80d7b4f10cd51dee05c0e307169aab9e9c2ea37e.png",
				"小绿和小蓝-打滚": "https://i0.hdslb.com/bfs/emote/a0523e55635cf3e09dc286e2042fbbac6b50409c.png",
				"小绿和小蓝-诶": "https://i0.hdslb.com/bfs/emote/302e36652f710d0e7a8260090eaf63eac3bd28bf.png",
				"小绿和小蓝-机智一比": "https://i0.hdslb.com/bfs/emote/54816a3dd363e620e5d999f1bdf75290645bd35e.png",
				"小绿和小蓝-喵喵喵": "https://i0.hdslb.com/bfs/emote/a2019a775d69b7888d663e82b3c29bd0c2281188.png",
				"小绿和小蓝-跑": "https://i0.hdslb.com/bfs/emote/a73a2d7b884e735ab26ee1f871dd38c499f7b84a.png",
				"小绿和小蓝-喂": "https://i0.hdslb.com/bfs/emote/707e9e784b745fad291ab15d9a31a24c7efa6c1f.png",
				"小绿和小蓝-已关机": "https://i0.hdslb.com/bfs/emote/ea0769dadca17598873306ab8500aab1dd8994bd.png",
				"小绿和小蓝-直接躺平": "https://i0.hdslb.com/bfs/emote/92a77c53d7a66763d2bd9dab80ddd2afa6cf6387.png",
				"小绿和小蓝-呆住": "https://i0.hdslb.com/bfs/emote/978ab4d7ea39f7428fc945ba68c96b2291d26751.png",
				"小绿和小蓝-哈哈": "https://i0.hdslb.com/bfs/emote/22144e5e3ea83b587483ea473c2e191284d64b44.png",
				"小绿和小蓝-喝水": "https://i0.hdslb.com/bfs/emote/1e5592c8200419164f5730a0de6c30281a5c5a57.png",
				"小绿和小蓝-生气": "https://i0.hdslb.com/bfs/emote/a9cc35254663a736cbd0e020634765b5f147fcdd.png",
				"小绿和小蓝-哇啊啊啊": "https://i0.hdslb.com/bfs/emote/d67db235a945fdbd0b537aebddb4abc5ffc01184.png",
				"小绿和小蓝-一本正经": "https://i0.hdslb.com/bfs/emote/822a803bf5b340090c9c7053a74aa43c1b527c27.png",
				"小绿和小蓝-惊呆": "https://i0.hdslb.com/bfs/emote/15091032588cf3ccf2a7969460fe7705ec00e9c7.png",
				"小绿和小蓝-开心": "https://i0.hdslb.com/bfs/emote/08dab1d9250043f97273b211253d0341f92fb0f8.png",
				"小绿和小蓝-苦恼": "https://i0.hdslb.com/bfs/emote/14a0716224369f5211d5c69c249354f11f5026cb.png",
				"小绿和小蓝-灵光乍现": "https://i0.hdslb.com/bfs/emote/dc3fae4b42056970f5aa407e8297e96cd2ede2b2.png",
				"小绿和小蓝-思考": "https://i0.hdslb.com/bfs/emote/aecd0b1b0a5848765f002c857b73092677dec31f.png",
				"一人之下-机智": "https://i0.hdslb.com/bfs/emote/afdcd367d011fbe5b78032daf519689c0bbcdc5e.png",
				"一人之下-刀": "https://i0.hdslb.com/bfs/emote/68036be8868b42a6cbdb61327cfdb50bedde1a38.png",
				"一人之下-埋了": "https://i0.hdslb.com/bfs/emote/2784a335e41ac4cdf2ec94bf430a906f933f11f4.png",
				"一人之下-蟑螂": "https://i0.hdslb.com/bfs/emote/a95014fff53b7921b5f1850781ccf5af5ef73234.png",
				"一人之下-抽打": "https://i0.hdslb.com/bfs/emote/a6a0a0a20019de939232bdaf3f1882e6d8ffd75e.png",
				"一人之下-燃": "https://i0.hdslb.com/bfs/emote/f2a78e0e05bb90b38b550f57355173f8e9e32a7f.png",
				"一人之下-超凶": "https://i0.hdslb.com/bfs/emote/aea3aa73a14350613628a0dac83e77c6c8fa9d68.png",
				"一人之下-干翻苍穹": "https://i0.hdslb.com/bfs/emote/e5de003a4eb9fef32fe722cd06ad2abc9a3d4ec3.png",
				"一人之下-糟了": "https://i0.hdslb.com/bfs/emote/45ad7c1b87cf95743a2ad000b8dd2eedfcf73107.png",
				"一人之下-孙贼": "https://i0.hdslb.com/bfs/emote/a689c37d5779cda0774d6f4be65cd587c4d0e27f.png",
				"一人之下-养生": "https://i0.hdslb.com/bfs/emote/32adfeb34ecc2e4ab9702813ab547fc0bb09aac7.png",
				"一人之下-瘫": "https://i0.hdslb.com/bfs/emote/721c2b271d9edbb937c6dec61ba25568797b27aa.png",
				"一人之下-打call": "https://i0.hdslb.com/bfs/emote/7f979ab31d61e09acb3da46b52c52376e1131abe.png",
				"一人之下-比心": "https://i0.hdslb.com/bfs/emote/fafec3459f631f0ba76adde9faf8aa112469e9c4.png",
				"一人之下-摸头": "https://i0.hdslb.com/bfs/emote/500171557765a27c500a7024888c698680c73653.png",
				"一人之下-八卦": "https://i0.hdslb.com/bfs/emote/5be05cddd588d7b635cd55501b9b7a47af5dc5bc.png",
				"一人之下-狐狸": "https://i0.hdslb.com/bfs/emote/022b95f086cd4469aec2a44045729bfda6fd8c95.png",
				"一人之下-承让": "https://i0.hdslb.com/bfs/emote/6a21366ea70b7369b1d3c867f04bf8932e7c9be4.png",
				"一人之下-哎？": "https://i0.hdslb.com/bfs/emote/ece804d0f852c6c6c9ae280dca523de672d5631d.png",
				"一人之下-叹气": "https://i0.hdslb.com/bfs/emote/f5c79a00613d3e1f71d18332d474c7c0af31e4b2.png",
				"一人之下-雷": "https://i0.hdslb.com/bfs/emote/75bbf0f391e8136d79109ff1d6904b688555b49b.png",
				"狐妖-不服憋着": "https://i0.hdslb.com/bfs/emote/d3633ea35afac42d46679a3d31775a9860e63c2d.png",
				"狐妖-吃瓜": "https://i0.hdslb.com/bfs/emote/8c5ad49f83b29262e2e785124bec6651670ae36b.png",
				"狐妖-不明嚼栗": "https://i0.hdslb.com/bfs/emote/71601899fe445454c3593e7d82e4ea01f980b230.png",
				"狐妖-抽打": "https://i0.hdslb.com/bfs/emote/43bb8e363f6c94c97a396a68852c8f2182651fc0.png",
				"狐妖-吃我安利": "https://i0.hdslb.com/bfs/emote/3a0bf7d0320a84002ea8b4907e6c3baa97ec0dd0.png",
				"狐妖-伐开心": "https://i0.hdslb.com/bfs/emote/01f6b69d1f69e8ea879569827e7363f4da630cba.png",
				"狐妖-惊": "https://i0.hdslb.com/bfs/emote/e1c6e6aca03b634f32bc71762015c44431dafd74.png",
				"狐妖-大笑": "https://i0.hdslb.com/bfs/emote/38bc9f4e39c2ec9d7442f2d67e13092fd535846b.png",
				"狐妖-震惊": "https://i0.hdslb.com/bfs/emote/83361a40f6fd010e6da88825aa27320189ad2df5.png",
				"狐妖-脸红": "https://i0.hdslb.com/bfs/emote/79175b3bc469061020d15114e22ac261b0668819.png",
				"狐妖-冷漠": "https://i0.hdslb.com/bfs/emote/842b69b5c3e98d11292edd4f4cf6abb8504c18bc.png",
				"狐妖-哭": "https://i0.hdslb.com/bfs/emote/29de352176c8ead5b301212aa61facb5e3abcd55.png",
				"狐妖-目瞪口呆": "https://i0.hdslb.com/bfs/emote/c75e6841c81a5c020971debe394334d8b2700151.png",
				"狐妖-前排": "https://i0.hdslb.com/bfs/emote/4d2702f9383dec00c7c77ff026768c3ddaaf6d60.png",
				"狐妖-沙发": "https://i0.hdslb.com/bfs/emote/5ff883da9618dfd9740256e569279244bbff03b1.png",
				"狐妖-掀桌": "https://i0.hdslb.com/bfs/emote/f0917c6d982a86c2ab02c979359226f761581c37.png",
				"狐妖-心": "https://i0.hdslb.com/bfs/emote/77123fd85c11478b46d762a1c8553328013637ef.png",
				"狐妖-晕": "https://i0.hdslb.com/bfs/emote/64702d1fc92c44e8aaa39ffdacdc87aaa6d38d3d.png",
				"狐妖-吃药": "https://i0.hdslb.com/bfs/emote/059d810cbc5ad4df4f9bbf08e44643b022a2354f.png",
				"狐妖-mdzz": "https://i0.hdslb.com/bfs/emote/e68fd21a5bcfa50b6d45f2a8f5926f992f484ae3.png",
				"战双帕弥什-吃瓜": "https://i0.hdslb.com/bfs/emote/8541c44effd3f69a71b1e96a586ac0fe5b765c45.png",
				"战双帕弥什-哼": "https://i0.hdslb.com/bfs/emote/59748ef499690a7931c198cd4e0343d5a05d63da.png",
				"战双帕弥什-抱抱": "https://i0.hdslb.com/bfs/emote/83a6ae3a34c54e6ebef7d0ca5ad540f61c1df678.png",
				"战双帕弥什-画圈圈": "https://i0.hdslb.com/bfs/emote/167a9b59900ef721dd3fd19e6216a71d4eb85dfb.png",
				"战双帕弥什-痴汉": "https://i0.hdslb.com/bfs/emote/9987980413cc6f550ea7e5f071fe1166cef729b7.png",
				"战双帕弥什-挠头": "https://i0.hdslb.com/bfs/emote/b1930eefe111a6e140f17669368aed831aeab5f4.png",
				"战双帕弥什-肥宅": "https://i0.hdslb.com/bfs/emote/3ac9e30424ff0122d4ca274cac3ed236d2853e46.png",
				"战双帕弥什-柠檬茶": "https://i0.hdslb.com/bfs/emote/02180f96d9b38797873286035dcfe738ad382cbb.png",
				"战双帕弥什-诶嘿": "https://i0.hdslb.com/bfs/emote/98c27f2281019fa5ef0872da88401d03313463b2.png",
				"战双帕弥什-拍桌": "https://i0.hdslb.com/bfs/emote/2bd9551d81a1edf8013dc75ca18b875050db9dd3.png",
				"战双帕弥什-哭哭": "https://i0.hdslb.com/bfs/emote/71e7feb027f42ec299a440c3031534d6bdc4e604.png",
				"战双帕弥什-吐血": "https://i0.hdslb.com/bfs/emote/3b53c31e32cf8806770f760a74b167b14610df8c.png",
				"战双帕弥什-凉了": "https://i0.hdslb.com/bfs/emote/142bcb77a9564db8ab5f429ad1e623c9fa446abd.png",
				"战双帕弥什-托腮": "https://i0.hdslb.com/bfs/emote/e196eeadb34eb7238206d606b801ef8e0516d00a.png",
				"战双帕弥什-喷了": "https://i0.hdslb.com/bfs/emote/5424a9d241653492c296d8c8b4c889f2202fac8a.png",
				"战双帕弥什-星星眼": "https://i0.hdslb.com/bfs/emote/1595f4072f90b756f15834f70bb188872c107a37.png",
				"战双帕弥什-我即天命": "https://i0.hdslb.com/bfs/emote/2dd6a60bcdce44e54f07c090b1b8849ee76ae4a0.png",
				"战双帕弥什-作战预备": "https://i0.hdslb.com/bfs/emote/82d3b0c747cff3e8523cfd10e0e58c03dac885a3.png",
				"大王不高兴-开心": "https://i0.hdslb.com/bfs/emote/cb17a1a0b113c1b2c4a42c273d0e9a434289a95c.png",
				"大王不高兴-生气": "https://i0.hdslb.com/bfs/emote/5c3aa8d501c1a1a3c3e627edfc98703c1066e91b.png",
				"大王不高兴-哭": "https://i0.hdslb.com/bfs/emote/f0677bb46861c5b03137e356d06a51a562fd0a59.png",
				"大王不高兴-比心": "https://i0.hdslb.com/bfs/emote/0ce7501326cdf4be8c81a106054680458d4fa247.png",
				"大王不高兴-疑问": "https://i0.hdslb.com/bfs/emote/3e0ebc9bd1cb54a2ceed82a90a3fdd2586a517ae.png",
				"大王不高兴-我好了": "https://i0.hdslb.com/bfs/emote/997095a106b2fb7319f07c6f9260468410734a56.png",
				"大王不高兴-汗": "https://i0.hdslb.com/bfs/emote/7b02c3d608f3ca9cdc6b46d64f06f8909017f164.png",
				"大王不高兴-点赞": "https://i0.hdslb.com/bfs/emote/f85e02492f0f87ee94f274f1684787170ceefcdb.png",
				"大王不高兴-害怕": "https://i0.hdslb.com/bfs/emote/461eff396cde49246614731caacef13200730709.png",
				"大王不高兴-滑稽": "https://i0.hdslb.com/bfs/emote/0004ca2d9be95b769d8a9778aaee3a07482550ba.png",
				"大王不高兴-目瞪口呆": "https://i0.hdslb.com/bfs/emote/83d687d404ce04c68cf5f968a74a2d936097486e.png",
				"大王不高兴-前排": "https://i0.hdslb.com/bfs/emote/8b02d412a194f8c424c12c0c9f22159f3a1895f8.png",
				"崩坏3-点赞": "https://i0.hdslb.com/bfs/emote/055a130541fe95e20aa541db5a5a48d0cbc728b6.png",
				"崩坏3-入欧": "https://i0.hdslb.com/bfs/emote/5d532eab104881e7dd63be1083a78ab36878c3b4.png",
				"崩坏3-脱非": "https://i0.hdslb.com/bfs/emote/ac31b7219032b6e714c189d65a669ca3ca2d3e77.png",
				"崩坏3-快乐": "https://i0.hdslb.com/bfs/emote/a3ec46f1255dbf96d413231862399b939dc2110e.png",
				"崩坏3-注入灵魂": "https://i0.hdslb.com/bfs/emote/5bf261f6fb91463e1ff1c80dd0fefd6bcd31aedf.png",
				"崩坏3-危险": "https://i0.hdslb.com/bfs/emote/3a6af29282b6e09ce7881c9aebc187d03268b25f.png",
				"崩坏3-吃瓜": "https://i0.hdslb.com/bfs/emote/9ecead2805adf05a308e1093fb8d4941d0366189.png",
				"崩坏3-糖葫芦": "https://i0.hdslb.com/bfs/emote/f54e160beaf3f7b55a87d0da9a6eccefc7bd70d6.png",
				"崩坏3-路过": "https://i0.hdslb.com/bfs/emote/13a7f9e81f4005c29466e8d65eabbf3167902f9d.png",
				"崩坏3-魔法少女": "https://i0.hdslb.com/bfs/emote/da063804b5b8d44c288dd2c45f472741c00c8625.png",
				"崩坏3-特效": "https://i0.hdslb.com/bfs/emote/a1bb1caf129b5e28f2c331667f9e38808050e8a8.png",
				"崩坏3-唢呐": "https://i0.hdslb.com/bfs/emote/032301ad0e61395a266e7f9b4ebcf83bd2acca03.png",
				"崩坏3-琵琶": "https://i0.hdslb.com/bfs/emote/13c3e61eec3a61a3e0ae2883a488ce9b45cddecc.png",
				"崩坏3-二胡": "https://i0.hdslb.com/bfs/emote/b2e3acfba545c61c334eacf5a5b7694e071d834f.png",
				"崩坏3-笛子": "https://i0.hdslb.com/bfs/emote/3dae79d5ce1d826d6d16404dff7bf22474c7015b.png",
				"崩坏3-镲": "https://i0.hdslb.com/bfs/emote/dcce1ad4d53a25c52946821c0d3a4b7dd80e5a42.png",
				"崩坏3-红包": "https://i0.hdslb.com/bfs/emote/4bd80539d828ad6894ccb099b5b04769820d49d6.png",
				"崩坏3-谈话": "https://i0.hdslb.com/bfs/emote/4794f82d166b1f8bfae7783859913e03fe42ae81.png",
				"崩坏3-无辜": "https://i0.hdslb.com/bfs/emote/4e1f4e9a375beaa4e93d057a4e285c924635235f.png",
				"崩坏3-星星眼": "https://i0.hdslb.com/bfs/emote/b5fffeead2dc05c7f902f1c7136178c6a63e508a.png",
				"崩坏3-微笑": "https://i0.hdslb.com/bfs/emote/c2c6c0604af985b745322954814863e47f6fb6d5.png",
				"崩坏3-开心": "https://i0.hdslb.com/bfs/emote/3657a825b87ec063d6e2a3c201da2056e45db938.png",
				"崩坏3-幸福": "https://i0.hdslb.com/bfs/emote/714cc90d3485a003f53eecec336bea8a0b2dc12d.png",
				"崩坏3-吃": "https://i0.hdslb.com/bfs/emote/c26ae762270b756b68a7f5c63d43078e874fbead.png",
				"崩坏3-口水": "https://i0.hdslb.com/bfs/emote/7a66d7e1902b766a2b930009687be5171018f1ff.png",
				"崩坏3-惊": "https://i0.hdslb.com/bfs/emote/672ab0cac8e29270a0ea1788df5711ce716b6942.png",
				"崩坏3-哭哭": "https://i0.hdslb.com/bfs/emote/f432d349d44aad9873da18b27a6367c3ea7cfebc.png",
				"崩坏3-纠结": "https://i0.hdslb.com/bfs/emote/864ff2ef1546534f5b53b279332e3950a86cf008.png",
				"崩坏3-疑问": "https://i0.hdslb.com/bfs/emote/bdda506f56f5a42e365b6f2f8d2128f799f8310e.png",
				"崩坏3-有主意了": "https://i0.hdslb.com/bfs/emote/38676ebb4c51fdda6302a5cb131ae94d35be4f8b.png",
				"阴阳师缘结神-你高尚": "https://i0.hdslb.com/bfs/emote/f88abffb5a8d570b1efc68cd5440d9515b8a45e6.png",
				"阴阳师缘结神-菜哭": "https://i0.hdslb.com/bfs/emote/5c9907d23378704942227aa5a2834ff35f2e425d.png",
				"阴阳师缘结神-姐妹！": "https://i0.hdslb.com/bfs/emote/972913308e0633454e382e6e1c01b810c24cd574.png",
				"阴阳师缘结神-我身体好": "https://i0.hdslb.com/bfs/emote/1852865c39b446a63ecb07da68a196dc4dd2c96e.png",
				"阴阳师缘结神-我磕到了": "https://i0.hdslb.com/bfs/emote/5f59b958267f9441d82956071586fa25c9ee5e7c.png",
				"阴阳师缘结神-爱心发射": "https://i0.hdslb.com/bfs/emote/25cdfac5b23e5cb007d1fa643b82751c9b07d31a.png",
				"阴阳师缘结神-快去结婚": "https://i0.hdslb.com/bfs/emote/90402b80a3fd1ab81c9d78a31354f00f0a0cb1ba.png",
				"阴阳师缘结神-亲一个": "https://i0.hdslb.com/bfs/emote/611591c16d0e621b21e035045c026e2039e52c29.png",
				"阴阳师缘结神-KWSL": "https://i0.hdslb.com/bfs/emote/8bddeede5426262701d09a9bdffd3cc7a89bee69.png",
				"阴阳师缘结神-缘结神哒": "https://i0.hdslb.com/bfs/emote/f7a03dfd13018213d210d4de8467e51f8b9d91e3.png",
				"阴阳师缘结神-该结婚了": "https://i0.hdslb.com/bfs/emote/c7b591beb0e613e0a9f95fc5becf42d7896a5869.png",
				"阴阳师缘结神-兄弟情？": "https://i0.hdslb.com/bfs/emote/2606e0614cd56d7d9c3a5c8e4ed6d96ef9eea888.png",
				"阴阳师缘结神-别骚了": "https://i0.hdslb.com/bfs/emote/fb58e9683265087ad8bdbe3e834f7813cf72f990.png",
				"阴阳师缘结神-开心": "https://i0.hdslb.com/bfs/emote/f1a2a63ef7a89eae87da511f5de5b04d0e9ae06c.png",
				"阴阳师缘结神-在一起": "https://i0.hdslb.com/bfs/emote/4ccc36204a64787b0fb67d47edcffaf3c45acc42.png",
				"阴阳师缘结神-期待": "https://i0.hdslb.com/bfs/emote/b80475b53b481f3d11ec05b07c55ad390f091b35.png",
				"阴阳师缘结神-多喝热水": "https://i0.hdslb.com/bfs/emote/b6f923ac40cf7faf24d3bc8ca6ebcdf6425a876f.png",
				"阴阳师缘结神-有粮不": "https://i0.hdslb.com/bfs/emote/6fdd3e5e15dc307c3c6990a621df860634527f47.png",
				"阴阳师缘结神-等粮中": "https://i0.hdslb.com/bfs/emote/0126cb6e58fa39fbd0f2e5242461ae0e101ea904.png",
				"阴阳师缘结神-求你产粮": "https://i0.hdslb.com/bfs/emote/95011ad80649de14a966c827db305579a8311b63.png",
				"阴阳师缘结神-我不活啦": "https://i0.hdslb.com/bfs/emote/48de67de9c96dc5340af62ccc76200e07ceaffda.png",
				"公主连结-不错": "https://i0.hdslb.com/bfs/emote/e0ac5fff71fd2aabd8c20505a548f5bca36bc7a5.png",
				"公主连结-鼓气": "https://i0.hdslb.com/bfs/emote/a3fb7d3a867ba3523e6a0faa2ca42af797328d6d.png",
				"公主连结-害怕": "https://i0.hdslb.com/bfs/emote/c305b2bd36063b700fd9fac093c21639c0806138.png",
				"公主连结-惊吓": "https://i0.hdslb.com/bfs/emote/57ad87c4e597a366dac713ad4800cecbd520175e.png",
				"公主连结-来啊": "https://i0.hdslb.com/bfs/emote/a82ab04d1a10c742b5eadafb2a0e04d77daa84d4.png",
				"公主连结-累死了": "https://i0.hdslb.com/bfs/emote/8c68c16f8f4c79f14bb16c6ea64378d77abdf0d0.png",
				"公主连结-冷漠": "https://i0.hdslb.com/bfs/emote/04a257a00ae097d61498db6118f6da393d4c85b7.png",
				"公主连结-厉害了": "https://i0.hdslb.com/bfs/emote/066c5c59e39f163345d2a41123d53596b39a2ce3.png",
				"公主连结-你干嘛": "https://i0.hdslb.com/bfs/emote/422897481963e6efdd93dce8581c112e7af80a1e.png",
				"公主连结-扭扭捏捏": "https://i0.hdslb.com/bfs/emote/4c20cd2aed2598dd18507fdd03c7d39b6eb7842c.png",
				"公主连结-祈祷": "https://i0.hdslb.com/bfs/emote/a63b3da12e46314470413fea6975579b0871d1f8.png",
				"公主连结-思索": "https://i0.hdslb.com/bfs/emote/3c6741be302ec54f152093ab00f950b00a083d6d.png",
				"公主连结-投币": "https://i0.hdslb.com/bfs/emote/6bd0c47917f94d510990db020ce3a7c07ed698e9.png",
				"公主连结-无奈": "https://i0.hdslb.com/bfs/emote/7f78404ee98cc8738b9b738f7e4446a6fdbaff00.png",
				"公主连结-邪恶": "https://i0.hdslb.com/bfs/emote/97d25106924c7f3db1fe26ed7d67db943ffcc92e.png",
				"公主连结-阴谋": "https://i0.hdslb.com/bfs/emote/705f87da382b4c46d6bf19579b62c88bf4aa702c.png",
				"公主连结-怎么这样": "https://i0.hdslb.com/bfs/emote/7461756bf9c49c4b48d1c26083695044b468ad7c.png",
				"公主连结-emmm": "https://i0.hdslb.com/bfs/emote/99ca73b1f486042cd8ab6b17fd5ad638ed777899.png",
				"2020拜年祭-哈气": "https://i0.hdslb.com/bfs/emote/464fb79ad8dc0b8ba192bef47e03c044fc8ec8ac.png",
				"2020拜年祭-期待": "https://i0.hdslb.com/bfs/emote/34d9883978304d61b0a6bfe4dc5ed3cce849a954.png",
				"2020拜年祭-吸欧气": "https://i0.hdslb.com/bfs/emote/d7d2033c871fbe06747c6ca93a7856f27765d9e7.png",
				"2020拜年祭-领红包": "https://i0.hdslb.com/bfs/emote/d8425bcf66fe383d0c693c41678202bb2167f476.png",
				"2020拜年祭-谢谢老板": "https://i0.hdslb.com/bfs/emote/2aa0fef536c594d29b8936c2e7be0e68decd44a8.png",
				"2020拜年祭-灯笼": "https://i0.hdslb.com/bfs/emote/814b999e584f93769a5c6a0285c91ab3c2f57002.png",
				"2020拜年祭-火锅": "https://i0.hdslb.com/bfs/emote/2bfbeb3a1502187b0c505e49a460be1dbffd3df0.png",
				"2020拜年祭-2020": "https://i0.hdslb.com/bfs/emote/5f28eb21ed39a86e369d5316579573b285ccf34f.png",
				"2020拜年祭-红包": "https://i0.hdslb.com/bfs/emote/cebc5603f3ff1df7f9f2e67c8c7e6309da0b506c.png",
				"2020拜年祭-新年好": "https://i0.hdslb.com/bfs/emote/9da7e2f2fd6187c506423398dc22f7bf5ba814f4.png",
				"Cat-escort": "https://i0.hdslb.com/bfs/emote/81784f53f5ca7004a90d316c81889d8161dc05a6.png",
				"Cat-coffeebath": "https://i0.hdslb.com/bfs/emote/f80cfd44e0f216f4171a549e869aab32d80d4c39.png",
				"Cat-stealth": "https://i0.hdslb.com/bfs/emote/21f7d24b1e8de29f2c61f64e70af9f6aec14e394.png",
				"Cat-hightouch": "https://i0.hdslb.com/bfs/emote/3d7264b8349bc1be6d45beebbcfab69e7b9895fc.png",
				"Cat-lonely": "https://i0.hdslb.com/bfs/emote/72a9d2f20fb79883bbed3cac914187545ac3a0cc.png",
				"Cat-heart": "https://i0.hdslb.com/bfs/emote/3f98c4debfe792a1969b99ae71f7f5d4bf00c3d5.png",
				"Cat-slip": "https://i0.hdslb.com/bfs/emote/a6e45e065ed17e2af03f7263784bc36d94b25e74.png",
				"Cat-chips": "https://i0.hdslb.com/bfs/emote/12d2d3ce0e72749c45706444cca580dc22148876.png",
				"Cat-study": "https://i0.hdslb.com/bfs/emote/9f6d28ecd7e33c3f5e7cd74cc36f4feedb42e995.png",
				"Cat-dash": "https://i0.hdslb.com/bfs/emote/0f2d1f99efd5df816c694da76e91a173fa643589.png",
				"Cat-pressure": "https://i0.hdslb.com/bfs/emote/c6c270e9989e7152457b907595a6e34064d0c1b2.png",
				"Cat-hibye": "https://i0.hdslb.com/bfs/emote/9e4955f479a1211d401fbaa71ceaf5186b9e57bd.png",
				"Cat-confuse": "https://i0.hdslb.com/bfs/emote/107ebcbd4dd5895f4595ea6db963dc4566809c6e.png",
				"Cat-ignore": "https://i0.hdslb.com/bfs/emote/94de4f63a5f965ee8312a88e4c57c07c0174acce.png",
				"Cat-agree": "https://i0.hdslb.com/bfs/emote/48b00f75518a727d64c385fe8ca2fa49aeb08c77.png",
				"Cat-fight": "https://i0.hdslb.com/bfs/emote/e39c491906d0fcd0176eede702305655d44044c5.png",
				"Cat-splash": "https://i0.hdslb.com/bfs/emote/9513157fed2425ed2caa4eb9bc84a0bca80df9bc.png",
				"Cat-calledme": "https://i0.hdslb.com/bfs/emote/aacb6fb852f6acbbc8386ecef76c98b77178e23e.png",
				"Cat-sleep": "https://i0.hdslb.com/bfs/emote/39b964d10bde1634f136b662f5b624fcb3bcedb8.png",
				"Cat-congrats": "https://i0.hdslb.com/bfs/emote/98f6e73340d9ed43403242fc842e42508d38bba6.png",
				"最强蜗牛西能-Hi": "https://i0.hdslb.com/bfs/emote/cacd7cd54a1d210cfacd79f5b1f061708c3dba4e.png",
			}
		});
		
		function debounce(fn) {
			var timerID = null
			return function(){
				var arg = arguments[0]   //获取事件
				if(timerID) {
					clearTimeout (timerID)
				}
				timerID = setTimeout( function(){
					fn(arg)              //事件传入函数
				},200)
			}
		}
		//查询评论 valine.Q('*').limit(7) -- 查询所有，限制7条, 下面的的代码是查询当前页面
		let themeDanmu = eval('true');
		let themeLoop = eval('false');
		let themeLooperTime = '5000' || 5000;
		let speed = '20' || 20;
		let isBarrager = true;
		if (themeDanmu == true) {
			do_barrager();
			$('.navbar').append('<div class="danmuBox"><div class="danmuBtn open"><span class="danmuCircle"></span><span class="danmuText">弹幕</span></div></div>');
			$('.danmuBtn').on('click', debounce(
				function () {
					if ($('.danmuBtn').hasClass('open')) {
						$('.danmuBtn').removeClass('open')
						clearInterval(looper);
						$.fn.barrager.removeAll();
					} else {
						$('.danmuBtn').addClass("open");
						do_barrager();
					}
				}
			))
		}
		function do_barrager() {
			isBarrager && valine.Q(window.location.pathname).find().then(function (comments) {
				// let num = 0; // 可以记录条数，循环调用的时候只取最新的评论放入弹幕中
				let run_once = true;
				let looper_time = themeLooperTime;
				let total = comments.length;
				let index = 0;
				if (total > 0) {
					barrager();
				} else {
					// 当评论数为0的时候，自动关闭弹幕
					// $('.danmuBtn').removeClass('open');
				}
				function barrager() {
					if(run_once) {
						//如果是首次执行,则设置一个定时器,并且把首次执行置为false
						looper = setInterval(barrager,looper_time);                
						run_once = false;
					}
					let content = comments[index]._serverData.comment;
					let email = comments[index]._serverData.mail;
					let link = comments[index]._serverData.link;
					let newcontent = content.substring(0, 50).replace(/<[^>]+>/g,"");
					//发布一个弹幕
					const item = {
						img: `https://q1.qlogo.cn/g?b=qq&nk=${email}&s=640`, //图片 
						info: newcontent, //文字 
						href: link, //链接 
						close:true, //显示关闭按钮 
						speed: speed, //延迟,单位秒,默认6 
						color:'#fff', //颜色,默认白色 
						old_ie_color:'#000000', //ie低版兼容色,不能与网页背景相同,默认黑色
					}
					$('body').barrager(item);
					//索引自增
					index++;
					//所有弹幕发布完毕，清除计时器。
					if(index == total) {
						clearInterval(looper);
						if (themeLoop === true) {
							setTimeout(function(){ 
								do_barrager();
							}, 5000);
						} else {
							$('.danmuBtn').removeClass('open');
						}
						return false;
					}

				}
			})
		}
	</script>
</section>
<style>
	#comments {
		background: rgba(255,255,255,0.9);
	}
	#veditor {
		background-image: url('/medias/comment-bg.gif');
		background-size: contain;
		background-repeat: no-repeat;
		background-position: right;
		background-color: rgba(255, 255, 255, 0);
		resize: vertical;
	}
	#veditor:focus{
		background-position-y: 200px;
		transition: all 0.2s ease-in-out 0s;
	}
	#vcomment .vcards .vcard .vh .vhead .vtag.vvisitor {
		background-color: #42b983;
	}
	.v[data-class=v] .vbtn:active, .v[data-class=v] .vbtn:hover {
		color: #42b983;
		border-color: #42b983;
	}
	#vcomment .vcards .vcard .vhead .vsys i {
		display: none;
	}
	/* 底部valine链接 */
	#vcomment .vpower {
		display: none;
	}
	
	/* 底下注释是修改 名称和邮箱和网址输入框的样式 */
	/* #vcomment .vheader {
		display: flex;
		justify-content: space-around;
	}
	
	#vcomment .vheader .vnick {
		width: 31%;
		border: 2px solid #dedede;
		padding-left: 10px;
		padding-right: 10px;
		border-radius: 5px
	}

	#vcomment .vheader .vmail {
		width: 31%;
		border: 2px solid #dedede;
		padding-left: 10px;
		padding-right: 10px;
		border-radius: 5px
	}

	#vcomment .vheader .vlink {
		width: 31%;
		border: 2px solid #dedede;
		padding-left: 10px;
		padding-right: 10px;
		border-radius: 5px
	} */

	img.vimg {
		transition: all 1s;
		/* 头像旋转时间为 1s */
	}

	img.vimg:hover {
		transform: rotate(360deg);
		-webkit-transform: rotate(360deg);
		-moz-transform: rotate(360deg);
		-o-transform: rotate(360deg);
		-ms-transform: rotate(360deg);
	}

	#vcomment .vcards .vcard {
		padding: 15px 20px 0 20px;
		border-radius: 10px;
		margin-bottom: 15px;
		box-shadow: 0 0 4px 1px rgba(0, 0, 0, .12);
		transition: all .3s
	}

	#vcomment .vcards .vcard:hover {
		box-shadow: 0 0 8px 3px rgba(0, 0, 0, .12)
	}

	#vcomment .vcards .vcard .vh .vcard {
		border: none;
		box-shadow: none;
	}
</style>
    
  </div>


  </div>

  <!-- 目录 -->
  <!-- 文章详情页右侧目录 -->

  <div class="toc-aside">
    <div class="toc-main">
      <div class="toc-aside-title">
        <i class="fa fa-list-ul" aria-hidden="true"></i><span>本文目录</span>
        <div class="toc-open-close">本文目录</div>
      </div>
      <div class="toc-content">
        <link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script>
<div class="toc"></div>

<script>
  if ($('.toc').length > 0) {
    var headerEl = 'h1, h2, h3, h4',  //headers 
      content = '.post-detail',//文章容器
      idArr = {};  //标题数组以确定是否增加索引id
      //add #id

    $(content).children(headerEl).each(function () {
      //去除空格以及多余标点
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\：|\，|\。]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //id已经存在
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //id未存在
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    tocbot.init({
      // Where to render the table of contents.
      tocSelector: '.toc',
      // Where to grab the headings to build the table of contents.
      contentSelector: content,
      // Which headings to grab inside of the contentSelector element.
      headingSelector: headerEl,
      scrollSmooth: true,
      scrollSmoothOffset: -80,
      headingsOffset: -($(window).height() * 0.4 - 45),
      positionFixedSelector: '.toc-main',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  }

</script>

<style>
.is-position-fixed {
  position:sticky !important;
  top: 74px;
}
.toc-main ul {
  counter-reset: show-list;
}
.toc-main ul li::before {
  content: counter(item)".";
  display: block;
  position: absolute;
  left: 12px;
  top:0;
}
.toc > .toc-list {
  padding-left: 35px;
}
/* .toc>.toc-list li {
  list-style: decimal;
} */
.toc-list {
  padding-left: 25px;
}
</style>
      </div>
    </div>
  </div>

  

  <script>
    let openOrCloseBtn = $('.toc-aside .toc-aside-title .toc-open-close');
    let open = eval('' || 'true');
    openOrCloseBtn.click(function() {
      if (open === true) {
        $(".toc-aside").css({'width': 0, 'padding': 0});
        $(".toc-content").css({'width': 0});
        $(".toc-aside-title span, .toc-aside-title i").css({'display': 'none'});
        $(".main-content").css({'width': '75%', 'margin': '10px auto'});
        open = false;
      } else {
        $(".toc-aside").css({'width': '300px', 'padding': '0 10px'});
        $(".toc-content").css({'width': '300px'});
        $(".toc-aside-title span, .toc-aside-title i").css({'display': 'inline-block'});
        $(".main-content").css({'width': '65%', 'margin-right': '10px', 'margin-left': 'calc(35% - 350px)'});
        open = true;
      }
    });
  </script>


  <!-- 渲染issues标签里的内容 -->
  <script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) return;
    document.write('<script type="text/javascript" src="/js/issues/index.js"><\/script>');
  };
  loadIssuesJS();
</script>

  <!-- 图片放大 Wrap images with fancybox support -->
  <script src="/js/wrapImage.js"></script>
</div>

<!-- 文章详情页背景图 -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;" :style="{'background-color': bgColor ? bgColor : 'transparent'}">
    <transition-group tag="ul" :name="names">
        <li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
            <img :src="image" class="bg-swiper-img">
        </li>
    </transition-group>
</div>
<script>
    var vm = new Vue({
        el: '#appBgSwiper',
        data: {
            names: '' || 'fade' || 'fade', // translate-fade fade
            mark: 0,
            img: [],
            bgColor: '',
            time: null
        },
        methods: {   //添加方法
            change(i, m) {
                if (i > m) {
                    // this.names = 'fade';
                } else if (i < m) {
                    // this.names = 'fade';
                } else {
                    return;
                }
                this.mark = i;
            },
            prev() {
                // this.names = 'fade';
                this.mark--;
                if (this.mark === -1) {
                    this.mark = 3;
                    return
                }
            },
            next() {
                // this.names = 'fade';
                this.mark++;
                if (this.mark === this.img.length) {
                    this.mark = 0;
                    return
                }
            },
            autoPlay() {
                // this.names = 'fade';
                this.mark++;
                if (this.mark === this.img.length) {
                    this.mark = 0;
                    return
                }
            },
            play() {
                let bgImgDelay = '' || '180000'
                let delay = parseInt(bgImgDelay) || 180000;
                this.time = setInterval(this.autoPlay, delay);
            },
            enter() {
                clearInterval(this.time);
            },
            leave() {
                this.play();
            }
        },
        created() {
            this.play()
        },
        beforeDestroy() {
            clearInterval(this.time);
        },
        mounted() {
            let prop = ''|| '/medias/post_background.png';
            let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://') 
            if (isImg) {
                let img = prop.split(',');
                let configRoot = '/'
                let arrImg = [];
                img.forEach(el => {
                    var Expression=/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
			        var objExp = new RegExp(Expression);

                    if(objExp.test(el)) {
                        // http or https
                        arrImg.push(el);
                    } else {
                        // 非http or https开头
                        // 本地文件
                        let firstStr = el.charAt(0);
                        if (firstStr == '/') {
                            el = el.substr(1); // 删除第一个字符 '/',因为 configRoot最后一个字符为 /
                        }
                        el = configRoot + el;
                        arrImg.push(el);
                    }
                })
                this.img = arrImg;
            } else {
                this.bgColor = prop;
            }
        }
    })
</script>

<style>
    .bg-swiper-box {
        position: absolute;
        display: block;
        width: 100%;
        height: 100%;
    }
    .bg-swiper-img {
        object-fit: cover;
        width: 100%;
        height: 100%;
    }
</style>

    </main>

    <!-- 页脚 -->
    <div class="footer bg-color">
  <div class="footer-main">
    <div class="link">
      
        
          <a href="/atom.xml" class="social">
            
              <i class="fa fa-rss" aria-hidden="true"></i>
            
          </a>
        
      
        
          <a href="mailto:zhaoyang_wu@foxmail.com" class="social">
            
              <i class="fa fa-envelope" aria-hidden="true"></i>
            
          </a>
        
      
        
          <a target="_blank" rel="noopener" href="https://github.com/flyghost/" class="social">
            
              <i class="fa fa-github" aria-hidden="true"></i>
            
          </a>
        
      
        
          <a href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=892821534" class="social">
            
              <i class="fa fa-qq" aria-hidden="true"></i>
            
          </a>
        
      
    </div>
    <div class="footer-copyright">
      <p>Copyright © 2019 - 2020 <a target="_blank" rel="noopener" href="https://github.com/flyghost">creekwater</a> | Powered by <a target="_blank" rel="noopener" href="https://github.com/flyghost">flyghost</a> </p>

    </div>
    <div class="footer-custom">
      
    </div>
    <!-- 不蒜子统计 -->
    
      
  <!-- 不蒜子统计 -->
  <span id="busuanzi_container_site_pv">
        <i class="fa fa-book" aria-hidden="true"></i>本站总阅读量：<span id="busuanzi_value_page_pv"></span> 次
  </span>
  <span id="busuanzi_container_site_pv">
        <i class="fa fa-eye" aria-hidden="true"></i>本站总访问量：<span id="busuanzi_value_site_pv"></span> 次
  </span>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_uv" style='display:none'>
        <i class="fa fa-users" aria-hidden="true"></i>本站访客数：<span id="busuanzi_value_site_uv"></span> 人
  </span>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    
  </div>
</div>


    <!-- 渲染暗黑按钮 -->
    
      <div class="dark">
  <div class="dark-content">
    <i class="fa fa-moon-o" aria-hidden="true"></i>
    <!-- <span>关灯</span> -->
  </div>
  
</div>

<script>
  $(function() {
    let isDark = JSON.parse(localStorage.getItem('dark'))  || JSON.parse('false');
    if (isDark) {
      $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fa fa-lightbulb-o" aria-hidden="true"></i>
          </div>
          `
        );
    }
    $('.dark').click(function() {
      if ($(document.body).is('.darkModel')) {
        $(document.body).removeClass('darkModel');
        localStorage.setItem('dark', false);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fa fa-moon-o" aria-hidden="true"></i>
          </div>
          `
        );
      } else {
        $(document.body).addClass('darkModel');
        localStorage.setItem('dark', true);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fa fa-lightbulb-o" aria-hidden="true"></i>
          </div>
          `
        );
      }
    })
  })
</script>
    
    <!-- 渲染回到顶部按钮 -->
    
      <div class="goTop top-btn-color border-color">
  <i class="fa fa-arrow-up" aria-hidden="true"></i>
</div>
<script src="/js/goTop.js"></script>
    
    <!-- 渲染左下角音乐播放器 -->
    

    <!-- 图片放大 -->
    
      <script src="/js/fancybox/jquery.fancybox.min.js"></script>
    
    
    <!-- 鼠标点击特效 -->
    <!-- 爱心点击 -->

	 
		<script src="/js/cursor/clicklove.js"></script> 
	



    <!-- 百度解析 -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <!-- 背景彩带 -->
    <script type="text/javascript" size="100" alpha='0.4' zIndex="-1" src="/js/ribbon.min.js"></script>
    
    <!-- div滚动到显示区域的动画 -->
    
  <script src="/js/aos/aos.js"></script>
  <script>
    // https://github.com/michalsnik/aos
    const themeOffset = parseInt('120') || 120;
    const themeDelay = parseInt('0') || 0;
    const themeDuration = parseInt('400') || 400;
    const themeEasing = 'ease' || 'ease';
    const themeOnce = eval('true') || false;
    const themeMirror = eval('false') || false;
    const themeAnchorPlacement = 'top-bottom' || 'top-bottom';
    AOS.init({
      // Global settings:
      disable: false, // accepts following values: 'phone', 'tablet', 'mobile', boolean, expression or function
      startEvent: 'DOMContentLoaded', // name of the event dispatched on the document, that AOS should initialize on
      initClassName: 'aos-init', // class applied after initialization
      animatedClassName: 'aos-animate', // class applied on animation
      useClassNames: false, // if true, will add content of `data-aos` as classes on scroll
      disableMutationObserver: false, // disables automatic mutations' detections (advanced)
      debounceDelay: 50, // the delay on debounce used while resizing window (advanced)
      throttleDelay: 99, // the delay on throttle used while scrolling the page (advanced)

      // Settings that can be overridden on per-element basis, by `data-aos-*` attributes:
      offset: themeOffset, // offset (in px) from the original trigger point
      delay: themeDelay, // values from 0 to 3000, with step 50ms
      duration: themeDuration, // values from 0 to 3000, with step 50ms
      easing: themeEasing, // default easing for AOS animations
      once: themeOnce, // whether animation should happen only once - while scrolling down
      mirror: themeMirror, // whether elements should animate out while scrolling past them
      anchorPlacement: themeAnchorPlacement, // defines which position of the element regarding to window should trigger the animation

    });
  </script>

    
    <!-- 复制提示 -->
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.css">
  <script src="https://cdn.jsdelivr.net/npm/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <div id="appCopy">
  </div>
  <script>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        //  监听 ctrl + c事件  
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
            // 返回false, 防止重复触发copy事件  
            return false;
          }
        })

        // 鼠标右键的复制事件  
        $(document).unbind('copy').bind('copy', function (e) {
          doSomething();
          // console.log('右键复制 监听成功');
        });

        function doSomething() {
          that.$notify({
            title: "成功",
            content: "代码已复制，请遵守相关授权协议。",
            type: 'success'
          })
          // console.log('ctrl + c 监听成功');  
        }
      },
      methods: {
      },
      created() { }
    })
  </script>


    <!-- 输入框打字特效 -->
    <!-- 输入框打字特效 -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // 打开随机颜色特效
    POWERMODE.shake = false;    // 关闭输入框抖动
    document.body.addEventListener('input', POWERMODE);//监听打字事件
  </script>


    <!-- markdown代码一键复制功能 -->
    <!-- markdown代码一键复制功能 -->
<script src="/js/clipboard/clipboard.min.js"></script>
<script>
  !function (e, t, a) {
    var copy = '复制';
    /* code */
    var initCopyCode = function () {
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
      copyHtml += '<i class="fa fa-copy"></i><span>' + copy + '</span>';
      copyHtml += '</button>';
      $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
      $(".post-detail pre").not('.gutter pre').before(copyHtml);
      new ClipboardJS('.btn-copy', {
        target: function (trigger) {
          return trigger.nextElementSibling;
        }
      });
    }
    initCopyCode();
  }(window, document);
</script>
    
    <!-- 图片懒加载 -->
    <script src="/js/lazyload/lazyload@1.9.1.js"></script>
<script>
  $(function () {
    $("div.lazyload, img.lazyload, a.lazyload").lazyload(
      {
        effect: "fadeIn",
        placeholder: "/medias/loading.gif"    //图片未加载出来时显示的占位图
      }
    );
  });
</script>
    
    <script src="/js/app.js"></script>

  </body>
</html>